<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>The Ashen Reaches</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=IM+Fell+English:ital@0;1&family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet" />

  <style>
    /* ── Reset & Base ─────────────────────────────────────────── */
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --ash:           #1A1714;
      --ember:         #C45C1A;
      --ironstone:     #8A8478;
      --parchment:     #E8DCC8;
      --bone:          #F0EDE8;
      --ash-mid:       #2A2420;
      --ironstone-dim: #3A3630;
      --leather-dark:  #1E1710;
      --leather-mid:   #2C2018;
      --leather-edge:  #3A2A1C;
      --error:         #a84040;
    }

    html, body {
      height: 100%;
      background: var(--ash);
      color: var(--bone);
      font-family: 'Inter', sans-serif;
      font-size: 15.5px;
      overflow: hidden;
    }

    /* Grain overlay */
    body::before {
      content: '';
      position: fixed; inset: 0;
      background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.85' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)' opacity='1'/%3E%3C/svg%3E");
      opacity: 0.04;
      pointer-events: none;
      z-index: 9999;
    }


    /* ════════════════════════════════════════════════════════════
       SETUP OVERLAY
    ════════════════════════════════════════════════════════════ */
    #setupOverlay {
      position: fixed; inset: 0;
      background: var(--ash);
      z-index: 500;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: opacity 0.6s ease;
    }

    #setupOverlay.hidden {
      opacity: 0;
      pointer-events: none;
    }

    .setup-shell {
      width: 100%;
      max-width: 620px;
      padding: 0 24px;
    }

    /* Progress dots */
    .setup-progress {
      display: flex;
      gap: 8px;
      justify-content: center;
      margin-bottom: 48px;
    }

    .progress-dot {
      width: 6px; height: 6px;
      border-radius: 50%;
      background: var(--ironstone-dim);
      border: 1px solid var(--ironstone-dim);
      transition: background 0.3s, border-color 0.3s;
    }

    .progress-dot.active {
      background: var(--ember);
      border-color: var(--ember);
      box-shadow: 0 0 8px rgba(196,92,26,0.6);
    }

    .progress-dot.done {
      background: var(--ironstone);
      border-color: var(--ironstone);
    }

    /* Individual screen cards */
    .setup-screen {
      display: none;
      animation: fadeIn 0.4s ease;
    }

    .setup-screen.active { display: block; }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to   { opacity: 1; transform: translateY(0); }
    }

    .setup-eyebrow {
      font-size: 0.6rem;
      letter-spacing: 0.45em;
      text-transform: uppercase;
      color: var(--ironstone);
      margin-bottom: 12px;
    }

    .setup-title {
      font-family: 'IM Fell English', serif;
      font-size: 2rem;
      color: var(--parchment);
      line-height: 1.15;
      margin-bottom: 12px;
    }

    .setup-prose {
      font-family: 'IM Fell English', serif;
      font-style: italic;
      font-size: 0.9rem;
      color: var(--ironstone);
      line-height: 1.7;
      margin-bottom: 32px;
    }

    .setup-divider {
      height: 1px;
      background: linear-gradient(to right, transparent, var(--ironstone-dim), transparent);
      margin-bottom: 32px;
    }

    /* Input fields */
    .setup-field { margin-bottom: 24px; }

    .setup-label {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      margin-bottom: 8px;
    }

    .setup-label-text {
      font-size: 0.62rem;
      letter-spacing: 0.35em;
      text-transform: uppercase;
      color: var(--ironstone);
    }

    .setup-char-count {
      font-size: 0.6rem;
      color: var(--ironstone-dim);
      letter-spacing: 0.1em;
    }

    .setup-char-count.warn { color: var(--ember); }

    .setup-input {
      width: 100%;
      background: var(--ash-mid);
      border: 1px solid var(--ironstone-dim);
      border-radius: 2px;
      padding: 12px 14px;
      color: var(--bone);
      font-family: 'IM Fell English', serif;
      font-size: 1rem;
      outline: none;
      transition: border-color 0.2s, box-shadow 0.2s;
    }

    .setup-input::placeholder { color: #4a4540; font-style: italic; }
    .setup-input:focus { border-color: var(--ironstone); box-shadow: 0 0 0 2px rgba(138,132,120,0.15); }
    .setup-input.error { border-color: var(--error); }

    .setup-error {
      font-size: 0.62rem;
      color: var(--error);
      margin-top: 5px;
      letter-spacing: 0.1em;
      display: none;
    }

    .setup-error.visible { display: block; }

    /* Choice buttons */
    .setup-choices { display: grid; gap: 10px; }
    .setup-choices.two-col { grid-template-columns: 1fr 1fr; }

    .choice-btn {
      padding: 16px 20px;
      background: var(--ash-mid);
      border: 1px solid var(--ironstone-dim);
      border-radius: 2px;
      color: var(--bone);
      font-family: 'Inter', sans-serif;
      font-size: 0.75rem;
      letter-spacing: 0.2em;
      text-transform: uppercase;
      cursor: pointer;
      text-align: left;
      transition: border-color 0.2s, background 0.2s;
      position: relative;
    }

    .choice-btn::before {
      content: '';
      position: absolute; top: 0; left: 0; bottom: 0; width: 2px;
      background: var(--ironstone-dim);
      transition: background 0.2s;
    }

    .choice-btn:hover { border-color: var(--ironstone); background: #252018; }

    .choice-btn.selected { border-color: var(--ember); background: rgba(196,92,26,0.08); }
    .choice-btn.selected::before { background: var(--ember); }

    .choice-btn .choice-title { display: block; font-weight: 600; margin-bottom: 4px; }

    .choice-btn .choice-sub {
      font-size: 0.6rem;
      color: var(--ironstone);
      letter-spacing: 0.1em;
      text-transform: none;
      font-weight: 400;
      line-height: 1.5;
    }

    /* Baseline number inputs */
    .baseline-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px; }

    .baseline-field { display: flex; flex-direction: column; gap: 6px; }

    .baseline-label {
      font-size: 0.6rem; letter-spacing: 0.3em;
      text-transform: uppercase; color: var(--ironstone);
    }

    .baseline-sublabel {
      font-size: 0.58rem; color: var(--ironstone-dim);
      font-family: 'IM Fell English', serif; font-style: italic;
    }

    .setup-number {
      width: 100%;
      background: var(--ash-mid);
      border: 1px solid var(--ironstone-dim);
      border-radius: 2px;
      padding: 10px 12px;
      color: var(--bone);
      font-family: 'Inter', sans-serif;
      font-size: 1rem; font-weight: 500;
      outline: none;
      transition: border-color 0.2s;
      -moz-appearance: textfield;
    }

    .setup-number::-webkit-outer-spin-button,
    .setup-number::-webkit-inner-spin-button { -webkit-appearance: none; }
    .setup-number:focus { border-color: var(--ironstone); }

    .baseline-unit { font-size: 0.6rem; color: var(--ironstone); letter-spacing: 0.15em; }

    .setup-skip {
      font-size: 0.62rem; letter-spacing: 0.2em; text-transform: uppercase;
      color: var(--ironstone-dim);
      background: none; border: none; cursor: pointer; padding: 0; margin-top: 12px;
      text-decoration: underline; text-underline-offset: 3px;
      transition: color 0.2s;
    }

    .setup-skip:hover { color: var(--ironstone); }

    /* Nav row */
    .setup-nav {
      display: flex; justify-content: space-between; align-items: center;
      margin-top: 36px;
    }

    .nav-back {
      font-size: 0.62rem; letter-spacing: 0.25em; text-transform: uppercase;
      color: var(--ironstone);
      background: none; border: none; cursor: pointer; padding: 0;
      transition: color 0.2s;
    }

    .nav-back:hover { color: var(--bone); }
    .nav-back:disabled { opacity: 0; pointer-events: none; }

    .nav-forward {
      padding: 12px 28px;
      background: linear-gradient(135deg, var(--leather-edge), var(--leather-dark));
      border: 1px solid var(--ironstone-dim);
      border-radius: 2px;
      color: var(--bone);
      font-family: 'Inter', sans-serif;
      font-size: 0.72rem; letter-spacing: 0.25em; text-transform: uppercase; font-weight: 600;
      cursor: pointer;
      position: relative; overflow: hidden;
      transition: border-color 0.2s, background 0.2s;
    }

    .nav-forward::before {
      content: '';
      position: absolute; top: 0; left: 0; bottom: 0; width: 2px;
      background: var(--ironstone);
      transition: background 0.2s;
    }

    .nav-forward:hover { border-color: rgba(196,92,26,0.6); background: linear-gradient(135deg, #382818, #1e1208); }
    .nav-forward:hover::before { background: var(--ember); }
    .nav-forward.final { border-color: rgba(196,92,26,0.4); color: var(--ember); }


    /* ════════════════════════════════════════════════════════════
       HOME SCREEN
    ════════════════════════════════════════════════════════════ */
    .app {
      display: grid;
      grid-template-rows: auto auto 1fr auto;
      height: 100vh;
      max-width: 1440px;
      margin: 0 auto;
    }

    /* Hero */
    .hero { position: relative; width: 100%; height: 38vh; overflow: hidden; }

    .hero-image {
      width: 100%; height: 100%;
      background:
        linear-gradient(to bottom, var(--ash) 0%, transparent 25%, transparent 60%, var(--ash) 100%),
        linear-gradient(to right,  var(--ash) 0%, transparent 12%, transparent 88%, var(--ash) 100%),
        linear-gradient(165deg, #0e0d0c 0%, #1a1614 20%, #2a2218 35%, #1e1a14 50%, #140f0a 65%, #0a0908 85%, #060504 100%);
      background-size: cover, cover, cover;
      background-position: center;
      transition: background-image 1.2s ease, opacity 1.2s ease;
      position: relative;
    }

    /* When a real image is loaded, it sits under the vignette */
    .hero-image.has-image {
      background:
        linear-gradient(to bottom, var(--ash) 0%, transparent 22%, transparent 55%, var(--ash) 100%),
        linear-gradient(to right,  var(--ash) 0%, transparent 10%, transparent 90%, var(--ash) 100%),
        var(--world-image, none);
      background-size: cover, cover, cover;
      background-position: center, center, center;
    }

    /* Stage-based darkening overlay — controlled by JS via CSS variable */
    .hero-image::after {
      content: '';
      position: absolute; inset: 0;
      background: rgba(0,0,0, var(--stage-darkness, 0));
      transition: background 2s ease;
      pointer-events: none;
    }

    /* Absence-tier overlay — additional darkening on top */
    .hero-image.absence-tier-1::after { --stage-darkness: 0.15; }
    .hero-image.absence-tier-2::after { --stage-darkness: 0.30; }
    .hero-image.absence-tier-3::after { --stage-darkness: 0.50; }

    .hero-scene { position: absolute; inset: 0; overflow: hidden; }

    .hero-scene::before {
      content: '';
      position: absolute; top: 0; left: 0; right: 0; height: 55%;
      background: linear-gradient(180deg, #0c0b0a 0%, #1a1815 40%, #22201b 100%);
    }

    .hero-scene::after {
      content: '';
      position: absolute; bottom: 0; left: 0; right: 0; height: 48%;
      background: linear-gradient(180deg, #1a1714 0%, #141210 100%);
    }

    .dead-tree {
      position: absolute; bottom: 38%; left: 18%;
      width: 3px; height: 120px; background: #0d0c0a;
      transform-origin: bottom center;
    }

    .dead-tree::before, .dead-tree::after { content: ''; position: absolute; background: #0d0c0a; }

    .dead-tree::before {
      top: 28px; left: -18px; width: 2px; height: 55px;
      transform: rotate(-35deg); transform-origin: bottom right;
    }

    .dead-tree::after {
      top: 50px; right: -24px; width: 2px; height: 40px;
      transform: rotate(40deg); transform-origin: bottom left;
    }

    .ember-glow {
      position: absolute; bottom: 42%; right: 26%;
      width: 80px; height: 30px;
      background: radial-gradient(ellipse at center, rgba(196,92,26,0.18) 0%, transparent 70%);
      animation: flicker 4s ease-in-out infinite;
    }

    @keyframes flicker {
      0%, 100% { opacity: 0.6; transform: scaleX(1); }
      50%       { opacity: 1;   transform: scaleX(1.2); }
    }

    .road {
      position: absolute; bottom: 38%; left: 50%; transform: translateX(-50%);
      width: 4px; height: 80px;
      background: linear-gradient(to top, transparent, rgba(50,45,38,0.5));
    }

    .hero-vignette {
      position: absolute; inset: 0;
      background:
        linear-gradient(to bottom, var(--ash) 0%, transparent 22%, transparent 55%, var(--ash) 100%),
        linear-gradient(to right,  var(--ash) 0%, transparent 14%, transparent 86%, var(--ash) 100%);
    }

    .hero-title {
      position: absolute; top: 50%; left: 50%;
      transform: translate(-50%, -50%);
      text-align: center; pointer-events: none; z-index: 2;
    }

    .hero-title h1 {
      font-family: 'IM Fell English', serif;
      font-size: clamp(2rem, 4vw, 3.4rem);
      color: var(--parchment);
      letter-spacing: 0.22em; text-transform: uppercase;
      text-shadow: 0 0 60px rgba(0,0,0,0.9), 0 2px 4px rgba(0,0,0,0.8);
      line-height: 1;
    }

    .hero-title .subtitle {
      font-family: 'Inter', sans-serif;
      font-size: 0.65rem; letter-spacing: 0.35em; text-transform: uppercase;
      color: var(--ironstone); margin-top: 8px;
    }

    /* Flavour band */
    .flavour-band {
      position: relative; padding: 14px 40px; text-align: center;
      background:
        linear-gradient(135deg, #2a2418 25%, transparent 25%) -6px 0,
        linear-gradient(225deg, #2a2418 25%, transparent 25%) -6px 0,
        linear-gradient(315deg, #2a2418 25%, transparent 25%),
        linear-gradient(45deg,  #2a2418 25%, transparent 25%);
      background-size: 12px 12px;
      background-color: #231e17;
      border-top: 1px solid rgba(74,82,64,0.3);
      border-bottom: 1px solid rgba(74,82,64,0.3);
    }

    .flavour-band::before, .flavour-band::after {
      content: ''; position: absolute; top: 0; bottom: 0; width: 80px; pointer-events: none;
    }

    .flavour-band::before { left: 0;  background: linear-gradient(to right, var(--ash), transparent); }
    .flavour-band::after  { right: 0; background: linear-gradient(to left, var(--ash), transparent); }

    .flavour-text {
      font-family: 'IM Fell English', serif;
      font-style: italic; font-size: 1.05rem;
      color: var(--parchment); opacity: 0.85;
    }

    /* Panel row */
    .panel-row {
      display: grid; grid-template-columns: 260px 1fr 220px;
      gap: 2px; padding: 2px 0;
      background: rgba(0,0,0,0.4); min-height: 0;
    }

    .panel { padding: 20px 22px; position: relative; overflow: hidden; }

    .panel-label {
      font-size: 0.62rem; letter-spacing: 0.45em; text-transform: uppercase;
      color: var(--ironstone); margin-bottom: 14px; padding-bottom: 8px;
      border-bottom: 1px solid var(--ironstone-dim);
    }

    .stone {
      background:
        radial-gradient(ellipse at top left, #2a2720 0%, transparent 60%),
        radial-gradient(ellipse at bottom right, #1a1714 0%, transparent 50%),
        #1e1b18;
    }

    .stone::before {
      content: ''; position: absolute; inset: 0;
      background-image:
        repeating-linear-gradient(85deg, transparent 0px, transparent 18px, rgba(255,255,255,0.008) 18px, rgba(255,255,255,0.008) 19px),
        repeating-linear-gradient(5deg,  transparent 0px, transparent 32px, rgba(0,0,0,0.08) 32px, rgba(0,0,0,0.08) 33px);
      pointer-events: none;
    }

    .leather {
      background:
        radial-gradient(ellipse at top, #2e2014 0%, transparent 50%),
        radial-gradient(ellipse at bottom left, #1a1008 0%, transparent 60%),
        var(--leather-mid);
    }

    .leather::before {
      content: ''; position: absolute; inset: 0;
      background-image: repeating-linear-gradient(45deg, transparent, transparent 3px, rgba(0,0,0,0.06) 3px, rgba(0,0,0,0.06) 4px);
      pointer-events: none;
    }

    .leather::after {
      content: ''; position: absolute; top: 0; left: 0; bottom: 0; width: 3px;
      background: linear-gradient(180deg, transparent 0%, rgba(196,92,26,0.12) 30%, rgba(196,92,26,0.08) 70%, transparent 100%);
    }

    /* Left panel */
    .panel-character { display: flex; flex-direction: column; }

    .char-name {
      font-family: 'IM Fell English', serif; font-size: 1.35rem;
      color: var(--parchment); line-height: 1.1; margin-bottom: 4px;
    }

    .char-origin { font-size: 0.7rem; color: var(--ironstone); font-style: italic; margin-bottom: 20px; line-height: 1.5; }

    .char-meta { display: flex; flex-direction: column; gap: 14px; }

    .meta-row { display: flex; justify-content: space-between; align-items: center; }

    .meta-label { font-size: 0.64rem; letter-spacing: 0.3em; text-transform: uppercase; color: var(--ironstone); }

    .meta-value { font-size: 0.95rem; font-weight: 600; color: var(--bone); }
    .meta-value.ember { color: var(--ember); }

    .xp-bar-wrap { display: flex; flex-direction: column; gap: 5px; }

    .xp-bar-track { height: 4px; background: var(--ironstone-dim); border-radius: 2px; overflow: hidden; }

    .xp-bar-fill {
      height: 100%; width: 0%;
      background: linear-gradient(90deg, var(--ember), #d4721f);
      border-radius: 2px; box-shadow: 0 0 6px rgba(196,92,26,0.5);
    }

    .xp-label { font-size: 0.6rem; color: var(--ironstone); letter-spacing: 0.2em; }

    .mana-row { margin-top: 4px; }

    .mana-pips { display: flex; gap: 3px; flex-wrap: wrap; margin-top: 5px; }

    .mana-pip {
      width: 8px; height: 8px; border-radius: 50%;
      background: var(--ironstone-dim); border: 1px solid rgba(74,82,64,0.5);
    }

    .mana-pip.filled {
      background: radial-gradient(circle, #6a8a9a, #4a6878);
      border-color: #5a7888; box-shadow: 0 0 4px rgba(90,120,140,0.4);
    }

    .next-race { margin-top: auto; padding-top: 14px; border-top: 1px solid var(--ironstone-dim); }

    .race-title { font-family: 'IM Fell English', serif; font-size: 0.8rem; color: var(--parchment); margin-bottom: 3px; }

    .race-meta { font-size: 0.6rem; color: var(--ironstone); letter-spacing: 0.15em; }

    .race-days { font-size: 1.4rem; font-weight: 600; color: var(--bone); line-height: 1; margin-top: 4px; }

    .race-days span { font-size: 0.6rem; font-weight: 400; color: var(--ironstone); letter-spacing: 0.2em; text-transform: uppercase; margin-left: 4px; }

    /* Centre panel */
    .panel-stats { border-left: 1px solid rgba(74,82,64,0.15); border-right: 1px solid rgba(74,82,64,0.15); }

    .stats-grid { display: flex; flex-direction: column; gap: 12px; }

    .stat-row { display: grid; grid-template-columns: 110px 1fr 38px; align-items: center; gap: 10px; }

    .stat-name { font-size: 0.66rem; letter-spacing: 0.3em; text-transform: uppercase; color: var(--ironstone); }

    .stat-world-name {
      display: block; font-family: 'IM Fell English', serif;
      font-size: 0.74rem; color: var(--parchment); opacity: 0.55;
      margin-top: 2px; letter-spacing: 0.05em;
    }

    .stat-bar-track { height: 6px; background: var(--ironstone-dim); border-radius: 3px; overflow: hidden; position: relative; }

    .stat-bar-fill { height: 100%; border-radius: 3px; background: linear-gradient(90deg, #3a4a32, #5a6a50); position: relative; transition: width 0.8s ease; }

    .stat-bar-fill::after { content: ''; position: absolute; top: 0; right: 0; width: 2px; height: 100%; background: rgba(255,255,255,0.3); }

    .stat-bar-fill.endurance { background: linear-gradient(90deg, #3a5a3a, #5a8a5a); }
    .stat-bar-fill.iron      { background: linear-gradient(90deg, #4a4a5a, #6a6a8a); }
    .stat-bar-fill.force     { background: linear-gradient(90deg, #5a3a2a, #8a5a3a); }
    .stat-bar-fill.core      { background: linear-gradient(90deg, #4a4a3a, #6a6a5a); }
    .stat-bar-fill.resolve   { background: linear-gradient(90deg, #3a2a4a, #6a4a8a); box-shadow: 0 0 8px rgba(106,74,138,0.4); }
    .stat-bar-fill.lore      { background: linear-gradient(90deg, #2a3a4a, #4a6a8a); }

    .stat-value { font-size: 0.85rem; font-weight: 500; color: var(--bone); text-align: right; }

    .readiness-wrap { margin-top: 16px; padding-top: 14px; border-top: 1px solid var(--ironstone-dim); }

    .readiness-inner { display: flex; justify-content: space-between; align-items: center; }

    .readiness-label { font-size: 0.6rem; letter-spacing: 0.35em; text-transform: uppercase; color: var(--ironstone); }

    .readiness-score { font-size: 1.6rem; font-weight: 600; color: var(--ember); text-shadow: 0 0 20px rgba(196,92,26,0.35); line-height: 1; }

    .readiness-sub { font-size: 0.6rem; color: var(--ironstone); text-align: right; margin-top: 2px; }

    .readiness-bar-track { margin-top: 8px; height: 3px; background: var(--ironstone-dim); border-radius: 2px; overflow: hidden; }

    .readiness-bar-fill { height: 100%; width: 0%; background: linear-gradient(90deg, var(--ember), #d4721f); box-shadow: 0 0 8px rgba(196,92,26,0.5); border-radius: 2px; }

    /* Right panel */
    .panel-actions { display: flex; flex-direction: column; gap: 10px; justify-content: center; }

    .action-btn {
      display: block; width: 100%; padding: 14px 16px;
      background: linear-gradient(135deg, var(--leather-edge) 0%, var(--leather-dark) 100%);
      border: 1px solid rgba(74,82,64,0.35); border-radius: 2px;
      color: var(--bone); font-family: 'Inter', sans-serif;
      font-size: 0.75rem; letter-spacing: 0.25em; text-transform: uppercase;
      cursor: pointer; text-align: left; position: relative; overflow: hidden;
      transition: border-color 0.2s, background 0.2s;
    }

    .action-btn::before {
      content: ''; position: absolute; top: 0; left: 0; bottom: 0; width: 2px;
      background: var(--ironstone); transition: background 0.2s, width 0.2s;
    }

    .action-btn:hover { border-color: rgba(196,92,26,0.5); background: linear-gradient(135deg, #382818 0%, #1e1208 100%); }
    .action-btn:hover::before { background: var(--ember); width: 3px; }

    .action-btn .btn-title { display: block; font-weight: 600; margin-bottom: 3px; }
    .action-btn .btn-sub { font-size: 0.58rem; color: var(--ironstone); letter-spacing: 0.15em; }
    .action-btn.primary .btn-title { color: var(--ember); }
    .panel-actions .panel-label { border-bottom-color: rgba(196,92,26,0.2); }

    /* Phase badge */
    .phase-badge {
      display: inline-flex; align-items: center; gap: 6px;
      background: rgba(196,92,26,0.1); border: 1px solid rgba(196,92,26,0.25);
      border-radius: 2px; padding: 3px 8px;
      font-size: 0.58rem; letter-spacing: 0.2em; text-transform: uppercase;
      color: var(--ember); margin-bottom: 14px;
    }

    .phase-dot {
      width: 5px; height: 5px; border-radius: 50%;
      background: var(--ember); box-shadow: 0 0 6px rgba(196,92,26,0.8);
      animation: pulse 2s ease-in-out infinite;
    }

    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.4; } }

    .corner-mark { position: absolute; width: 10px; height: 10px; }
    .corner-mark.tl { top: 8px; left: 8px;   border-top: 1px solid var(--ironstone); border-left: 1px solid var(--ironstone); }
    .corner-mark.br { bottom: 8px; right: 8px; border-bottom: 1px solid var(--ironstone); border-right: 1px solid var(--ironstone); }

    /* Streak band */
    .streak-band {
      display: grid; grid-template-columns: 1fr 1fr 1fr;
      background: #131110; border-top: 1px solid var(--ironstone-dim);
    }

    .streak-item { display: flex; justify-content: space-between; align-items: center; padding: 10px 24px; }

    .streak-item + .streak-item { border-left: 1px solid var(--ironstone-dim); }

    .streak-label { font-size: 0.62rem; letter-spacing: 0.4em; text-transform: uppercase; color: var(--ironstone); }

    .streak-number { font-size: 1.1rem; font-weight: 600; color: var(--bone); line-height: 1; }
    .streak-number span { font-size: 0.6rem; font-weight: 400; color: var(--ironstone); margin-left: 2px; }

    /* ════════════════════════════════════════════════════════════
       LOGGING SCREEN OVERLAY
    ════════════════════════════════════════════════════════════ */
    #logOverlay {
      position: fixed; inset: 0;
      background: var(--ash);
      z-index: 400;
      display: none;
      flex-direction: column;
      overflow: hidden;
    }

    #logOverlay.visible { display: flex; }

    .log-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 14px 28px;
      background: #131110;
      border-bottom: 1px solid var(--ironstone-dim);
      flex-shrink: 0;
    }

    .log-header-left { display: flex; flex-direction: column; gap: 3px; }

    .log-header-title {
      font-family: 'IM Fell English', serif;
      font-size: 1.25rem;
      color: var(--parchment);
      line-height: 1;
    }

    .log-header-date {
      font-size: 0.6rem;
      letter-spacing: 0.3em;
      text-transform: uppercase;
      color: var(--ironstone);
    }

    .log-session-type {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .log-session-label {
      font-size: 0.6rem;
      letter-spacing: 0.3em;
      text-transform: uppercase;
      color: var(--ironstone);
    }

    .log-session-select {
      background: var(--ash-mid);
      border: 1px solid var(--ironstone-dim);
      border-radius: 2px;
      color: var(--bone);
      font-family: 'Inter', sans-serif;
      font-size: 0.72rem;
      letter-spacing: 0.15em;
      padding: 6px 10px;
      outline: none;
      cursor: pointer;
    }

    .log-session-select:focus { border-color: var(--ironstone); }

    .log-close-btn {
      background: none;
      border: 1px solid var(--ironstone-dim);
      border-radius: 2px;
      color: var(--ironstone);
      font-family: 'Inter', sans-serif;
      font-size: 0.6rem;
      letter-spacing: 0.3em;
      text-transform: uppercase;
      padding: 7px 14px;
      cursor: pointer;
      transition: border-color 0.2s, color 0.2s;
    }

    .log-close-btn:hover { border-color: var(--ironstone); color: var(--bone); }

    .log-body {
      flex: 1;
      overflow-y: auto;
      padding: 20px 28px 0;
      scrollbar-width: thin;
      scrollbar-color: var(--ironstone-dim) transparent;
    }

    .log-body::-webkit-scrollbar { width: 4px; }
    .log-body::-webkit-scrollbar-track { background: transparent; }
    .log-body::-webkit-scrollbar-thumb { background: var(--ironstone-dim); border-radius: 2px; }

    .log-section {
      border: 1px solid var(--ironstone-dim);
      border-radius: 2px;
      margin-bottom: 8px;
      overflow: hidden;
    }

    .log-section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 16px;
      cursor: pointer;
      background: #1e1b18;
      transition: background 0.15s;
      user-select: none;
    }

    .log-section-header:hover { background: #252118; }
    .log-section-header.open { background: #252118; border-bottom: 1px solid var(--ironstone-dim); }

    .log-section-title-group { display: flex; align-items: center; gap: 12px; }

    .log-section-name {
      font-size: 0.68rem;
      letter-spacing: 0.3em;
      text-transform: uppercase;
      color: var(--bone);
      font-weight: 600;
    }

    .log-section-world {
      font-family: 'IM Fell English', serif;
      font-style: italic;
      font-size: 0.78rem;
      color: var(--ironstone);
    }

    .log-section-stat { display: flex; align-items: center; gap: 8px; }

    .log-stat-chip {
      font-size: 0.6rem;
      letter-spacing: 0.15em;
      color: var(--ironstone);
      padding: 2px 7px;
      border: 1px solid var(--ironstone-dim);
      border-radius: 10px;
    }

    .log-chevron {
      font-size: 0.6rem;
      color: var(--ironstone);
      transition: transform 0.2s;
    }

    .log-section-header.open .log-chevron { transform: rotate(180deg); }

    .log-section-body {
      display: none;
      padding: 16px;
      background: #1a1714;
    }

    .log-section-body.open { display: block; }

    .log-activity { margin-bottom: 18px; }
    .log-activity:last-child { margin-bottom: 0; }

    .log-activity-title {
      font-size: 0.6rem;
      letter-spacing: 0.3em;
      text-transform: uppercase;
      color: var(--ironstone);
      margin-bottom: 10px;
      padding-bottom: 6px;
      border-bottom: 1px solid var(--ironstone-dim);
    }

    .log-field-row {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 8px;
      flex-wrap: wrap;
    }

    .log-field-group {
      display: flex;
      flex-direction: column;
      gap: 4px;
      flex: 1;
      min-width: 80px;
    }

    .log-field-label {
      font-size: 0.58rem;
      letter-spacing: 0.2em;
      text-transform: uppercase;
      color: var(--ironstone);
    }

    .log-input {
      width: 100%;
      background: var(--ash-mid);
      border: 1px solid var(--ironstone-dim);
      border-radius: 2px;
      padding: 8px 10px;
      color: var(--bone);
      font-family: 'Inter', sans-serif;
      font-size: 0.9rem;
      font-weight: 500;
      outline: none;
      transition: border-color 0.2s;
      -moz-appearance: textfield;
    }

    .log-input::-webkit-outer-spin-button,
    .log-input::-webkit-inner-spin-button { -webkit-appearance: none; }
    .log-input:focus { border-color: var(--ironstone); }

    .log-input-unit {
      font-size: 0.6rem;
      color: var(--ironstone);
      letter-spacing: 0.15em;
      white-space: nowrap;
      align-self: flex-end;
      padding-bottom: 9px;
    }

    .log-select {
      background: var(--ash-mid);
      border: 1px solid var(--ironstone-dim);
      border-radius: 2px;
      color: var(--bone);
      font-family: 'Inter', sans-serif;
      font-size: 0.82rem;
      padding: 8px 10px;
      outline: none;
      flex: 1;
    }

    .log-select:focus { border-color: var(--ironstone); }

    .log-target {
      font-size: 0.6rem;
      color: var(--ironstone);
      letter-spacing: 0.15em;
      margin-top: 3px;
    }

    .log-target.hit { color: var(--ember); }

    .set-rows { display: flex; flex-direction: column; gap: 6px; margin-bottom: 8px; }

    .set-row { display: flex; align-items: center; gap: 8px; }

    .set-label {
      font-size: 0.6rem;
      letter-spacing: 0.2em;
      color: var(--ironstone);
      width: 44px;
      flex-shrink: 0;
    }

    .set-input {
      width: 80px;
      background: var(--ash-mid);
      border: 1px solid var(--ironstone-dim);
      border-radius: 2px;
      padding: 7px 10px;
      color: var(--bone);
      font-family: 'Inter', sans-serif;
      font-size: 0.9rem;
      font-weight: 500;
      outline: none;
      transition: border-color 0.2s;
      -moz-appearance: textfield;
    }

    .set-input::-webkit-outer-spin-button,
    .set-input::-webkit-inner-spin-button { -webkit-appearance: none; }
    .set-input:focus { border-color: var(--ironstone); }

    .set-unit { font-size: 0.6rem; color: var(--ironstone); letter-spacing: 0.1em; }

    .set-remove {
      background: none; border: none;
      color: var(--ironstone-dim); font-size: 0.75rem;
      cursor: pointer; padding: 4px; line-height: 1;
      transition: color 0.2s;
    }

    .set-remove:hover { color: var(--error); }

    .add-set-btn {
      background: none;
      border: 1px dashed var(--ironstone-dim);
      border-radius: 2px;
      color: var(--ironstone);
      font-family: 'Inter', sans-serif;
      font-size: 0.6rem;
      letter-spacing: 0.25em;
      text-transform: uppercase;
      padding: 6px 12px;
      cursor: pointer;
      transition: border-color 0.2s, color 0.2s;
      width: 100%;
      text-align: center;
    }

    .add-set-btn:hover { border-color: var(--ironstone); color: var(--bone); }

    .log-checkbox-row {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 8px;
    }

    .log-checkbox {
      width: 16px; height: 16px;
      background: var(--ash-mid);
      border: 1px solid var(--ironstone-dim);
      border-radius: 2px;
      appearance: none;
      -webkit-appearance: none;
      cursor: pointer;
      flex-shrink: 0;
      position: relative;
      transition: background 0.15s, border-color 0.15s;
    }

    .log-checkbox:checked {
      background: var(--ember);
      border-color: var(--ember);
    }

    .log-checkbox:checked::after {
      content: '✓';
      position: absolute; top: -1px; left: 2px;
      font-size: 0.7rem; color: #fff; font-weight: 700;
    }

    .log-checkbox-label {
      font-size: 0.72rem;
      color: var(--bone);
      cursor: pointer;
      letter-spacing: 0.05em;
    }

    .spartan-confirm {
      display: flex;
      align-items: flex-start;
      gap: 10px;
      padding: 10px 12px;
      background: rgba(196,92,26,0.05);
      border: 1px solid rgba(196,92,26,0.2);
      border-radius: 2px;
      margin-top: 8px;
    }

    .spartan-confirm .log-checkbox-label {
      font-size: 0.65rem;
      color: var(--ironstone);
      line-height: 1.5;
    }

    .log-footer {
      padding: 16px 28px;
      background: #131110;
      border-top: 1px solid var(--ironstone-dim);
      display: flex;
      justify-content: flex-end;
      flex-shrink: 0;
    }

    .commit-btn {
      padding: 13px 36px;
      background: linear-gradient(135deg, var(--leather-edge), var(--leather-dark));
      border: 1px solid rgba(196,92,26,0.4);
      border-radius: 2px;
      color: var(--ember);
      font-family: 'Inter', sans-serif;
      font-size: 0.75rem;
      letter-spacing: 0.35em;
      text-transform: uppercase;
      font-weight: 700;
      cursor: pointer;
      position: relative;
      overflow: hidden;
      transition: background 0.2s, border-color 0.2s, box-shadow 0.2s;
    }

    .commit-btn::before {
      content: '';
      position: absolute; top: 0; left: 0; bottom: 0; width: 2px;
      background: var(--ember);
    }

    .commit-btn:hover {
      background: linear-gradient(135deg, #382818, #1e1208);
      border-color: rgba(196,92,26,0.7);
      box-shadow: 0 0 20px rgba(196,92,26,0.2);
    }

    /* ════════════════════════════════════════════════════════════
       STAT SUMMARY SCREEN
    ════════════════════════════════════════════════════════════ */
    #summaryOverlay {
      position: fixed; inset: 0;
      background: var(--ash);
      z-index: 450;
      display: none;
      align-items: center;
      justify-content: center;
    }

    #summaryOverlay.visible { display: flex; }

    .summary-shell {
      width: 100%;
      max-width: 560px;
      padding: 0 24px;
    }

    .summary-heading {
      font-family: 'IM Fell English', serif;
      font-size: 1.8rem;
      color: var(--parchment);
      margin-bottom: 6px;
      text-align: center;
    }

    .summary-date {
      text-align: center;
      font-size: 0.6rem;
      letter-spacing: 0.35em;
      text-transform: uppercase;
      color: var(--ironstone);
      margin-bottom: 32px;
    }

    .summary-divider {
      height: 1px;
      background: linear-gradient(to right, transparent, var(--ironstone-dim), transparent);
      margin-bottom: 28px;
    }

    .summary-stats { display: flex; flex-direction: column; gap: 10px; margin-bottom: 28px; }

    .summary-stat-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 14px;
      background: #1e1b18;
      border: 1px solid var(--ironstone-dim);
      border-radius: 2px;
    }

    .summary-stat-name {
      font-size: 0.62rem;
      letter-spacing: 0.3em;
      text-transform: uppercase;
      color: var(--ironstone);
    }

    .summary-stat-change { display: flex; align-items: center; gap: 14px; }

    .summary-old { font-size: 0.85rem; color: var(--ironstone); }
    .summary-arrow { font-size: 0.7rem; color: var(--ironstone-dim); }
    .summary-new { font-size: 1rem; font-weight: 600; color: var(--bone); }

    .summary-delta {
      font-size: 0.8rem;
      font-weight: 600;
      color: var(--ember);
      min-width: 40px;
      text-align: right;
    }

    .summary-flavour {
      font-family: 'IM Fell English', serif;
      font-style: italic;
      font-size: 0.95rem;
      color: var(--ironstone);
      text-align: center;
      line-height: 1.7;
      margin-bottom: 32px;
      padding: 0 16px;
    }

    .summary-return-btn {
      display: block;
      width: 100%;
      padding: 14px;
      background: linear-gradient(135deg, var(--leather-edge), var(--leather-dark));
      border: 1px solid var(--ironstone-dim);
      border-radius: 2px;
      color: var(--bone);
      font-family: 'Inter', sans-serif;
      font-size: 0.7rem;
      letter-spacing: 0.3em;
      text-transform: uppercase;
      font-weight: 600;
      cursor: pointer;
      text-align: center;
      transition: border-color 0.2s, background 0.2s;
    }

    .summary-return-btn:hover {
      border-color: rgba(196,92,26,0.5);
      background: linear-gradient(135deg, #382818, #1e1208);
    }


    /* ════════════════════════════════════════════════════════════
       ABSENCE / FAILURE STATE OVERLAY  (Phase 4)
    ════════════════════════════════════════════════════════════ */
    #absenceOverlay {
      position: fixed; inset: 0;
      background: var(--ash);
      z-index: 550;
      display: none;
      align-items: center;
      justify-content: center;
      animation: fadeIn 0.5s ease;
    }

    #absenceOverlay.visible { display: flex; }

    .absence-shell {
      width: 100%;
      max-width: 580px;
      padding: 0 28px;
      text-align: center;
    }

    /* Tier indicator pip row */
    .absence-tier-row {
      display: flex;
      justify-content: center;
      gap: 6px;
      margin-bottom: 32px;
    }

    .absence-tier-pip {
      width: 6px; height: 6px;
      border-radius: 50%;
      background: var(--ironstone-dim);
      border: 1px solid var(--ironstone-dim);
    }

    .absence-tier-pip.lit {
      background: var(--ember);
      border-color: var(--ember);
      box-shadow: 0 0 8px rgba(196,92,26,0.5);
    }

    /* Eyebrow label — shows which tier this is */
    .absence-eyebrow {
      font-size: 0.58rem;
      letter-spacing: 0.5em;
      text-transform: uppercase;
      color: var(--ironstone);
      margin-bottom: 20px;
    }

    /* Main narrative passage — parchment, IM Fell, italic */
    .absence-passage {
      font-family: 'IM Fell English', serif;
      font-style: italic;
      font-size: 1.05rem;
      color: var(--parchment);
      line-height: 1.85;
      margin-bottom: 40px;
      padding: 28px 32px;
      background:
        linear-gradient(135deg, #2a2418 25%, transparent 25%) -6px 0,
        linear-gradient(225deg, #2a2418 25%, transparent 25%) -6px 0,
        linear-gradient(315deg, #2a2418 25%, transparent 25%),
        linear-gradient(45deg,  #2a2418 25%, transparent 25%);
      background-size: 12px 12px;
      background-color: #231e17;
      border-top: 1px solid rgba(74,82,64,0.3);
      border-bottom: 1px solid rgba(74,82,64,0.3);
      position: relative;
    }

    /* Left quote-mark decoration */
    .absence-passage::before {
      content: '"';
      position: absolute;
      top: 10px; left: 14px;
      font-family: 'IM Fell English', serif;
      font-size: 2.5rem;
      color: var(--ironstone-dim);
      line-height: 1;
      pointer-events: none;
    }

    /* Days-missed callout */
    .absence-days-callout {
      font-size: 0.6rem;
      letter-spacing: 0.35em;
      text-transform: uppercase;
      color: var(--ironstone);
      margin-bottom: 28px;
    }

    .absence-days-callout strong {
      font-size: 1.4rem;
      font-weight: 600;
      color: var(--bone);
      display: block;
      margin-bottom: 4px;
      letter-spacing: 0.05em;
    }

    /* Stat freeze notice (Tier 2+) */
    .absence-freeze-notice {
      font-size: 0.65rem;
      letter-spacing: 0.15em;
      color: var(--ironstone);
      margin-bottom: 28px;
      padding: 8px 16px;
      border: 1px solid var(--ironstone-dim);
      border-radius: 2px;
      display: inline-block;
    }

    /* Mana drain notice (Tier 3) */
    .absence-mana-notice {
      font-size: 0.65rem;
      letter-spacing: 0.15em;
      color: var(--ember);
      margin-bottom: 28px;
      padding: 8px 16px;
      border: 1px solid rgba(196,92,26,0.3);
      border-radius: 2px;
      display: inline-block;
      background: rgba(196,92,26,0.06);
    }

    /* Race warning (when a race is within 30 days) */
    .absence-race-warning {
      font-family: 'IM Fell English', serif;
      font-style: italic;
      font-size: 0.82rem;
      color: var(--ironstone);
      margin-bottom: 28px;
      line-height: 1.6;
    }

    .absence-race-warning strong {
      color: var(--ember);
      font-style: normal;
    }

    /* Acknowledge button */
    .absence-ack-btn {
      padding: 13px 40px;
      background: linear-gradient(135deg, var(--leather-edge), var(--leather-dark));
      border: 1px solid var(--ironstone-dim);
      border-radius: 2px;
      color: var(--bone);
      font-family: 'Inter', sans-serif;
      font-size: 0.7rem;
      letter-spacing: 0.3em;
      text-transform: uppercase;
      font-weight: 600;
      cursor: pointer;
      position: relative;
      overflow: hidden;
      transition: border-color 0.2s, background 0.2s;
    }

    .absence-ack-btn::before {
      content: '';
      position: absolute; top: 0; left: 0; bottom: 0; width: 2px;
      background: var(--ironstone);
      transition: background 0.2s;
    }

    .absence-ack-btn:hover {
      border-color: rgba(196,92,26,0.5);
      background: linear-gradient(135deg, #382818, #1e1208);
    }

    .absence-ack-btn:hover::before { background: var(--ember); }


    /* ════════════════════════════════════════════════════════════
       STREAK MILESTONE OVERLAY  (Phase 4)
    ════════════════════════════════════════════════════════════ */
    #milestoneOverlay {
      position: fixed; inset: 0;
      background: rgba(26,23,20,0.92);
      z-index: 560;
      display: none;
      align-items: center;
      justify-content: center;
      animation: fadeIn 0.4s ease;
    }

    #milestoneOverlay.visible { display: flex; }

    .milestone-shell {
      width: 100%;
      max-width: 480px;
      padding: 0 28px;
      text-align: center;
    }

    .milestone-icon {
      font-size: 2rem;
      margin-bottom: 16px;
      opacity: 0.7;
    }

    .milestone-title {
      font-family: 'IM Fell English', serif;
      font-size: 1.5rem;
      color: var(--parchment);
      margin-bottom: 10px;
      line-height: 1.2;
    }

    .milestone-passage {
      font-family: 'IM Fell English', serif;
      font-style: italic;
      font-size: 0.9rem;
      color: var(--ironstone);
      line-height: 1.75;
      margin-bottom: 32px;
    }

    .milestone-streak-display {
      font-size: 3rem;
      font-weight: 600;
      color: var(--ember);
      text-shadow: 0 0 30px rgba(196,92,26,0.4);
      line-height: 1;
      margin-bottom: 6px;
    }

    .milestone-streak-label {
      font-size: 0.6rem;
      letter-spacing: 0.4em;
      text-transform: uppercase;
      color: var(--ironstone);
      margin-bottom: 32px;
    }

    .milestone-dismiss-btn {
      padding: 11px 32px;
      background: none;
      border: 1px solid var(--ironstone-dim);
      border-radius: 2px;
      color: var(--ironstone);
      font-family: 'Inter', sans-serif;
      font-size: 0.65rem;
      letter-spacing: 0.3em;
      text-transform: uppercase;
      cursor: pointer;
      transition: border-color 0.2s, color 0.2s;
    }

    .milestone-dismiss-btn:hover { border-color: var(--ironstone); color: var(--bone); }


    /* ════════════════════════════════════════════════════════════
       PHASE 5 — COMBAT SYSTEM
    ════════════════════════════════════════════════════════════ */

    /* ── Venture Out — encounter preview overlay ──────────── */
    #encounterOverlay {
      position: fixed; inset: 0;
      background: var(--ash);
      z-index: 420;
      display: none;
      align-items: center;
      justify-content: center;
      animation: fadeIn 0.5s ease;
    }

    #encounterOverlay.visible { display: flex; }

    .encounter-shell {
      width: 100%;
      max-width: 600px;
      padding: 0 28px;
    }

    .encounter-eyebrow {
      font-size: 0.58rem;
      letter-spacing: 0.5em;
      text-transform: uppercase;
      color: var(--ironstone);
      margin-bottom: 14px;
      text-align: center;
    }

    .encounter-scene {
      font-family: 'IM Fell English', serif;
      font-style: italic;
      font-size: 0.92rem;
      color: var(--ironstone);
      line-height: 1.8;
      margin-bottom: 28px;
      padding: 20px 24px;
      border-top: 1px solid var(--ironstone-dim);
      border-bottom: 1px solid var(--ironstone-dim);
      text-align: center;
    }

    /* Monster card in encounter preview */
    .encounter-monster-card {
      display: flex;
      gap: 20px;
      align-items: flex-start;
      padding: 20px;
      background: #1e1b18;
      border: 1px solid var(--ironstone-dim);
      border-radius: 2px;
      margin-bottom: 24px;
      position: relative;
    }

    .encounter-monster-portrait {
      width: 72px;
      height: 72px;
      background: var(--ironstone-dim);
      border-radius: 2px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 2rem;
      flex-shrink: 0;
      border: 1px solid rgba(74,82,64,0.3);
    }

    .encounter-monster-info { flex: 1; }

    .encounter-monster-tier {
      font-size: 0.55rem;
      letter-spacing: 0.4em;
      text-transform: uppercase;
      color: var(--ironstone);
      margin-bottom: 4px;
    }

    .encounter-monster-name {
      font-family: 'IM Fell English', serif;
      font-size: 1.35rem;
      color: var(--parchment);
      line-height: 1.1;
      margin-bottom: 8px;
    }

    .encounter-monster-desc {
      font-size: 0.72rem;
      color: var(--ironstone);
      line-height: 1.6;
    }

    .encounter-monster-stats {
      display: flex;
      gap: 16px;
      margin-top: 10px;
    }

    .encounter-stat-item {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .encounter-stat-label {
      font-size: 0.55rem;
      letter-spacing: 0.25em;
      text-transform: uppercase;
      color: var(--ironstone-dim);
    }

    .encounter-stat-value {
      font-size: 0.8rem;
      font-weight: 600;
      color: var(--bone);
    }

    /* Engage / Withdraw buttons */
    .encounter-actions {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }

    .encounter-btn {
      padding: 14px;
      border-radius: 2px;
      font-family: 'Inter', sans-serif;
      font-size: 0.7rem;
      letter-spacing: 0.3em;
      text-transform: uppercase;
      font-weight: 600;
      cursor: pointer;
      position: relative;
      overflow: hidden;
      transition: background 0.2s, border-color 0.2s;
    }

    .encounter-btn.engage {
      background: linear-gradient(135deg, var(--leather-edge), var(--leather-dark));
      border: 1px solid rgba(196,92,26,0.4);
      color: var(--ember);
    }

    .encounter-btn.engage::before {
      content: ''; position: absolute; top: 0; left: 0; bottom: 0; width: 2px;
      background: var(--ember);
    }

    .encounter-btn.engage:hover {
      background: linear-gradient(135deg, #382818, #1e1208);
      border-color: rgba(196,92,26,0.7);
    }

    .encounter-btn.withdraw {
      background: none;
      border: 1px solid var(--ironstone-dim);
      color: var(--ironstone);
    }

    .encounter-btn.withdraw:hover {
      border-color: var(--ironstone);
      color: var(--bone);
    }


    /* ── Active combat screen ─────────────────────────────── */
    #combatOverlay {
      position: fixed; inset: 0;
      background: var(--ash);
      z-index: 430;
      display: none;
      flex-direction: column;
      overflow: hidden;
    }

    #combatOverlay.visible { display: flex; }

    /* Combat arena — top section */
    .combat-arena {
      flex: 1;
      display: grid;
      grid-template-columns: 1fr 1fr;
      grid-template-rows: 1fr auto;
      gap: 0;
      min-height: 0;
      padding: 20px 28px 0;
    }

    /* Player side */
    .combat-side {
      display: flex;
      flex-direction: column;
      padding: 16px 20px;
      position: relative;
    }

    .combat-side.player {
      border-right: 1px solid var(--ironstone-dim);
    }

    .combat-side-label {
      font-size: 0.58rem;
      letter-spacing: 0.4em;
      text-transform: uppercase;
      color: var(--ironstone);
      margin-bottom: 8px;
    }

    .combat-name {
      font-family: 'IM Fell English', serif;
      font-size: 1.2rem;
      color: var(--parchment);
      margin-bottom: 14px;
      line-height: 1;
    }

    /* HP bar */
    .combat-hp-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 5px;
    }

    .combat-hp-label {
      font-size: 0.58rem;
      letter-spacing: 0.25em;
      text-transform: uppercase;
      color: var(--ironstone);
    }

    .combat-hp-numbers {
      font-size: 0.85rem;
      font-weight: 600;
      color: var(--bone);
    }

    .combat-hp-track {
      height: 8px;
      background: var(--ironstone-dim);
      border-radius: 4px;
      overflow: hidden;
      margin-bottom: 12px;
    }

    .combat-hp-fill {
      height: 100%;
      background: linear-gradient(90deg, #3a5a3a, #6a9a6a);
      border-radius: 4px;
      transition: width 0.5s ease;
    }

    .combat-hp-fill.danger {
      background: linear-gradient(90deg, #5a2a2a, #8a4a4a);
    }

    .combat-hp-fill.enemy {
      background: linear-gradient(90deg, #5a3a1a, #8a5a2a);
    }

    /* Mana pips in combat */
    .combat-mana-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 5px;
    }

    .combat-mana-label {
      font-size: 0.58rem;
      letter-spacing: 0.25em;
      text-transform: uppercase;
      color: var(--ironstone);
    }

    .combat-mana-pips {
      display: flex;
      gap: 2px;
      flex-wrap: wrap;
      max-width: 200px;
    }

    .combat-mana-pip {
      width: 7px; height: 7px;
      border-radius: 50%;
      background: var(--ironstone-dim);
      border: 1px solid rgba(74,82,64,0.4);
    }

    .combat-mana-pip.filled {
      background: radial-gradient(circle, #6a8a9a, #4a6878);
      border-color: #5a7888;
    }

    /* Monster portrait in combat */
    .combat-monster-portrait {
      font-size: 4rem;
      text-align: center;
      margin-bottom: 10px;
      opacity: 0.85;
    }

    .combat-monster-portrait.struck {
      animation: struck 0.3s ease;
    }

    @keyframes struck {
      0%   { transform: translateX(0) scale(1); opacity: 0.85; }
      30%  { transform: translateX(-8px) scale(0.95); opacity: 0.5; }
      100% { transform: translateX(0) scale(1); opacity: 0.85; }
    }

    .combat-player-portrait {
      font-size: 3rem;
      text-align: center;
      margin-bottom: 10px;
      opacity: 0.75;
    }

    .combat-player-portrait.struck {
      animation: playerStruck 0.3s ease;
    }

    @keyframes playerStruck {
      0%   { transform: translateX(0); }
      30%  { transform: translateX(8px); opacity: 0.4; }
      100% { transform: translateX(0); opacity: 0.75; }
    }

    /* Narrative log — spans full width */
    .combat-log {
      grid-column: 1 / -1;
      padding: 12px 20px;
      min-height: 72px;
      max-height: 80px;
      overflow-y: auto;
      border-top: 1px solid var(--ironstone-dim);
      background: #131110;
      scrollbar-width: thin;
      scrollbar-color: var(--ironstone-dim) transparent;
    }

    .combat-log-line {
      font-family: 'IM Fell English', serif;
      font-size: 0.85rem;
      color: var(--parchment);
      line-height: 1.6;
      margin-bottom: 2px;
    }

    .combat-log-line.player-action { color: var(--bone); }
    .combat-log-line.monster-action { color: var(--ironstone); }
    .combat-log-line.system-note { font-size: 0.72rem; color: var(--ironstone-dim); font-style: italic; }

    /* Combat action buttons */
    .combat-footer {
      padding: 14px 28px;
      background: #131110;
      border-top: 1px solid var(--ironstone-dim);
      display: flex;
      gap: 10px;
      flex-shrink: 0;
    }

    .combat-action-btn {
      flex: 1;
      padding: 12px 8px;
      background: linear-gradient(135deg, var(--leather-edge), var(--leather-dark));
      border: 1px solid var(--ironstone-dim);
      border-radius: 2px;
      color: var(--bone);
      font-family: 'Inter', sans-serif;
      font-size: 0.65rem;
      letter-spacing: 0.2em;
      text-transform: uppercase;
      font-weight: 600;
      cursor: pointer;
      position: relative;
      overflow: hidden;
      transition: background 0.15s, border-color 0.15s;
      text-align: center;
    }

    .combat-action-btn::before {
      content: '';
      position: absolute; top: 0; left: 0; bottom: 0; width: 2px;
      background: var(--ironstone-dim);
      transition: background 0.15s;
    }

    .combat-action-btn:hover:not(:disabled) {
      border-color: rgba(196,92,26,0.5);
      background: linear-gradient(135deg, #382818, #1e1208);
    }

    .combat-action-btn:hover:not(:disabled)::before { background: var(--ember); }

    .combat-action-btn:disabled {
      opacity: 0.35;
      cursor: not-allowed;
    }

    .combat-action-btn .btn-cost {
      display: block;
      font-size: 0.55rem;
      color: var(--ironstone);
      letter-spacing: 0.1em;
      margin-top: 3px;
      font-weight: 400;
    }

    .combat-action-btn.primed {
      border-color: rgba(196,92,26,0.6);
      background: rgba(196,92,26,0.1);
    }

    .combat-action-btn.primed::before { background: var(--ember); }

    /* Round counter */
    .combat-round-badge {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 6px 20px;
      background: #131110;
      border-bottom: 1px solid var(--ironstone-dim);
      flex-shrink: 0;
    }

    .combat-round-label {
      font-size: 0.58rem;
      letter-spacing: 0.4em;
      text-transform: uppercase;
      color: var(--ironstone);
    }

    /* ── Combat result overlay ────────────────────────────── */
    #combatResultOverlay {
      position: fixed; inset: 0;
      background: rgba(26,23,20,0.94);
      z-index: 440;
      display: none;
      align-items: center;
      justify-content: center;
      animation: fadeIn 0.4s ease;
    }

    #combatResultOverlay.visible { display: flex; }

    .combat-result-shell {
      width: 100%;
      max-width: 480px;
      padding: 0 28px;
      text-align: center;
    }

    .combat-result-icon { font-size: 2.5rem; margin-bottom: 16px; }

    .combat-result-title {
      font-family: 'IM Fell English', serif;
      font-size: 1.8rem;
      color: var(--parchment);
      margin-bottom: 8px;
    }

    .combat-result-xp {
      font-size: 1.1rem;
      font-weight: 600;
      color: var(--ember);
      margin-bottom: 8px;
    }

    .combat-result-xp span {
      font-size: 0.65rem;
      font-weight: 400;
      color: var(--ironstone);
      letter-spacing: 0.25em;
      text-transform: uppercase;
      margin-left: 6px;
    }

    .combat-result-passage {
      font-family: 'IM Fell English', serif;
      font-style: italic;
      font-size: 0.9rem;
      color: var(--ironstone);
      line-height: 1.75;
      margin: 20px 0 28px;
    }

    .combat-result-btn {
      display: block;
      width: 100%;
      padding: 13px;
      background: linear-gradient(135deg, var(--leather-edge), var(--leather-dark));
      border: 1px solid var(--ironstone-dim);
      border-radius: 2px;
      color: var(--bone);
      font-family: 'Inter', sans-serif;
      font-size: 0.7rem;
      letter-spacing: 0.3em;
      text-transform: uppercase;
      font-weight: 600;
      cursor: pointer;
      text-align: center;
      transition: border-color 0.2s, background 0.2s;
    }

    .combat-result-btn:hover {
      border-color: rgba(196,92,26,0.5);
      background: linear-gradient(135deg, #382818, #1e1208);
    }

    .combat-injuries-notice {
      font-size: 0.65rem;
      color: var(--ironstone);
      letter-spacing: 0.15em;
      margin-bottom: 20px;
      padding: 8px 16px;
      border: 1px solid var(--ironstone-dim);
      border-radius: 2px;
      display: inline-block;
    }


    /* ════════════════════════════════════════════════════════════
       PHASE 6 — LEVEL UP & ABILITIES TREE
    ════════════════════════════════════════════════════════════ */

    #levelUpOverlay {
      position: fixed; inset: 0;
      background: var(--ash);
      z-index: 600;
      display: none;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      overflow-y: auto;
      padding: 48px 24px 48px;
      animation: fadeIn 0.6s ease;
    }

    #levelUpOverlay.visible { display: flex; }

    /* ── Narrative moment ─────────────────────────────────── */
    .levelup-shell {
      width: 100%;
      max-width: 580px;
    }

    .levelup-eyebrow {
      font-size: 0.58rem;
      letter-spacing: 0.55em;
      text-transform: uppercase;
      color: var(--ironstone);
      text-align: center;
      margin-bottom: 16px;
    }

    .levelup-number {
      font-family: 'IM Fell English', serif;
      font-size: 4rem;
      color: var(--ember);
      text-align: center;
      line-height: 1;
      margin-bottom: 6px;
      text-shadow: 0 0 40px rgba(196,92,26,0.3);
    }

    .levelup-title {
      font-family: 'IM Fell English', serif;
      font-size: 1.5rem;
      color: var(--parchment);
      text-align: center;
      margin-bottom: 28px;
      line-height: 1.2;
    }

    .levelup-passage {
      font-family: 'IM Fell English', serif;
      font-style: italic;
      font-size: 0.92rem;
      color: var(--ironstone);
      line-height: 1.85;
      text-align: center;
      margin-bottom: 36px;
      padding: 24px 28px;
      border-top: 1px solid var(--ironstone-dim);
      border-bottom: 1px solid var(--ironstone-dim);
      background:
        linear-gradient(135deg, #2a2418 25%, transparent 25%) -6px 0,
        linear-gradient(225deg, #2a2418 25%, transparent 25%) -6px 0,
        linear-gradient(315deg, #2a2418 25%, transparent 25%),
        linear-gradient(45deg,  #2a2418 25%, transparent 25%);
      background-size: 12px 12px;
      background-color: #231e17;
    }

    /* ── Abilities tree heading ───────────────────────────── */
    .abilities-heading {
      font-size: 0.62rem;
      letter-spacing: 0.45em;
      text-transform: uppercase;
      color: var(--ironstone);
      text-align: center;
      margin-bottom: 6px;
    }

    .abilities-subheading {
      font-family: 'IM Fell English', serif;
      font-style: italic;
      font-size: 0.82rem;
      color: var(--ironstone);
      text-align: center;
      margin-bottom: 28px;
    }

    /* ── Branch block ─────────────────────────────────────── */
    .abilities-branch {
      margin-bottom: 14px;
      border: 1px solid var(--ironstone-dim);
      border-radius: 2px;
      overflow: hidden;
    }

    .branch-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 16px;
      background: #1e1b18;
      border-bottom: 1px solid var(--ironstone-dim);
    }

    .branch-name {
      font-size: 0.65rem;
      letter-spacing: 0.3em;
      text-transform: uppercase;
      color: var(--bone);
      font-weight: 600;
    }

    .branch-prereq {
      font-size: 0.58rem;
      color: var(--ironstone);
      letter-spacing: 0.1em;
    }

    /* ── Individual ability card ──────────────────────────── */
    .ability-card {
      display: flex;
      align-items: center;
      gap: 14px;
      padding: 12px 16px;
      background: #1a1714;
      border-bottom: 1px solid var(--ironstone-dim);
      transition: background 0.15s;
      position: relative;
    }

    .ability-card:last-child { border-bottom: none; }

    .ability-card.unlockable {
      cursor: pointer;
    }

    .ability-card.unlockable:hover {
      background: #222018;
    }

    .ability-card.already-owned {
      opacity: 0.5;
    }

    .ability-card.locked {
      opacity: 0.4;
    }

    .ability-card.selected-this-level {
      background: rgba(196,92,26,0.08);
      border-left: 2px solid var(--ember);
    }

    .ability-type-badge {
      font-size: 0.52rem;
      letter-spacing: 0.2em;
      text-transform: uppercase;
      padding: 2px 6px;
      border-radius: 10px;
      border: 1px solid var(--ironstone-dim);
      color: var(--ironstone);
      white-space: nowrap;
      flex-shrink: 0;
      width: 50px;
      text-align: center;
    }

    .ability-type-badge.active  { border-color: rgba(196,92,26,0.4); color: var(--ember); }
    .ability-type-badge.passive { border-color: rgba(138,132,120,0.4); color: var(--ironstone); }

    .ability-info { flex: 1; }

    .ability-name {
      font-size: 0.75rem;
      font-weight: 600;
      color: var(--bone);
      margin-bottom: 3px;
      letter-spacing: 0.05em;
    }

    .ability-effect {
      font-size: 0.65rem;
      color: var(--ironstone);
      line-height: 1.4;
      letter-spacing: 0.03em;
    }

    .ability-cost {
      font-size: 0.6rem;
      color: var(--ironstone);
      letter-spacing: 0.15em;
      white-space: nowrap;
      flex-shrink: 0;
    }

    .ability-lock-reason {
      font-size: 0.58rem;
      color: var(--ironstone-dim);
      margin-top: 3px;
      font-style: italic;
    }

    .ability-owned-badge {
      font-size: 0.55rem;
      letter-spacing: 0.15em;
      text-transform: uppercase;
      color: var(--ironstone);
      border: 1px solid var(--ironstone-dim);
      border-radius: 10px;
      padding: 2px 7px;
      flex-shrink: 0;
    }

    /* ── Confirm / skip buttons ───────────────────────────── */
    .levelup-footer {
      margin-top: 24px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      align-items: center;
    }

    .levelup-confirm-btn {
      padding: 13px 40px;
      background: linear-gradient(135deg, var(--leather-edge), var(--leather-dark));
      border: 1px solid rgba(196,92,26,0.4);
      border-radius: 2px;
      color: var(--ember);
      font-family: 'Inter', sans-serif;
      font-size: 0.72rem;
      letter-spacing: 0.3em;
      text-transform: uppercase;
      font-weight: 700;
      cursor: pointer;
      position: relative; overflow: hidden;
      transition: background 0.2s, border-color 0.2s;
      display: none; /* shown after a selection is made */
    }

    .levelup-confirm-btn::before {
      content: '';
      position: absolute; top: 0; left: 0; bottom: 0; width: 2px;
      background: var(--ember);
    }

    .levelup-confirm-btn:hover {
      background: linear-gradient(135deg, #382818, #1e1208);
      border-color: rgba(196,92,26,0.7);
    }

    .levelup-confirm-btn.visible { display: block; }

    .levelup-skip-btn {
      font-size: 0.6rem;
      letter-spacing: 0.25em;
      text-transform: uppercase;
      color: var(--ironstone-dim);
      background: none; border: none; cursor: pointer; padding: 0;
      text-decoration: underline; text-underline-offset: 3px;
      transition: color 0.2s;
    }

    .levelup-skip-btn:hover { color: var(--ironstone); }

    /* ── Roman numeral level display on home panel ────────── */
    .level-roman {
      font-family: 'IM Fell English', serif;
      font-size: 1.1rem;
    }


    /* ════════════════════════════════════════════════════════════
       PHASE 9 — ORDAINED BATTLE SCREENS
    ════════════════════════════════════════════════════════════ */

    #ordainedOverlay {
      position: fixed; inset: 0;
      background: var(--ash);
      z-index: 620;
      display: none;
      flex-direction: column;
      overflow-y: auto;
      animation: fadeIn 0.6s ease;
    }

    #ordainedOverlay.visible { display: flex; }

    .ordained-shell {
      width: 100%;
      max-width: 640px;
      margin: 0 auto;
      padding: 48px 28px 60px;
      display: flex;
      flex-direction: column;
      gap: 0;
    }

    /* ── Scene header ─────────────────────────────────────── */
    .ordained-eyebrow {
      font-size: 0.58rem;
      letter-spacing: 0.55em;
      text-transform: uppercase;
      color: var(--ironstone);
      text-align: center;
      margin-bottom: 14px;
    }

    .ordained-title {
      font-family: 'IM Fell English', serif;
      font-size: 2.2rem;
      color: var(--parchment);
      text-align: center;
      line-height: 1.1;
      margin-bottom: 8px;
    }

    .ordained-subtitle {
      font-size: 0.6rem;
      letter-spacing: 0.35em;
      text-transform: uppercase;
      color: var(--ironstone);
      text-align: center;
      margin-bottom: 28px;
    }

    /* ── Narrative passage ────────────────────────────────── */
    .ordained-passage {
      font-family: 'IM Fell English', serif;
      font-style: italic;
      font-size: 0.95rem;
      color: var(--ironstone);
      line-height: 1.9;
      text-align: center;
      padding: 28px 32px;
      background:
        linear-gradient(135deg, #2a2418 25%, transparent 25%) -6px 0,
        linear-gradient(225deg, #2a2418 25%, transparent 25%) -6px 0,
        linear-gradient(315deg, #2a2418 25%, transparent 25%),
        linear-gradient(45deg,  #2a2418 25%, transparent 25%);
      background-size: 12px 12px;
      background-color: #231e17;
      border-top: 1px solid rgba(74,82,64,0.3);
      border-bottom: 1px solid rgba(74,82,64,0.3);
      margin-bottom: 36px;
    }

    /* ── Section heading ──────────────────────────────────── */
    .ordained-section-heading {
      font-size: 0.6rem;
      letter-spacing: 0.45em;
      text-transform: uppercase;
      color: var(--ironstone);
      text-align: center;
      margin-bottom: 8px;
    }

    .ordained-section-sub {
      font-family: 'IM Fell English', serif;
      font-style: italic;
      font-size: 0.8rem;
      color: var(--ironstone-dim);
      text-align: center;
      margin-bottom: 24px;
      line-height: 1.5;
    }

    /* ── Branch cards ─────────────────────────────────────── */
    .ordained-branches {
      display: flex;
      flex-direction: column;
      gap: 12px;
      margin-bottom: 32px;
    }

    .ordained-branch-card {
      padding: 20px 22px;
      background: #1e1b18;
      border: 1px solid var(--ironstone-dim);
      border-radius: 2px;
      cursor: pointer;
      position: relative;
      transition: background 0.15s, border-color 0.15s;
      user-select: none;
    }

    .ordained-branch-card::before {
      content: '';
      position: absolute; top: 0; left: 0; bottom: 0; width: 2px;
      background: var(--ironstone-dim);
      transition: background 0.15s;
    }

    .ordained-branch-card:hover {
      background: #252118;
      border-color: var(--ironstone);
    }

    .ordained-branch-card.selected {
      background: rgba(196,92,26,0.07);
      border-color: rgba(196,92,26,0.5);
    }

    .ordained-branch-card.selected::before { background: var(--ember); }

    .ordained-branch-name {
      font-size: 0.72rem;
      font-weight: 700;
      letter-spacing: 0.2em;
      text-transform: uppercase;
      color: var(--bone);
      margin-bottom: 6px;
    }

    .ordained-branch-desc {
      font-family: 'IM Fell English', serif;
      font-style: italic;
      font-size: 0.85rem;
      color: var(--ironstone);
      line-height: 1.55;
      margin-bottom: 12px;
    }

    .ordained-branch-rewards {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    .ordained-reward-chip {
      font-size: 0.58rem;
      letter-spacing: 0.15em;
      color: var(--ironstone);
      padding: 3px 8px;
      border: 1px solid var(--ironstone-dim);
      border-radius: 10px;
    }

    .ordained-reward-chip.highlight {
      color: var(--ember);
      border-color: rgba(196,92,26,0.35);
    }

    /* ── Confirm footer ───────────────────────────────────── */
    .ordained-footer {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 12px;
    }

    .ordained-commit-btn {
      padding: 14px 44px;
      background: linear-gradient(135deg, var(--leather-edge), var(--leather-dark));
      border: 1px solid rgba(196,92,26,0.4);
      border-radius: 2px;
      color: var(--ember);
      font-family: 'Inter', sans-serif;
      font-size: 0.72rem;
      letter-spacing: 0.35em;
      text-transform: uppercase;
      font-weight: 700;
      cursor: pointer;
      position: relative; overflow: hidden;
      transition: background 0.2s, border-color 0.2s;
      display: none;
    }

    .ordained-commit-btn::before {
      content: ''; position: absolute; top: 0; left: 0; bottom: 0; width: 2px;
      background: var(--ember);
    }

    .ordained-commit-btn:hover {
      background: linear-gradient(135deg, #382818, #1e1208);
      border-color: rgba(196,92,26,0.7);
    }

    .ordained-commit-btn.visible { display: block; }

    .ordained-back-btn {
      font-size: 0.6rem;
      letter-spacing: 0.25em;
      text-transform: uppercase;
      color: var(--ironstone-dim);
      background: none; border: none; cursor: pointer; padding: 0;
      text-decoration: underline; text-underline-offset: 3px;
      transition: color 0.2s;
    }

    .ordained-back-btn:hover { color: var(--ironstone); }

    /* ── Result screen ────────────────────────────────────── */
    #ordainedResultOverlay {
      position: fixed; inset: 0;
      background: var(--ash);
      z-index: 630;
      display: none;
      align-items: center;
      justify-content: center;
      animation: fadeIn 0.5s ease;
    }

    #ordainedResultOverlay.visible { display: flex; }

    .ordained-result-shell {
      width: 100%;
      max-width: 520px;
      padding: 0 28px;
      text-align: center;
    }

    .ordained-result-icon { font-size: 2.5rem; margin-bottom: 16px; }

    .ordained-result-title {
      font-family: 'IM Fell English', serif;
      font-size: 1.8rem;
      color: var(--parchment);
      margin-bottom: 8px;
    }

    .ordained-result-race {
      font-size: 0.6rem;
      letter-spacing: 0.35em;
      text-transform: uppercase;
      color: var(--ironstone);
      margin-bottom: 24px;
    }

    .ordained-result-divider {
      height: 1px;
      background: linear-gradient(to right, transparent, var(--ironstone-dim), transparent);
      margin-bottom: 24px;
    }

    .ordained-result-rewards {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin-bottom: 24px;
      text-align: left;
    }

    .ordained-result-reward-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 9px 14px;
      background: #1e1b18;
      border: 1px solid var(--ironstone-dim);
      border-radius: 2px;
    }

    .ordained-result-reward-label {
      font-size: 0.62rem;
      letter-spacing: 0.2em;
      text-transform: uppercase;
      color: var(--ironstone);
    }

    .ordained-result-reward-value {
      font-size: 0.9rem;
      font-weight: 600;
      color: var(--ember);
    }

    .ordained-result-passage {
      font-family: 'IM Fell English', serif;
      font-style: italic;
      font-size: 0.9rem;
      color: var(--ironstone);
      line-height: 1.75;
      margin-bottom: 28px;
    }

    .ordained-result-ability {
      padding: 12px 16px;
      background: rgba(196,92,26,0.06);
      border: 1px solid rgba(196,92,26,0.25);
      border-radius: 2px;
      margin-bottom: 24px;
    }

    .ordained-result-ability-label {
      font-size: 0.58rem;
      letter-spacing: 0.3em;
      text-transform: uppercase;
      color: var(--ironstone);
      margin-bottom: 4px;
    }

    .ordained-result-ability-name {
      font-size: 0.85rem;
      font-weight: 600;
      color: var(--ember);
    }

    .ordained-result-ability-effect {
      font-size: 0.65rem;
      color: var(--ironstone);
      margin-top: 3px;
      letter-spacing: 0.05em;
    }

    .ordained-result-return-btn {
      display: block; width: 100%;
      padding: 13px;
      background: linear-gradient(135deg, var(--leather-edge), var(--leather-dark));
      border: 1px solid var(--ironstone-dim);
      border-radius: 2px;
      color: var(--bone);
      font-family: 'Inter', sans-serif;
      font-size: 0.7rem;
      letter-spacing: 0.3em;
      text-transform: uppercase;
      font-weight: 600;
      cursor: pointer;
      text-align: center;
      transition: border-color 0.2s, background 0.2s;
    }

    .ordained-result-return-btn:hover {
      border-color: rgba(196,92,26,0.5);
      background: linear-gradient(135deg, #382818, #1e1208);
    }

    /* ── The World button state — locked before race date ─── */
    .action-btn.race-locked .btn-sub { color: var(--ironstone-dim); }
    .action-btn.race-available .btn-title { color: var(--ember); }

    /* ════════════════════════════════════════════════════════════
       PHASE 10 — THE RECORD & EXPORT
    ════════════════════════════════════════════════════════════ */

    #recordOverlay {
      position: fixed; inset: 0;
      background: var(--ash);
      z-index: 410;
      display: none;
      flex-direction: column;
      overflow: hidden;
      animation: fadeIn 0.4s ease;
    }

    #recordOverlay.visible { display: flex; }

    /* ── Record header ───────────────────────────────────── */
    .record-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 16px 24px;
      border-bottom: 1px solid var(--ironstone-dim);
      flex-shrink: 0;
      background: #131110;
    }

    .record-header-left {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .record-eyebrow {
      font-size: 0.55rem;
      letter-spacing: 0.5em;
      text-transform: uppercase;
      color: var(--ironstone);
    }

    .record-title-text {
      font-family: 'IM Fell English', serif;
      font-size: 1.25rem;
      color: var(--parchment);
      line-height: 1;
    }

    .record-close-btn {
      background: none;
      border: 1px solid var(--ironstone-dim);
      border-radius: 2px;
      color: var(--ironstone);
      font-family: 'Inter', sans-serif;
      font-size: 0.62rem;
      letter-spacing: 0.2em;
      text-transform: uppercase;
      padding: 7px 14px;
      cursor: pointer;
      transition: color 0.15s, border-color 0.15s;
    }

    .record-close-btn:hover { color: var(--bone); border-color: var(--ironstone); }

    /* ── Summary stats bar ───────────────────────────────── */
    .record-summary-bar {
      display: flex;
      gap: 0;
      border-bottom: 1px solid var(--ironstone-dim);
      flex-shrink: 0;
      background: #1a1714;
    }

    .record-summary-stat {
      flex: 1;
      padding: 10px 0;
      text-align: center;
      border-right: 1px solid var(--ironstone-dim);
    }

    .record-summary-stat:last-child { border-right: none; }

    .record-summary-value {
      font-size: 1.0rem;
      font-weight: 600;
      color: var(--bone);
      display: block;
      line-height: 1;
      margin-bottom: 3px;
    }

    .record-summary-label {
      font-size: 0.52rem;
      letter-spacing: 0.25em;
      text-transform: uppercase;
      color: var(--ironstone);
    }

    /* ── Scrollable log list ─────────────────────────────── */
    .record-body {
      flex: 1;
      overflow-y: auto;
      padding: 0;
      scrollbar-width: thin;
      scrollbar-color: var(--ironstone-dim) transparent;
    }

    .record-empty {
      padding: 60px 24px;
      text-align: center;
      font-family: 'IM Fell English', serif;
      font-style: italic;
      font-size: 0.9rem;
      color: var(--ironstone);
    }

    /* ── Log entry row ───────────────────────────────────── */
    .record-entry {
      border-bottom: 1px solid var(--ironstone-dim);
    }

    .record-entry-header {
      display: flex;
      align-items: center;
      gap: 14px;
      padding: 13px 24px;
      cursor: pointer;
      background: #1a1714;
      transition: background 0.15s;
      user-select: none;
    }

    .record-entry-header:hover { background: #201d18; }

    .record-entry-date {
      font-size: 0.65rem;
      font-weight: 600;
      color: var(--bone);
      letter-spacing: 0.05em;
      white-space: nowrap;
      width: 96px;
      flex-shrink: 0;
    }

    .record-entry-type {
      font-size: 0.55rem;
      letter-spacing: 0.2em;
      text-transform: uppercase;
      color: var(--ironstone);
      padding: 2px 7px;
      border: 1px solid var(--ironstone-dim);
      border-radius: 10px;
      white-space: nowrap;
      flex-shrink: 0;
    }

    .record-entry-summary {
      flex: 1;
      font-size: 0.68rem;
      color: var(--ironstone);
      letter-spacing: 0.03em;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .record-entry-chevron {
      font-size: 0.6rem;
      color: var(--ironstone-dim);
      transition: transform 0.2s;
      flex-shrink: 0;
    }

    .record-entry-header.open .record-entry-chevron { transform: rotate(180deg); }

    /* ── Expanded detail ─────────────────────────────────── */
    .record-entry-detail {
      display: none;
      padding: 12px 24px 16px 134px; /* left-indent past date + type */
      background: #131110;
      border-top: 1px solid var(--ironstone-dim);
    }

    .record-entry-detail.open { display: block; }

    .record-detail-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 8px;
    }

    .record-detail-cell {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .record-detail-label {
      font-size: 0.52rem;
      letter-spacing: 0.2em;
      text-transform: uppercase;
      color: var(--ironstone-dim);
    }

    .record-detail-value {
      font-size: 0.8rem;
      font-weight: 600;
      color: var(--bone);
    }

    .record-detail-value.positive { color: var(--ember); }

    /* ── Export footer ───────────────────────────────────── */
    .record-footer {
      padding: 12px 24px;
      border-top: 1px solid var(--ironstone-dim);
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-shrink: 0;
      background: #131110;
    }

    .record-count {
      font-size: 0.6rem;
      letter-spacing: 0.2em;
      text-transform: uppercase;
      color: var(--ironstone);
    }

    .export-btn {
      padding: 8px 20px;
      background: linear-gradient(135deg, var(--leather-edge), var(--leather-dark));
      border: 1px solid var(--ironstone-dim);
      border-radius: 2px;
      color: var(--bone);
      font-family: 'Inter', sans-serif;
      font-size: 0.62rem;
      letter-spacing: 0.25em;
      text-transform: uppercase;
      font-weight: 600;
      cursor: pointer;
      position: relative; overflow: hidden;
      transition: border-color 0.2s, background 0.2s;
    }

    .export-btn::before {
      content: ''; position: absolute; top: 0; left: 0; bottom: 0; width: 2px;
      background: var(--ironstone-dim); transition: background 0.15s;
    }

    .export-btn:hover { border-color: var(--ironstone); }
    .export-btn:hover::before { background: var(--ironstone); }


  </style>
</head>
<body>


<!-- ══════════════════════════════════════════════════════════════
     SETUP OVERLAY — shown on first visit only
══════════════════════════════════════════════════════════════ -->
<div id="setupOverlay">
  <div class="setup-shell">

    <div class="setup-progress">
      <div class="progress-dot active" id="dot-0"></div>
      <div class="progress-dot"        id="dot-1"></div>
      <div class="progress-dot"        id="dot-2"></div>
      <div class="progress-dot"        id="dot-3"></div>
      <div class="progress-dot"        id="dot-4"></div>
    </div>

    <!-- Screen 1: Name -->
    <div class="setup-screen active" id="screen-0">
      <p class="setup-eyebrow">The Ashen Reaches &nbsp;·&nbsp; First Steps</p>
      <h2 class="setup-title">Who are you called?</h2>
      <p class="setup-prose">Before the road begins, before the first step into the cold grey wilderness — you need a name. Not the one given to you. The one you carry into the dark.</p>
      <div class="setup-divider"></div>

      <div class="setup-field">
        <div class="setup-label">
          <span class="setup-label-text">Warrior's Name</span>
        </div>
        <input type="text" class="setup-input" id="input-name"
               placeholder="Enter your warrior's name…"
               maxlength="40" autocomplete="off" />
        <p class="setup-error" id="err-name">A name is required to proceed.</p>
      </div>

      <div class="setup-nav">
        <button class="nav-back" disabled>← Back</button>
        <button class="nav-forward" id="btn-next-0" onclick="goNext(0)">Onward →</button>
      </div>
    </div>

    <!-- Screen 2: Origin -->
    <div class="setup-screen" id="screen-1">
      <p class="setup-eyebrow">The Ashen Reaches &nbsp;·&nbsp; First Steps</p>
      <h2 class="setup-title">Where do you come from?</h2>
      <p class="setup-prose">The Reaches do not ask about your past — but you carry it regardless. One sentence. Who were you before this story began?</p>
      <div class="setup-divider"></div>

      <div class="setup-field">
        <div class="setup-label">
          <span class="setup-label-text">Your Origin</span>
          <span class="setup-char-count" id="count-origin">0 / 100</span>
        </div>
        <input type="text" class="setup-input" id="input-origin"
               placeholder="e.g. A father who let the years get soft around him…"
               maxlength="100" autocomplete="off" />
        <p class="setup-error" id="err-origin">An origin is required — even one sentence will do.</p>
      </div>

      <div class="setup-nav">
        <button class="nav-back" onclick="goBack(1)">← Back</button>
        <button class="nav-forward" onclick="goNext(1)">Onward →</button>
      </div>
    </div>

    <!-- Screen 3: Vow -->
    <div class="setup-screen" id="screen-2">
      <p class="setup-eyebrow">The Ashen Reaches &nbsp;·&nbsp; First Steps</p>
      <h2 class="setup-title">What drives you forward?</h2>
      <p class="setup-prose">Every warrior in the Reaches carries a vow — the thing that keeps them moving when the road is cold and the reasons feel distant. State yours plainly. One sentence.</p>
      <div class="setup-divider"></div>

      <div class="setup-field">
        <div class="setup-label">
          <span class="setup-label-text">Your Vow</span>
          <span class="setup-char-count" id="count-vow">0 / 100</span>
        </div>
        <input type="text" class="setup-input" id="input-vow"
               placeholder="e.g. To prove to my children that the body can be rebuilt…"
               maxlength="100" autocomplete="off" />
        <p class="setup-error" id="err-vow">A vow is required — what are you fighting for?</p>
      </div>

      <div class="setup-nav">
        <button class="nav-back" onclick="goBack(2)">← Back</button>
        <button class="nav-forward" onclick="goNext(2)">Onward →</button>
      </div>
    </div>

    <!-- Screen 4: Units -->
    <div class="setup-screen" id="screen-3">
      <p class="setup-eyebrow">The Ashen Reaches &nbsp;·&nbsp; First Steps</p>
      <h2 class="setup-title">How do you measure the road?</h2>
      <p class="setup-prose">These choices cannot be changed after setup without resetting all your logged data. Choose carefully.</p>
      <div class="setup-divider"></div>

      <div class="setup-field">
        <div class="setup-label">
          <span class="setup-label-text">Distance</span>
        </div>
        <div class="setup-choices two-col">
          <button class="choice-btn selected" data-group="distance" data-value="km" onclick="selectChoice(this)">
            <span class="choice-title">Kilometres</span>
            <span class="choice-sub">km — used in most Spartan events internationally</span>
          </button>
          <button class="choice-btn" data-group="distance" data-value="miles" onclick="selectChoice(this)">
            <span class="choice-title">Miles</span>
            <span class="choice-sub">mi — familiar if you trained in the US</span>
          </button>
        </div>
      </div>

      <div class="setup-field">
        <div class="setup-label">
          <span class="setup-label-text">Weight</span>
        </div>
        <div class="setup-choices two-col">
          <button class="choice-btn selected" data-group="weight" data-value="kg" onclick="selectChoice(this)">
            <span class="choice-title">Kilograms</span>
            <span class="choice-sub">kg — standard metric</span>
          </button>
          <button class="choice-btn" data-group="weight" data-value="lbs" onclick="selectChoice(this)">
            <span class="choice-title">Pounds</span>
            <span class="choice-sub">lbs — familiar if you trained in the US</span>
          </button>
        </div>
      </div>

      <div class="setup-nav">
        <button class="nav-back" onclick="goBack(3)">← Back</button>
        <button class="nav-forward" onclick="goNext(3)">Onward →</button>
      </div>
    </div>

    <!-- Screen 5: Baseline -->
    <div class="setup-screen" id="screen-4">
      <p class="setup-eyebrow">The Ashen Reaches &nbsp;·&nbsp; First Steps</p>
      <h2 class="setup-title">Where do you stand today?</h2>
      <p class="setup-prose">Your honest Day 1 numbers. They anchor the baseline your stats grow from. Leave any field blank if you don't know — the system will begin from zero.</p>
      <div class="setup-divider"></div>

      <div class="baseline-grid">

        <div class="baseline-field">
          <span class="baseline-label">Best Hang Time</span>
          <span class="baseline-sublabel">Iron · The Iron Hand</span>
          <input type="number" class="setup-number" id="baseline-hang" min="0" max="999" placeholder="0" />
          <span class="baseline-unit">seconds</span>
        </div>

        <div class="baseline-field">
          <span class="baseline-label">Best Push-up Set</span>
          <span class="baseline-sublabel">Force · The Bearing</span>
          <input type="number" class="setup-number" id="baseline-pushups" min="0" max="999" placeholder="0" />
          <span class="baseline-unit">reps</span>
        </div>

        <div class="baseline-field">
          <span class="baseline-label">Best Run Distance</span>
          <span class="baseline-sublabel">Endurance · The Long Road</span>
          <input type="number" class="setup-number" id="baseline-run" min="0" max="9999" step="0.1" placeholder="0" />
          <span class="baseline-unit" id="baseline-run-unit">km</span>
        </div>

      </div>

      <div style="margin-top: 24px;">
        <button class="setup-skip" onclick="skipBaseline()">Skip — I'll start from zero</button>
      </div>

      <div class="setup-nav">
        <button class="nav-back" onclick="goBack(4)">← Back</button>
        <button class="nav-forward final" onclick="completeSetup()">Enter the Reaches →</button>
      </div>
    </div>

  </div>
</div>



<!-- ══════════════════════════════════════════════════════════════
     PHASE 9 — ORDAINED BATTLE OVERLAY
══════════════════════════════════════════════════════════════ -->
<div id="ordainedOverlay">
  <div class="ordained-shell">

    <p class="ordained-eyebrow" id="ordained-eyebrow">Ordained Battle</p>
    <div class="ordained-title" id="ordained-title">—</div>
    <div class="ordained-subtitle" id="ordained-subtitle">—</div>

    <div class="ordained-passage" id="ordained-passage">—</div>

    <div class="ordained-section-heading">Choose Your Branch</div>
    <div class="ordained-section-sub">
      The system operates on trust. Choose the branch that is true.
    </div>

    <div class="ordained-branches" id="ordained-branches"></div>

    <div class="ordained-footer">
      <button class="ordained-commit-btn" id="ordained-commit-btn"
              onclick="confirmOrdinedBranch()">
        Seal the reckoning →
      </button>
      <button class="ordained-back-btn" onclick="closeOrdained()">
        Not yet — return to the road
      </button>
    </div>

  </div>
</div>


<!-- ══════════════════════════════════════════════════════════════
     PHASE 9 — ORDAINED RESULT OVERLAY
══════════════════════════════════════════════════════════════ -->
<div id="ordainedResultOverlay">
  <div class="ordained-result-shell">
    <div class="ordained-result-icon" id="ordained-result-icon">⚔️</div>
    <div class="ordained-result-title" id="ordained-result-title">—</div>
    <div class="ordained-result-race" id="ordained-result-race">—</div>
    <div class="ordained-result-divider"></div>
    <div class="ordained-result-rewards" id="ordained-result-rewards"></div>
    <div class="ordained-result-ability" id="ordained-result-ability" style="display:none;">
      <div class="ordained-result-ability-label">Ability Unlocked</div>
      <div class="ordained-result-ability-name" id="ordained-result-ability-name">—</div>
      <div class="ordained-result-ability-effect" id="ordained-result-ability-effect">—</div>
    </div>
    <div class="ordained-result-passage" id="ordained-result-passage">—</div>
    <button class="ordained-result-return-btn" onclick="closeOrdainedResult()">
      Return to the road
    </button>
  </div>
</div>


<!-- ══════════════════════════════════════════════════════════════
     PHASE 6 — LEVEL UP & ABILITIES TREE OVERLAY
══════════════════════════════════════════════════════════════ -->
<div id="levelUpOverlay">
  <div class="levelup-shell">

    <!-- Narrative moment -->
    <p class="levelup-eyebrow">Level Reached</p>
    <div class="levelup-number" id="levelup-number">II</div>
    <div class="levelup-title" id="levelup-title">—</div>
    <div class="levelup-passage" id="levelup-passage">—</div>

    <!-- Abilities tree -->
    <div class="abilities-heading">Choose One Ability</div>
    <div class="abilities-subheading" id="abilities-subheading">Select an ability you have earned the right to carry.</div>

    <div id="abilities-tree-container"></div>

    <!-- Footer -->
    <div class="levelup-footer">
      <button class="levelup-confirm-btn" id="levelup-confirm-btn" onclick="confirmAbility()">
        Carry this forward →
      </button>
      <button class="levelup-skip-btn" onclick="skipAbility()">
        Not yet — I'll return to this
      </button>
    </div>

  </div>
</div>


<!-- ══════════════════════════════════════════════════════════════
     PHASE 5 — ENCOUNTER PREVIEW OVERLAY
══════════════════════════════════════════════════════════════ -->
<div id="encounterOverlay">
  <div class="encounter-shell">

    <p class="encounter-eyebrow">The Road Ahead</p>

    <div class="encounter-scene" id="encounter-scene-text">—</div>

    <div class="encounter-monster-card">
      <div class="encounter-monster-portrait" id="encounter-portrait">☠</div>
      <div class="encounter-monster-info">
        <div class="encounter-monster-tier" id="encounter-tier-label">Tier 1</div>
        <div class="encounter-monster-name" id="encounter-name">—</div>
        <div class="encounter-monster-desc" id="encounter-desc">—</div>
        <div class="encounter-monster-stats">
          <div class="encounter-stat-item">
            <span class="encounter-stat-label">HP</span>
            <span class="encounter-stat-value" id="encounter-hp">—</span>
          </div>
          <div class="encounter-stat-item">
            <span class="encounter-stat-label">Damage</span>
            <span class="encounter-stat-value" id="encounter-dmg">—</span>
          </div>
          <div class="encounter-stat-item">
            <span class="encounter-stat-label">XP Reward</span>
            <span class="encounter-stat-value" id="encounter-xp">—</span>
          </div>
        </div>
      </div>
    </div>

    <div class="encounter-actions">
      <button class="encounter-btn engage" onclick="startCombat()">⚔ Engage</button>
      <button class="encounter-btn withdraw" onclick="withdrawEncounter()">← Withdraw</button>
    </div>

  </div>
</div>


<!-- ══════════════════════════════════════════════════════════════
     PHASE 5 — ACTIVE COMBAT OVERLAY
══════════════════════════════════════════════════════════════ -->
<div id="combatOverlay">

  <!-- Round counter header -->
  <div class="combat-round-badge">
    <span class="combat-round-label">Round <span id="combat-round-num">1</span></span>
  </div>

  <!-- Arena: player left, monster right, log below -->
  <div class="combat-arena">

    <!-- Player side -->
    <div class="combat-side player">
      <div class="combat-side-label">Warrior</div>
      <div class="combat-player-portrait" id="combat-player-portrait">🗡</div>
      <div class="combat-name" id="combat-player-name">—</div>

      <div class="combat-hp-row">
        <span class="combat-hp-label">HP</span>
        <span class="combat-hp-numbers"><span id="combat-player-hp">50</span> / <span id="combat-player-maxhp">50</span></span>
      </div>
      <div class="combat-hp-track">
        <div class="combat-hp-fill" id="combat-player-hp-bar" style="width:100%"></div>
      </div>

      <div class="combat-mana-row">
        <span class="combat-mana-label">Mana</span>
      </div>
      <div class="combat-mana-pips" id="combat-mana-pips"></div>
    </div>

    <!-- Monster side -->
    <div class="combat-side monster">
      <div class="combat-side-label" id="combat-monster-tier-label">Tier 1</div>
      <div class="combat-monster-portrait" id="combat-monster-portrait">☠</div>
      <div class="combat-name" id="combat-monster-name">—</div>

      <div class="combat-hp-row">
        <span class="combat-hp-label">HP</span>
        <span class="combat-hp-numbers"><span id="combat-monster-hp">—</span> / <span id="combat-monster-maxhp">—</span></span>
      </div>
      <div class="combat-hp-track">
        <div class="combat-hp-fill enemy" id="combat-monster-hp-bar" style="width:100%"></div>
      </div>
    </div>

    <!-- Narrative log -->
    <div class="combat-log" id="combat-log"></div>

  </div>

  <!-- Action buttons -->
  <div class="combat-footer" id="combat-footer">
    <button class="combat-action-btn" id="btn-strike"  onclick="combatAction('strike')">
      Strike
      <span class="btn-cost">0 Mana · Force</span>
    </button>
    <button class="combat-action-btn" id="btn-endure"  onclick="combatAction('endure')">
      Endure
      <span class="btn-cost">0 Mana · End+Core</span>
    </button>
    <button class="combat-action-btn" id="btn-read"    onclick="combatAction('read')">
      Read the Enemy
      <span class="btn-cost">0 Mana · Lore</span>
    </button>
  </div>

</div>


<!-- ══════════════════════════════════════════════════════════════
     PHASE 5 — COMBAT RESULT OVERLAY
══════════════════════════════════════════════════════════════ -->
<div id="combatResultOverlay">
  <div class="combat-result-shell">
    <div class="combat-result-icon" id="result-icon">—</div>
    <div class="combat-result-title" id="result-title">—</div>
    <div class="combat-result-xp" id="result-xp" style="display:none;"></div>
    <div class="combat-injuries-notice" id="result-injury-notice" style="display:none;">
      Venture Out is unavailable for the rest of today. Returns tomorrow with full HP.
    </div>
    <div class="combat-result-passage" id="result-passage">—</div>
    <button class="combat-result-btn" onclick="closeCombatResult()">Return</button>
  </div>
</div>


<!-- ══════════════════════════════════════════════════════════════
     PHASE 10 — THE RECORD OVERLAY
══════════════════════════════════════════════════════════════ -->
<div id="recordOverlay">

  <!-- Header -->
  <div class="record-header">
    <div class="record-header-left">
      <span class="record-eyebrow">Historical Log</span>
      <span class="record-title-text">The Record</span>
    </div>
    <button class="record-close-btn" onclick="closeRecord()">✕ Close</button>
  </div>

  <!-- Summary bar -->
  <div class="record-summary-bar" id="record-summary-bar">
    <div class="record-summary-stat">
      <span class="record-summary-value" id="rec-total-sessions">0</span>
      <span class="record-summary-label">Sessions</span>
    </div>
    <div class="record-summary-stat">
      <span class="record-summary-value" id="rec-total-days">0</span>
      <span class="record-summary-label">Days Active</span>
    </div>
    <div class="record-summary-stat">
      <span class="record-summary-value" id="rec-best-streak">0</span>
      <span class="record-summary-label">Best Streak</span>
    </div>
    <div class="record-summary-stat">
      <span class="record-summary-value" id="rec-total-xp">0</span>
      <span class="record-summary-label">XP Earned</span>
    </div>
  </div>

  <!-- Scrollable session list -->
  <div class="record-body" id="record-body">
    <div class="record-empty">No sessions logged yet. Begin.</div>
  </div>

  <!-- Export footer -->
  <div class="record-footer">
    <span class="record-count" id="record-count">—</span>
    <button class="export-btn" onclick="exportData()">↓ Export Backup</button>
  </div>

</div>


<!-- ══════════════════════════════════════════════════════════════
     ABSENCE / FAILURE STATE OVERLAY  (Phase 4)
══════════════════════════════════════════════════════════════ -->
<div id="absenceOverlay">
  <div class="absence-shell">

    <!-- Tier pips: 3 dots, lit = tier reached -->
    <div class="absence-tier-row">
      <div class="absence-tier-pip" id="tier-pip-1"></div>
      <div class="absence-tier-pip" id="tier-pip-2"></div>
      <div class="absence-tier-pip" id="tier-pip-3"></div>
    </div>

    <p class="absence-eyebrow" id="absence-eyebrow">The Road Goes Cold</p>

    <!-- Days callout -->
    <div class="absence-days-callout">
      <strong id="absence-days-number">0</strong>
      <span id="absence-days-label">days since your last session</span>
    </div>

    <!-- Narrative passage -->
    <div class="absence-passage" id="absence-passage-text">—</div>

    <!-- Conditional notices (shown/hidden by JS) -->
    <div class="absence-freeze-notice" id="absence-freeze-notice" style="display:none;">
      Stat growth paused for the duration of the absence. Stats have not decayed.
    </div>

    <div class="absence-mana-notice" id="absence-mana-notice" style="display:none;">
      Mana pool reduced by 50%. Prayer and journaling will restore it.
    </div>

    <div class="absence-race-warning" id="absence-race-warning" style="display:none;"></div>

    <!-- Acknowledge -->
    <button class="absence-ack-btn" id="absence-ack-btn" onclick="dismissAbsence()">
      I hear it. Begin again.
    </button>

  </div>
</div>


<!-- ══════════════════════════════════════════════════════════════
     STREAK MILESTONE OVERLAY  (Phase 4)
══════════════════════════════════════════════════════════════ -->
<div id="milestoneOverlay">
  <div class="milestone-shell">
    <div class="milestone-icon" id="milestone-icon">—</div>
    <div class="milestone-streak-display" id="milestone-number">0</div>
    <div class="milestone-streak-label" id="milestone-label">Day Streak</div>
    <div class="milestone-title" id="milestone-title">—</div>
    <p class="milestone-passage" id="milestone-passage">—</p>
    <button class="milestone-dismiss-btn" onclick="dismissMilestone()">Continue</button>
  </div>
</div>


<!-- ══════════════════════════════════════════════════════════════
     LOGGING SCREEN OVERLAY
══════════════════════════════════════════════════════════════ -->
<div id="logOverlay">

  <!-- Header -->
  <div class="log-header">
    <div class="log-header-left">
      <div class="log-header-title">Today's Reckoning</div>
      <div class="log-header-date" id="log-date-display">—</div>
    </div>
    <div class="log-session-type">
      <span class="log-session-label">Session Type</span>
      <select class="log-session-select" id="sessionType">
        <option value="strength">Strength</option>
        <option value="endurance">Endurance</option>
        <option value="power">Power</option>
        <option value="restoration">Restoration</option>
        <option value="mixed">Mixed</option>
      </select>
    </div>
    <button class="log-close-btn" onclick="closeLog()">✕ Close</button>
  </div>

  <!-- Scrollable sections -->
  <div class="log-body">

    <!-- ── ENDURANCE ──────────────────────────────────────── -->
    <div class="log-section">
      <div class="log-section-header" onclick="toggleSection(this)">
        <div class="log-section-title-group">
          <span class="log-section-name">Endurance</span>
          <span class="log-section-world">The Long Road</span>
        </div>
        <div class="log-section-stat">
          <span class="log-stat-chip" id="chip-endurance">0</span>
          <span class="log-chevron">▼</span>
        </div>
      </div>
      <div class="log-section-body">

        <div class="log-activity">
          <div class="log-activity-title">Running</div>
          <div class="log-field-row">
            <div class="log-field-group">
              <label class="log-field-label">Distance</label>
              <input type="number" class="log-input" id="run-distance" min="0" step="0.1" placeholder="0">
            </div>
            <span class="log-input-unit" id="run-dist-unit">km</span>
            <div class="log-field-group">
              <label class="log-field-label">Time (min)</label>
              <input type="number" class="log-input" id="run-min" min="0" max="999" placeholder="0">
            </div>
            <div class="log-field-group">
              <label class="log-field-label">Time (sec)</label>
              <input type="number" class="log-input" id="run-sec" min="0" max="59" placeholder="0">
            </div>
          </div>
          <div class="log-field-row">
            <div class="log-field-group">
              <label class="log-field-label">Run Type</label>
              <select class="log-select" id="run-type">
                <option value="">— Select —</option>
                <option value="easy">Easy</option>
                <option value="tempo">Tempo</option>
                <option value="race_sim">Race Simulation</option>
              </select>
            </div>
          </div>
        </div>

        <div class="log-activity">
          <div class="log-activity-title">Stationary Bike</div>
          <div class="log-field-row">
            <div class="log-field-group">
              <label class="log-field-label">Duration</label>
              <input type="number" class="log-input" id="bike-duration" min="0" placeholder="0">
            </div>
            <span class="log-input-unit">min</span>
            <div class="log-field-group">
              <label class="log-field-label">Resistance Level</label>
              <input type="number" class="log-input" id="bike-resistance" min="0" max="30" placeholder="0">
            </div>
          </div>
        </div>

        <div class="log-activity">
          <div class="log-activity-title">Burpees</div>
          <div class="log-field-row">
            <div class="log-field-group">
              <label class="log-field-label">Total Burpees</label>
              <input type="number" class="log-input" id="burpees-total" min="0" placeholder="0">
            </div>
          </div>
          <div class="spartan-confirm">
            <input type="checkbox" class="log-checkbox" id="burpees-spartan">
            <label class="log-checkbox-label" for="burpees-spartan">
              Spartan standard confirmed — chest to floor, full jump on each rep. <em>(Unchecked = 50% stat value.)</em>
            </label>
          </div>
        </div>

      </div>
    </div>

    <!-- ── IRON ───────────────────────────────────────────── -->
    <div class="log-section">
      <div class="log-section-header" onclick="toggleSection(this)">
        <div class="log-section-title-group">
          <span class="log-section-name">Iron</span>
          <span class="log-section-world">The Iron Hand</span>
        </div>
        <div class="log-section-stat">
          <span class="log-stat-chip" id="chip-iron">0</span>
          <span class="log-chevron">▼</span>
        </div>
      </div>
      <div class="log-section-body">

        <div class="log-activity">
          <div class="log-activity-title">Hang Time</div>
          <div class="log-field-row">
            <div class="log-field-group">
              <label class="log-field-label">Best Hang (session)</label>
              <input type="number" class="log-input" id="hang-best" min="0" placeholder="0">
            </div>
            <span class="log-input-unit">sec</span>
            <div class="log-field-group">
              <label class="log-field-label">Attempts</label>
              <input type="number" class="log-input" id="hang-attempts" min="0" placeholder="0">
            </div>
          </div>
          <div class="log-target" id="target-hang">Target: — sec</div>
        </div>

        <div class="log-activity">
          <div class="log-activity-title">Pull-ups</div>
          <div class="set-rows" id="pullup-sets"></div>
          <button class="add-set-btn" onclick="addSet('pullup-sets','pullup','reps')">+ Add Set</button>
        </div>

        <div class="log-activity">
          <div class="log-activity-title">Farmer Carries</div>
          <div class="log-field-row">
            <div class="log-field-group">
              <label class="log-field-label">Duration</label>
              <input type="number" class="log-input" id="carry-duration" min="0" placeholder="0">
            </div>
            <span class="log-input-unit">min</span>
            <div class="log-field-group">
              <label class="log-field-label">Weight per hand</label>
              <input type="number" class="log-input" id="carry-weight" min="0" step="0.5" placeholder="0">
            </div>
            <span class="log-input-unit" id="carry-weight-unit">kg</span>
          </div>
        </div>

      </div>
    </div>

    <!-- ── FORCE ──────────────────────────────────────────── -->
    <div class="log-section">
      <div class="log-section-header" onclick="toggleSection(this)">
        <div class="log-section-title-group">
          <span class="log-section-name">Force</span>
          <span class="log-section-world">The Bearing</span>
        </div>
        <div class="log-section-stat">
          <span class="log-stat-chip" id="chip-force">0</span>
          <span class="log-chevron">▼</span>
        </div>
      </div>
      <div class="log-section-body">

        <div class="log-activity">
          <div class="log-activity-title">Push-ups</div>
          <div class="set-rows" id="pushup-sets"></div>
          <button class="add-set-btn" onclick="addSet('pushup-sets','pushup','reps')">+ Add Set</button>
          <div class="log-target" id="target-pushups">Target: — reps</div>
        </div>

        <div class="log-activity">
          <div class="log-activity-title">Goblet Squats <span style="color:var(--ironstone);font-size:0.6rem;letter-spacing:0.1em;"> — 25 lb fixed</span></div>
          <div class="set-rows" id="goblet-sets"></div>
          <button class="add-set-btn" onclick="addSet('goblet-sets','goblet','reps')">+ Add Set</button>
        </div>

        <div class="log-activity">
          <div class="log-activity-title">Bodyweight Squats</div>
          <div class="set-rows" id="squat-sets"></div>
          <button class="add-set-btn" onclick="addSet('squat-sets','squat','reps')">+ Add Set</button>
        </div>

        <div class="log-activity">
          <div class="log-activity-title">Step-ups</div>
          <div class="log-field-row">
            <div class="log-field-group">
              <label class="log-field-label">Total Reps (both legs)</label>
              <input type="number" class="log-input" id="stepup-reps" min="0" placeholder="0">
            </div>
            <div class="log-field-group">
              <label class="log-field-label">Step Height</label>
              <select class="log-select" id="stepup-height">
                <option value="">— Select —</option>
                <option value="low">Low</option>
                <option value="medium">Medium</option>
                <option value="high">High</option>
              </select>
            </div>
          </div>
        </div>

        <div class="log-activity">
          <div class="log-activity-title">Resistance Band Work</div>
          <div class="log-checkbox-row">
            <input type="checkbox" class="log-checkbox" id="band-completed">
            <label class="log-checkbox-label" for="band-completed">Completed resistance band work this session</label>
          </div>
        </div>

      </div>
    </div>

    <!-- ── CORE ───────────────────────────────────────────── -->
    <div class="log-section">
      <div class="log-section-header" onclick="toggleSection(this)">
        <div class="log-section-title-group">
          <span class="log-section-name">Core</span>
          <span class="log-section-world">The Foundation</span>
        </div>
        <div class="log-section-stat">
          <span class="log-stat-chip" id="chip-core">0</span>
          <span class="log-chevron">▼</span>
        </div>
      </div>
      <div class="log-section-body">

        <div class="log-activity">
          <div class="log-activity-title">Plank</div>
          <div class="log-field-row">
            <div class="log-field-group">
              <label class="log-field-label">Best Hold (session)</label>
              <input type="number" class="log-input" id="plank-best" min="0" placeholder="0">
            </div>
            <span class="log-input-unit">sec</span>
            <div class="log-field-group">
              <label class="log-field-label">Attempts</label>
              <input type="number" class="log-input" id="plank-attempts" min="0" placeholder="0">
            </div>
          </div>
          <div class="log-target" id="target-plank">Target: — sec</div>
        </div>

        <div class="log-activity">
          <div class="log-activity-title">Hollow Body Hold</div>
          <div class="log-field-row">
            <div class="log-field-group">
              <label class="log-field-label">Best Hold</label>
              <input type="number" class="log-input" id="hollow-best" min="0" placeholder="0">
            </div>
            <span class="log-input-unit">sec</span>
          </div>
        </div>

        <div class="log-activity">
          <div class="log-activity-title">Dead Bugs</div>
          <div class="log-field-row">
            <div class="log-field-group">
              <label class="log-field-label">Total Reps</label>
              <input type="number" class="log-input" id="deadbug-reps" min="0" placeholder="0">
            </div>
            <span class="log-input-unit">reps</span>
          </div>
        </div>

        <div class="log-activity">
          <div class="log-activity-title">Bear Crawls</div>
          <div class="log-field-row">
            <div class="log-field-group">
              <label class="log-field-label">Duration</label>
              <input type="number" class="log-input" id="bearcrawl-sec" min="0" placeholder="0">
            </div>
            <span class="log-input-unit">sec</span>
            <div class="log-field-group">
              <label class="log-field-label">— OR — Distance</label>
              <input type="number" class="log-input" id="bearcrawl-m" min="0" placeholder="0">
            </div>
            <span class="log-input-unit">m</span>
          </div>
        </div>

        <div class="log-activity">
          <div class="log-activity-title">Additional Core Work</div>
          <div class="log-checkbox-row">
            <input type="checkbox" class="log-checkbox" id="core-additional">
            <label class="log-checkbox-label" for="core-additional">Completed additional core work not listed above</label>
          </div>
        </div>

      </div>
    </div>

    <!-- ── POWER ──────────────────────────────────────────── -->
    <div class="log-section">
      <div class="log-section-header" onclick="toggleSection(this)">
        <div class="log-section-title-group">
          <span class="log-section-name">Power</span>
          <span class="log-section-world">Endurance + Force</span>
        </div>
        <div class="log-section-stat">
          <span class="log-stat-chip" id="chip-power">Phase <span id="power-phase-label">1</span></span>
          <span class="log-chevron">▼</span>
        </div>
      </div>
      <div class="log-section-body">

        <div class="log-activity">
          <div class="log-activity-title">Plyometrics / Foot Contacts</div>
          <div class="log-field-row">
            <div class="log-field-group">
              <label class="log-field-label">Total Foot Contacts</label>
              <input type="number" class="log-input" id="power-contacts" min="0" placeholder="0">
            </div>
            <span class="log-input-unit">contacts</span>
          </div>
        </div>

        <div class="log-activity" id="power-sprint-section" style="display:none;">
          <div class="log-activity-title">Sprint Intervals <span style="color:var(--ironstone);font-size:0.6rem;"> — Phase 3 only</span></div>
          <div class="log-field-row">
            <div class="log-field-group">
              <label class="log-field-label">Intervals</label>
              <input type="number" class="log-input" id="sprint-intervals" min="0" placeholder="0">
            </div>
            <div class="log-field-group">
              <label class="log-field-label">Work (sec)</label>
              <input type="number" class="log-input" id="sprint-work" min="0" placeholder="0">
            </div>
            <div class="log-field-group">
              <label class="log-field-label">Rest (sec)</label>
              <input type="number" class="log-input" id="sprint-rest" min="0" placeholder="0">
            </div>
          </div>
        </div>

      </div>
    </div>

    <!-- ── RESOLVE ────────────────────────────────────────── -->
    <div class="log-section">
      <div class="log-section-header" onclick="toggleSection(this)">
        <div class="log-section-title-group">
          <span class="log-section-name">Resolve</span>
          <span class="log-section-world">The Source</span>
        </div>
        <div class="log-section-stat">
          <span class="log-stat-chip" id="chip-resolve">0</span>
          <span class="log-chevron">▼</span>
        </div>
      </div>
      <div class="log-section-body">

        <div class="log-activity">
          <div class="log-activity-title">Prayer</div>
          <div class="log-checkbox-row">
            <input type="checkbox" class="log-checkbox" id="prayer-done">
            <label class="log-checkbox-label" for="prayer-done">Prayer completed today</label>
          </div>
          <div class="log-field-row" style="margin-top:6px;">
            <div class="log-field-group" style="max-width:120px;">
              <label class="log-field-label">Duration (optional)</label>
              <input type="number" class="log-input" id="prayer-duration" min="0" placeholder="0">
            </div>
            <span class="log-input-unit">min</span>
          </div>
        </div>

        <div class="log-activity">
          <div class="log-activity-title">Journaling</div>
          <div class="log-checkbox-row">
            <input type="checkbox" class="log-checkbox" id="journal-done">
            <label class="log-checkbox-label" for="journal-done">Journaling completed today</label>
          </div>
        </div>

        <div class="log-activity">
          <div class="log-activity-title">Reading</div>
          <div class="log-checkbox-row">
            <input type="checkbox" class="log-checkbox" id="reading-done">
            <label class="log-checkbox-label" for="reading-done">Reading completed today</label>
          </div>
          <div class="log-field-row" style="margin-top:6px;">
            <div class="log-field-group" style="max-width:120px;">
              <label class="log-field-label">Pages read (optional)</label>
              <input type="number" class="log-input" id="reading-pages" min="0" placeholder="0">
            </div>
            <span class="log-input-unit">pages</span>
          </div>
        </div>

      </div>
    </div>

    <!-- spacer so last section isn't flush against footer -->
    <div style="height: 12px;"></div>

  </div><!-- /log-body -->

  <!-- Commit footer -->
  <div class="log-footer">
    <button class="commit-btn" onclick="commitLog()">Commit</button>
  </div>

</div><!-- /logOverlay -->


<!-- ══════════════════════════════════════════════════════════════
     STAT SUMMARY SCREEN
══════════════════════════════════════════════════════════════ -->
<div id="summaryOverlay">
  <div class="summary-shell">
    <div class="summary-heading">Today's reckoning.</div>
    <div class="summary-date" id="summary-date-display">—</div>
    <div class="summary-divider"></div>
    <div class="summary-stats" id="summary-stats-list"></div>
    <div class="summary-flavour" id="summary-flavour-text">—</div>
    <button class="summary-return-btn" onclick="closeSummary()">Return</button>
  </div>
</div>


<!-- ══════════════════════════════════════════════════════════════
     HOME SCREEN
══════════════════════════════════════════════════════════════ -->
<div class="app" id="homeScreen">

  <div class="hero">
    <div class="hero-scene">
      <div class="dead-tree"></div>
      <div class="ember-glow"></div>
      <div class="road"></div>
    </div>
    <div class="hero-image"></div>
    <div class="hero-vignette"></div>
    <div class="hero-title">
      <h1>The Ashen Reaches</h1>
      <p class="subtitle">Road to the Spartan Trifecta &nbsp;·&nbsp; 2025</p>
    </div>
  </div>

  <div class="flavour-band">
    <p class="flavour-text" id="flavourText">"You are here. That is more than most. Begin."</p>
  </div>

  <div class="panel-row">

    <div class="panel stone panel-character">
      <div class="corner-mark tl"></div>
      <div class="corner-mark br"></div>
      <div class="panel-label">Warrior</div>

      <div class="phase-badge">
        <span class="phase-dot"></span>
        Foundation Phase
      </div>

      <div class="char-name" id="display-name">—</div>
      <p class="char-origin" id="display-origin">—</p>

      <div class="char-meta">
        <div class="meta-row">
          <span class="meta-label">Character Level</span>
          <span class="meta-value ember">I</span>
        </div>

        <div class="xp-bar-wrap">
          <div class="meta-row">
            <span class="meta-label">Experience</span>
            <span class="meta-value" style="font-size:0.75rem">0 / 200 XP</span>
          </div>
          <div class="xp-bar-track">
            <div class="xp-bar-fill" style="width:0%"></div>
          </div>
          <span class="xp-label">Next Level: 200 XP required</span>
        </div>

        <div class="mana-row">
          <div class="meta-row">
            <span class="meta-label">Mana</span>
            <span class="meta-value" style="font-size:0.75rem" id="mana-display">0 / 33</span>
          </div>
          <div class="mana-pips" id="manaPips"></div>
        </div>

        <div class="next-race">
          <div class="panel-label" style="margin:0 0 8px; padding:0; border:none;">Next Reckoning</div>
          <div class="race-title">Trial of the Iron Gate</div>
          <div class="race-meta">Spartan 5K Sprint · May 23, 2025</div>
          <div class="race-days" id="daysUntil">—</div>
        </div>
      </div>
    </div>

    <div class="panel stone panel-stats">
      <div class="panel-label">Character Stats</div>
      <div class="stats-grid">

        <div class="stat-row">
          <div class="stat-name">Endurance<span class="stat-world-name">The Long Road</span></div>
          <div class="stat-bar-track"><div class="stat-bar-fill endurance" id="bar-endurance" style="width:0%"></div></div>
          <div class="stat-value" id="val-endurance">0</div>
        </div>

        <div class="stat-row">
          <div class="stat-name">Iron<span class="stat-world-name">The Iron Hand</span></div>
          <div class="stat-bar-track"><div class="stat-bar-fill iron" id="bar-iron" style="width:0%"></div></div>
          <div class="stat-value" id="val-iron">0</div>
        </div>

        <div class="stat-row">
          <div class="stat-name">Force<span class="stat-world-name">The Bearing</span></div>
          <div class="stat-bar-track"><div class="stat-bar-fill force" id="bar-force" style="width:0%"></div></div>
          <div class="stat-value" id="val-force">0</div>
        </div>

        <div class="stat-row">
          <div class="stat-name">Core<span class="stat-world-name">The Foundation</span></div>
          <div class="stat-bar-track"><div class="stat-bar-fill core" id="bar-core" style="width:0%"></div></div>
          <div class="stat-value" id="val-core">0</div>
        </div>

        <div class="stat-row">
          <div class="stat-name">Resolve<span class="stat-world-name">The Source</span></div>
          <div class="stat-bar-track"><div class="stat-bar-fill resolve" id="bar-resolve" style="width:0%"></div></div>
          <div class="stat-value" id="val-resolve">0</div>
        </div>

        <div class="stat-row">
          <div class="stat-name">Lore<span class="stat-world-name">The Knowing</span></div>
          <div class="stat-bar-track"><div class="stat-bar-fill lore" id="bar-lore" style="width:0%"></div></div>
          <div class="stat-value" id="val-lore">0</div>
        </div>

      </div>

      <div class="readiness-wrap">
        <div class="readiness-inner">
          <div>
            <div class="readiness-label">Readiness Score</div>
            <div style="font-size:0.6rem;color:var(--ironstone);margin-top:2px;">Weighted for Trial of the Iron Gate</div>
          </div>
          <div>
            <div class="readiness-score" id="readiness-score">0</div>
            <div class="readiness-sub">/ 100</div>
          </div>
        </div>
        <div class="readiness-bar-track">
          <div class="readiness-bar-fill" id="readiness-bar" style="width:0%"></div>
        </div>
      </div>
    </div>

    <div class="panel leather panel-actions">
      <div class="panel-label">The Road</div>

      <button class="action-btn primary">
        <span class="btn-title">Log Training</span>
        <span class="btn-sub">Record today's session</span>
      </button>

      <button class="action-btn">
        <span class="btn-title">Venture Out</span>
        <span class="btn-sub">Face what waits in the dark</span>
      </button>

      <button class="action-btn">
        <span class="btn-title">The World</span>
        <span class="btn-sub">Survey the Ashen Reaches</span>
      </button>

      <button class="action-btn" style="margin-top:8px;">
        <span class="btn-title">The Record</span>
        <span class="btn-sub">Your history in full</span>
      </button>
    </div>

  </div>

  <div class="streak-band">
    <div class="streak-item">
      <span class="streak-label">Training Streak</span>
      <span class="streak-number" id="streak-training">0 <span>Days</span></span>
    </div>
    <div class="streak-item">
      <span class="streak-label">Resolve Streak</span>
      <span class="streak-number" id="streak-resolve">0 <span>Days</span></span>
    </div>
    <div class="streak-item">
      <span class="streak-label">Restoration Streak</span>
      <span class="streak-number" id="streak-restoration">0 <span>Weeks</span></span>
    </div>
  </div>

</div>


<script>
  /* ============================================================
     STORAGE
  ============================================================ */
  const STORAGE_KEY = 'ashenReaches_v1';

  function loadData() {
    try {
      const raw = localStorage.getItem(STORAGE_KEY);
      return raw ? JSON.parse(raw) : null;
    } catch(e) { return null; }
  }

  function saveData(data) {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
  }

  /* ============================================================
     SETUP STATE
  ============================================================ */
  const setupData = { name:'', origin:'', vow:'', distance:'km', weight:'kg', baseline:{hang:0,pushups:0,run:0} };
  let currentScreen = 0;

  /* Character counters */
  document.getElementById('input-origin').addEventListener('input', function() {
    const c = document.getElementById('count-origin');
    c.textContent = this.value.length + ' / 100';
    c.classList.toggle('warn', this.value.length > 85);
  });

  document.getElementById('input-vow').addEventListener('input', function() {
    const c = document.getElementById('count-vow');
    c.textContent = this.value.length + ' / 100';
    c.classList.toggle('warn', this.value.length > 85);
  });

  /* Enter key advances screens */
  document.querySelectorAll('.setup-input, .setup-number').forEach(function(el) {
    el.addEventListener('keydown', function(e) {
      if (e.key === 'Enter') {
        const btn = document.querySelector('#screen-' + currentScreen + ' .nav-forward');
        if (btn) btn.click();
      }
    });
  });

  /* Progress dots */
  function updateDots(active) {
    for (let i = 0; i < 5; i++) {
      const d = document.getElementById('dot-' + i);
      d.classList.remove('active','done');
      if (i < active)       d.classList.add('done');
      else if (i === active) d.classList.add('active');
    }
  }

  /* Forward */
  function goNext(idx) {
    if (idx === 0) {
      const v = document.getElementById('input-name').value.trim();
      if (!v) { showErr('err-name','input-name'); return; }
      setupData.name = v;
      hideErr('err-name','input-name');
    }
    if (idx === 1) {
      const v = document.getElementById('input-origin').value.trim();
      if (!v) { showErr('err-origin','input-origin'); return; }
      setupData.origin = v;
      hideErr('err-origin','input-origin');
    }
    if (idx === 2) {
      const v = document.getElementById('input-vow').value.trim();
      if (!v) { showErr('err-vow','input-vow'); return; }
      setupData.vow = v;
      hideErr('err-vow','input-vow');
    }

    document.getElementById('screen-' + idx).classList.remove('active');
    currentScreen = idx + 1;
    document.getElementById('screen-' + currentScreen).classList.add('active');
    updateDots(currentScreen);

    if (currentScreen === 4) {
      document.getElementById('baseline-run-unit').textContent = setupData.distance;
    }
  }

  /* Back */
  function goBack(idx) {
    document.getElementById('screen-' + idx).classList.remove('active');
    currentScreen = idx - 1;
    document.getElementById('screen-' + currentScreen).classList.add('active');
    updateDots(currentScreen);
  }

  /* Unit choice */
  function selectChoice(btn) {
    const group = btn.getAttribute('data-group');
    document.querySelectorAll('[data-group="' + group + '"]').forEach(function(b) { b.classList.remove('selected'); });
    btn.classList.add('selected');
    setupData[group] = btn.getAttribute('data-value');
  }

  /* Skip baseline */
  function skipBaseline() {
    setupData.baseline = { hang:0, pushups:0, run:0 };
    completeSetup();
  }

  /* Complete setup */
  function completeSetup() {
    setupData.baseline = {
      hang:    parseFloat(document.getElementById('baseline-hang').value)    || 0,
      pushups: parseFloat(document.getElementById('baseline-pushups').value) || 0,
      run:     parseFloat(document.getElementById('baseline-run').value)     || 0
    };

    const gameData = {
      setupComplete: true,
      createdAt: new Date().toISOString(),
      warrior: {
        name:     setupData.name,
        origin:   setupData.origin,
        vow:      setupData.vow,
        distance: setupData.distance,
        weight:   setupData.weight
      },
      baseline: setupData.baseline,
      stats: { endurance:0, iron:0, force:0, core:0, resolve:0, lore:0 },
      character: { level:1, xp:0, hp:50, maxHp:50, mana:0, maxMana:33 },
      streaks: {
        training:0, resolve:0, restoration:0,
        lastTrainingDate:null, lastResolveDate:null, lastRestorationWeek:null
      },
      log: []
    };

    saveData(gameData);

    const overlay = document.getElementById('setupOverlay');
    overlay.classList.add('hidden');
    setTimeout(function() {
      overlay.style.display = 'none';
      populateHomeScreen(gameData);
    }, 600);
  }

  /* ============================================================
     HOME SCREEN POPULATION
  ============================================================ */
  function populateHomeScreen(data) {
    /* Name and origin */
    document.getElementById('display-name').textContent   = data.warrior.name;
    document.getElementById('display-origin').textContent = data.warrior.origin;

    /* Stats */
    var stats = data.stats;
    ['endurance','iron','force','core','resolve','lore'].forEach(function(s) {
      var val = stats[s] || 0;
      document.getElementById('val-' + s).textContent         = val;
      document.getElementById('bar-' + s).style.width         = val + '%';
    });

    /* Readiness — Sprint race weights */
    var r = Math.round(
      stats.endurance * 0.25 +
      stats.iron      * 0.15 +
      stats.force     * 0.20 +
      stats.core      * 0.15 +
      stats.resolve   * 0.15 +
      stats.lore      * 0.10
    );
    document.getElementById('readiness-score').textContent   = r;
    document.getElementById('readiness-bar').style.width     = r + '%';

    /* Mana pips */
    var pipContainer = document.getElementById('manaPips');
    pipContainer.innerHTML = '';
    var maxMana  = data.character.maxMana;
    var currMana = data.character.mana;
    document.getElementById('mana-display').textContent = currMana + ' / ' + maxMana;
    for (var i = 0; i < maxMana; i++) {
      var pip = document.createElement('div');
      pip.className = 'mana-pip' + (i < currMana ? ' filled' : '');
      pipContainer.appendChild(pip);
    }

    /* Streaks */
    document.getElementById('streak-training').innerHTML    = data.streaks.training    + ' <span>Days</span>';
    document.getElementById('streak-resolve').innerHTML     = data.streaks.resolve     + ' <span>Days</span>';
    document.getElementById('streak-restoration').innerHTML = data.streaks.restoration + ' <span>Weeks</span>';

    /* Race countdown */
    var raceDate = new Date('2025-05-23');
    var today    = new Date(); today.setHours(0,0,0,0);
    var diff     = Math.ceil((raceDate - today) / 86400000);
    var el       = document.getElementById('daysUntil');
    if (diff > 0)       el.innerHTML = diff + ' <span>Days</span>';
    else if (diff === 0){ el.innerHTML = 'Today <span>— The Gate Opens</span>'; el.style.color = 'var(--ember)'; }
    else                { el.innerHTML = 'Complete <span>— Battle Available</span>'; el.style.color = 'var(--ironstone)'; }
  }

  /* ============================================================
     HELPERS
  ============================================================ */
  function showErr(errId, inputId) {
    document.getElementById(errId).classList.add('visible');
    document.getElementById(inputId).classList.add('error');
    document.getElementById(inputId).focus();
  }

  function hideErr(errId, inputId) {
    document.getElementById(errId).classList.remove('visible');
    document.getElementById(inputId).classList.remove('error');
  }

  /* ============================================================
     PHASE 3 — LOGGING SCREEN
  ============================================================ */

  /* -- Flavour text banks ----------------------------------- */
  var FLAVOUR = {
    strength:    ["The weight does not care about your reasons. You moved it anyway.",
                  "Strength is not built in the moment you lift. It is built in the moment you chose to.",
                  "The body remembers what the mind forgets. You gave it something to remember.",
                  "Nothing about today was certain. You made it certain anyway.",
                  "You are not stronger today than yesterday. You are less weak.",
                  "The bar does not move itself. Neither does anything worth having.",
                  "Hard work in the dark builds the same muscle as hard work in the light.",
                  "The Reaches demand more than intention. Today you delivered."],
    endurance:   ["The road remembers every foot that crossed it. So does yours.",
                  "Distance is just time made visible. You spent it well.",
                  "Lungs that burned today will not burn the same way next time.",
                  "You did not stop. That is all the Reaches asked of you.",
                  "Running teaches the body one thing above all: that it can.",
                  "What you built today cannot be taken from you. Only neglected.",
                  "Endurance is not the absence of pain. It is the decision to continue through it.",
                  "The distance behind you is the only argument that matters."],
    power:       ["Something changed in the way you land. The ground noticed.",
                  "Explosiveness is controlled violence. You are learning the control.",
                  "The first jump is faith. Every jump after that is evidence.",
                  "Power is not just force. It is force arriving precisely.",
                  "The hills of the Reaches do not yield. Neither, today, did you.",
                  "Speed is built in fragments. Each fragment matters.",
                  "You are teaching your body to fall correctly. That is harder than it sounds.",
                  "The sprint ends. The capacity to sprint again is what you are building."],
    restoration: ["A warrior who cannot rest cannot fight. You rested.",
                  "Maintenance is not weakness. The blade that is never sharpened does not cut.",
                  "What you preserved today, you will need in October.",
                  "The Reaches are patient. They will still be here after you have healed.",
                  "Stillness is not absence. It is preparation wearing different clothes.",
                  "You gave the body what it asked for. It will remember.",
                  "Recovery is training. Slow down enough to believe that.",
                  "The quiet day builds the same character as the hard one. It just does it differently."],
    mixed:       ["Not every day gives everything. This one gave what it gave.",
                  "Variety is honest. You trained what needed training.",
                  "The Reaches do not require perfection. Only presence.",
                  "Different demands. Same answer: you showed up.",
                  "A mixed day is still a day that happened. It counts.",
                  "Not your best session. Not your last, either.",
                  "The work was uneven. It was still work.",
                  "You came. You did something. That is not nothing."]
  };

  function randomFlavour(sessionType) {
    var bank = FLAVOUR[sessionType] || FLAVOUR.mixed;
    return '"' + bank[Math.floor(Math.random() * bank.length)] + '"';
  }

  /* -- Determine Power phase by date ----------------------- */
  function getPowerPhase() {
    var now = new Date();
    var apr1  = new Date('2025-04-01');
    var apr21 = new Date('2025-04-21');
    if (now >= apr21) return 3;
    if (now >= apr1)  return 2;
    return 1;
  }

  /* -- Section toggle --------------------------------------- */
  function toggleSection(header) {
    var body = header.nextElementSibling;
    var isOpen = header.classList.contains('open');
    header.classList.toggle('open', !isOpen);
    body.classList.toggle('open', !isOpen);
  }

  /* -- Repeating set rows ----------------------------------- */
  function addSet(containerId, prefix, unit) {
    var container = document.getElementById(containerId);
    var count = container.querySelectorAll('.set-row').length;
    if (count >= 10) return;
    var idx = count + 1;
    var row = document.createElement('div');
    row.className = 'set-row';
    row.innerHTML =
      '<span class="set-label">Set ' + idx + '</span>' +
      '<input type="number" class="set-input" data-set="' + prefix + '" min="0" placeholder="0" style="-moz-appearance:textfield;">' +
      '<span class="set-unit">' + unit + '</span>' +
      '<button class="set-remove" onclick="removeSet(this)" title="Remove">✕</button>';
    container.appendChild(row);
    renumberSets(container);
  }

  function removeSet(btn) {
    var row = btn.closest('.set-row');
    var container = row.parentElement;
    row.remove();
    renumberSets(container);
  }

  function renumberSets(container) {
    container.querySelectorAll('.set-row').forEach(function(r, i) {
      r.querySelector('.set-label').textContent = 'Set ' + (i + 1);
    });
  }

  function getSetValues(containerId) {
    var vals = [];
    document.getElementById(containerId).querySelectorAll('.set-input').forEach(function(inp) {
      var v = parseFloat(inp.value) || 0;
      if (v > 0) vals.push(v);
    });
    return vals;
  }

  /* -- Open the log screen ---------------------------------- */
  function openLog() {
    var data = loadData();
    if (!data) return;

    /* Set date */
    var now = new Date();
    var opts = { weekday:'long', year:'numeric', month:'long', day:'numeric' };
    document.getElementById('log-date-display').textContent = now.toLocaleDateString('en-CA', opts).toUpperCase();
    document.getElementById('summary-date-display').textContent = now.toLocaleDateString('en-CA', opts).toUpperCase();

    /* Units */
    var distUnit   = data.warrior.distance || 'km';
    var weightUnit = data.warrior.weight   || 'kg';
    document.getElementById('run-dist-unit').textContent    = distUnit;
    document.getElementById('carry-weight-unit').textContent = weightUnit;

    /* Stat chips — current values */
    ['endurance','iron','force','core','resolve'].forEach(function(s) {
      var el = document.getElementById('chip-' + s);
      if (el) el.textContent = data.stats[s] || 0;
    });

    /* Targets from baseline */
    var hangTarget   = (data.baseline.hang    || 0) + 3;
    var pushTarget   = (data.baseline.pushups || 0) + 2;
    var plankTarget  = (data.targets && data.targets.plank)  || 30;

    document.getElementById('target-hang').textContent    = 'Target: ' + hangTarget + ' sec';
    document.getElementById('target-pushups').textContent = 'Target: ' + pushTarget + ' reps';
    document.getElementById('target-plank').textContent   = 'Target: ' + plankTarget + ' sec';

    /* Power phase */
    var phase = getPowerPhase();
    document.getElementById('power-phase-label').textContent = phase;
    document.getElementById('power-sprint-section').style.display = (phase === 3) ? 'block' : 'none';

    /* Clear all inputs */
    document.querySelectorAll('#logOverlay input[type=number], #logOverlay input[type=text]').forEach(function(i) { i.value = ''; });
    document.querySelectorAll('#logOverlay input[type=checkbox]').forEach(function(c) { c.checked = false; });
    document.querySelectorAll('#logOverlay select').forEach(function(s) { s.selectedIndex = 0; });

    /* Clear dynamic set rows */
    ['pullup-sets','pushup-sets','goblet-sets','squat-sets'].forEach(function(id) {
      document.getElementById(id).innerHTML = '';
    });

    /* Collapse all sections */
    document.querySelectorAll('.log-section-header.open').forEach(function(h) {
      h.classList.remove('open');
      h.nextElementSibling.classList.remove('open');
    });

    document.getElementById('logOverlay').classList.add('visible');
    document.body.style.overflow = 'hidden';
  }

  function closeLog() {
    document.getElementById('logOverlay').classList.remove('visible');
    document.body.style.overflow = '';
  }

  /* -- STAT CALCULATION ------------------------------------- */
  function calcStatDeltas(data) {
    var baseline = data.baseline || {};
    var current  = data.stats   || {};

    var deltas = { endurance:0, iron:0, force:0, core:0, resolve:0, lore:0 };

    /* -- ENDURANCE -- */
    var runDist = parseFloat(document.getElementById('run-distance').value) || 0;
    var bikeDur = parseFloat(document.getElementById('bike-duration').value) || 0;
    var bikeRes = parseFloat(document.getElementById('bike-resistance').value) || 0;
    var burpees = parseFloat(document.getElementById('burpees-total').value) || 0;
    var spartanOk = document.getElementById('burpees-spartan').checked;

    var endPts = 0;
    if (runDist > 0) {
      /* Points: each km = 2 pts, capped at 20 per session */
      var distUnit = data.warrior.distance || 'km';
      var km = distUnit === 'miles' ? runDist * 1.609 : runDist;
      endPts += Math.min(km * 2, 20);
    }
    if (bikeDur > 0) endPts += Math.min(bikeDur * 0.1 * (bikeRes > 0 ? bikeRes / 10 + 1 : 1), 5);
    if (burpees > 0) endPts += Math.min(burpees * (spartanOk ? 0.1 : 0.05), 5);
    deltas.endurance = parseFloat(Math.min(endPts, 25).toFixed(1));

    /* -- IRON -- */
    var hangBest = parseFloat(document.getElementById('hang-best').value) || 0;
    var pullups  = getSetValues('pullup-sets');
    var totalPullups = pullups.reduce(function(a,b){return a+b;}, 0);

    var ironPts = 0;
    if (hangBest > 0) ironPts += Math.min(hangBest * 0.15, 8);
    if (totalPullups > 0) ironPts += Math.min(totalPullups * 0.25, 8);
    deltas.iron = parseFloat(Math.min(ironPts, 20).toFixed(1));

    /* -- FORCE -- */
    var pushups  = getSetValues('pushup-sets');
    var goblets  = getSetValues('goblet-sets');
    var squats   = getSetValues('squat-sets');
    var stepReps = parseFloat(document.getElementById('stepup-reps').value) || 0;
    var bandDone = document.getElementById('band-completed').checked;

    var totalPushups = pushups.reduce(function(a,b){return a+b;}, 0);
    var totalGoblets = goblets.reduce(function(a,b){return a+b;}, 0);
    var totalSquats  = squats.reduce(function(a,b){return a+b;}, 0);

    var forcePts = 0;
    if (totalPushups > 0) forcePts += Math.min(totalPushups * 0.12, 8);
    if (totalGoblets > 0) forcePts += Math.min(totalGoblets * 0.08, 5);
    if (totalSquats  > 0) forcePts += Math.min(totalSquats  * 0.05, 4);
    if (stepReps > 0)     forcePts += Math.min(stepReps * 0.04, 3);
    if (bandDone)         forcePts += 1;
    deltas.force = parseFloat(Math.min(forcePts, 20).toFixed(1));

    /* -- CORE -- */
    var plankBest   = parseFloat(document.getElementById('plank-best').value)    || 0;
    var hollowBest  = parseFloat(document.getElementById('hollow-best').value)   || 0;
    var deadbugReps = parseFloat(document.getElementById('deadbug-reps').value)  || 0;
    var bcSec       = parseFloat(document.getElementById('bearcrawl-sec').value) || 0;
    var bcM         = parseFloat(document.getElementById('bearcrawl-m').value)   || 0;
    var coreExtra   = document.getElementById('core-additional').checked;

    var corePts = 0;
    if (plankBest  > 0) corePts += Math.min(plankBest  * 0.1,  8);
    if (hollowBest > 0) corePts += Math.min(hollowBest * 0.08, 4);
    if (deadbugReps> 0) corePts += Math.min(deadbugReps* 0.05, 3);
    if (bcSec > 0 || bcM > 0) corePts += Math.min((bcSec + bcM * 0.5) * 0.05, 4);
    if (coreExtra)      corePts += 1;
    deltas.core = parseFloat(Math.min(corePts, 20).toFixed(1));

    /* -- RESOLVE -- */
    var prayerDone  = document.getElementById('prayer-done').checked;
    var prayerMin   = parseFloat(document.getElementById('prayer-duration').value) || 0;
    var journalDone = document.getElementById('journal-done').checked;
    var readingDone = document.getElementById('reading-done').checked;
    var readPages   = parseFloat(document.getElementById('reading-pages').value) || 0;

    var resolvePts = 0;
    if (prayerDone)  { resolvePts += (prayerMin >= 10) ? 1.5 : 1; }
    if (journalDone) { resolvePts += 1; }
    deltas.resolve = parseFloat(Math.min(resolvePts, 3).toFixed(1));

    /* -- LORE -- */
    var lorePts = 0;
    if (readingDone) { lorePts += (readPages >= 20) ? 1.5 : 1; }
    deltas.lore = parseFloat(Math.min(lorePts, 2).toFixed(1));

    /* -- POWER (split equally to Endurance + Force) -- */
    var contacts = parseFloat(document.getElementById('power-contacts').value) || 0;
    if (contacts > 0) {
      var powerBonus = Math.min(contacts * 0.05, 4);
      deltas.endurance = parseFloat((deltas.endurance + powerBonus / 2).toFixed(1));
      deltas.force     = parseFloat((deltas.force     + powerBonus / 2).toFixed(1));
    }

    return deltas;
  }

  /* -- COMMIT ----------------------------------------------- */
  function commitLog() {
    var data = loadData();
    if (!data) return;

    var sessionType = document.getElementById('sessionType').value;
    var deltas = calcStatDeltas(data);
    var prevStats = {};

    /* Apply deltas, cap at 100 */
    ['endurance','iron','force','core','resolve','lore'].forEach(function(s) {
      prevStats[s] = data.stats[s] || 0;
      data.stats[s] = parseFloat(Math.min(100, prevStats[s] + (deltas[s] || 0)).toFixed(1));
    });

    /* Mana: prayer +10, journal +5 */
    var prayerDone  = document.getElementById('prayer-done').checked;
    var journalDone = document.getElementById('journal-done').checked;
    var manaGain = (prayerDone ? 10 : 0) + (journalDone ? 5 : 0);
    data.character.mana = Math.min(data.character.maxMana, (data.character.mana || 0) + manaGain);

    /* Streaks */
    var todayStr = new Date().toISOString().slice(0,10);
    var hasPhysical = (deltas.endurance + deltas.iron + deltas.force + deltas.core) > 0;
    if (hasPhysical) {
      var last = data.streaks.lastTrainingDate;
      var yesterday = new Date(); yesterday.setDate(yesterday.getDate() - 1);
      var yStr = yesterday.toISOString().slice(0,10);
      if (last === yStr || last === todayStr) {
        if (last !== todayStr) data.streaks.training = (data.streaks.training || 0) + 1;
      } else {
        data.streaks.training = 1;
      }
      data.streaks.lastTrainingDate = todayStr;
    }

    var hasResolve = prayerDone && journalDone;
    if (hasResolve) {
      var lastR = data.streaks.lastResolveDate;
      var yesterdayR = new Date(); yesterdayR.setDate(yesterdayR.getDate() - 1);
      var yStrR = yesterdayR.toISOString().slice(0,10);
      if (lastR === yStrR || lastR === todayStr) {
        if (lastR !== todayStr) data.streaks.resolve = (data.streaks.resolve || 0) + 1;
      } else {
        data.streaks.resolve = 1;
      }
      data.streaks.lastResolveDate = todayStr;
    }

    /* Log entry */
    var logEntry = {
      date: todayStr,
      sessionType: sessionType,
      deltas: deltas,
      manaGain: manaGain
    };
    data.log.push(logEntry);

    /* Phase 4: detect recovery (first session after absence) */
    var absenceMissed = calcAbsenceDays(data);
    var recoveryTier  = null;
    if (absenceMissed >= 7)      recoveryTier = 3;
    else if (absenceMissed >= 4) recoveryTier = 2;
    else if (absenceMissed >= 2) recoveryTier = 1;
    _pendingRecoveryTier = recoveryTier;

    /* Phase 4: clear the tier 3 drain flag so it doesn't re-apply */
    if (recoveryTier) {
      data.streaks.tier3DrainApplied = false;
    }

    saveData(data);

    /* Phase 4: check for streak milestones */
    checkMilestonesAfterCommit(data);

    /* Show summary — pass recovery tier for flavour override */
    closeLog();
    showSummary(prevStats, data.stats, deltas, sessionType, recoveryTier);
    populateHomeScreen(data);
  }

  /* -- SUMMARY SCREEN --------------------------------------- */
  function showSummary(prevStats, newStats, deltas, sessionType, recoveryTier) {
    var list = document.getElementById('summary-stats-list');
    list.innerHTML = '';

    var statLabels = {
      endurance: 'Endurance', iron: 'Iron', force: 'Force',
      core: 'Core', resolve: 'Resolve', lore: 'Lore'
    };

    var anyChange = false;
    ['endurance','iron','force','core','resolve','lore'].forEach(function(s) {
      var d = deltas[s] || 0;
      if (d <= 0) return;
      anyChange = true;
      var row = document.createElement('div');
      row.className = 'summary-stat-row';
      row.innerHTML =
        '<span class="summary-stat-name">' + statLabels[s] + '</span>' +
        '<div class="summary-stat-change">' +
          '<span class="summary-old">' + prevStats[s].toFixed(1) + '</span>' +
          '<span class="summary-arrow">→</span>' +
          '<span class="summary-new">' + newStats[s].toFixed(1) + '</span>' +
          '<span class="summary-delta">+' + d.toFixed(1) + '</span>' +
        '</div>';
      list.appendChild(row);
    });

    if (!anyChange) {
      var none = document.createElement('div');
      none.style.cssText = 'text-align:center;color:var(--ironstone);font-size:0.8rem;padding:20px 0;';
      none.textContent = 'No stat fields were filled in.';
      list.appendChild(none);
    }

    /* Phase 4: if this is a post-absence session, use recovery passage instead */
    var flavourText;
    if (recoveryTier) {
      flavourText = '"' + (getRecoveryFlavour(recoveryTier) || '') + '"';
    } else {
      flavourText = randomFlavour(sessionType);
    }
    document.getElementById('summary-flavour-text').textContent = flavourText;
    document.getElementById('summaryOverlay').classList.add('visible');
  }

  function closeSummary() {
    document.getElementById('summaryOverlay').classList.remove('visible');
  }

  /* -- Wire "Log Training" button on home screen ------------ */
  document.addEventListener('DOMContentLoaded', function() {
    /* The first action button is Log Training */
    var btns = document.querySelectorAll('.action-btn');
    if (btns[0]) btns[0].addEventListener('click', function() {
      var data = loadData();
      if (data && data.setupComplete) openLog();
    });
  });


  /* ============================================================
     PHASE 4 — STREAK TRACKING & FAILURE STATES
  ============================================================ */

  /* -- Absence tier passages -------------------------------- */
  var ABSENCE_PASSAGES = {
    tier1: "You were not here. The road did not wait. The cold moved in from the east and settled where your fire had been. Two days. Three. The Reaches do not count them with sympathy.",
    tier2: "Five days. The Iron Gate does not move for the man who stopped coming. Whatever you were building in the cold before dawn — it waits, unchanged, for you to return to it. But it does not grow without you.",
    tier3: "A week gone. The Reaches have forgotten your name. Begin again."
  };

  var ABSENCE_RECOVERY = {
    tier1: "You came back. The road is the same road. The cold does not care that you returned — but you returned. That is the only thing that was ever asked.",
    tier2: "Four days gone and now here again. The fire is smaller than it was. You rebuild it the only way it can be rebuilt — one session, one day, one choice at a time.",
    tier3: "A week. You know what it cost. The Reaches know too. There is no ceremony for beginning again — only the beginning. Start."
  };

  /* -- Streak milestone definitions ------------------------ */
  var STREAK_MILESTONES = [
    { days: 7,   icon: '🔥', title: 'Seven Days',
      passage: 'The Reaches have begun to recognise your footprints.' },
    { days: 14,  icon: '⚔️', title: 'Two Weeks',
      passage: 'The habit has roots. Pull it and something will resist.' },
    { days: 30,  icon: '🗡️', title: 'A Month',
      passage: 'This is no longer a decision you make each day. It is who you are becoming.' },
    { days: 50,  icon: '🌑', title: 'Fifty Days',
      passage: 'Most people stopped before now. You did not.' },
    { days: 100, icon: '⚡', title: 'One Hundred Days',
      passage: 'The road behind you is longer than the road ahead to October.' }
  ];

  /* Upcoming races for the 30-day warning in Tier 2 --------- */
  var RACES = [
    { name: 'Trial of the Iron Gate',   date: '2025-05-23', event: 'Spartan 5K Sprint' },
    { name: 'Running of the Ashwood',   date: '2025-06-20', event: 'Trail Run' },
    { name: 'March on Valdenmoor',      date: '2025-09-21', event: 'Spartan 21K Super' },
    { name: 'Reckoning at the Black Spire', date: '2025-10-01', event: 'Trifecta Weekend' }
  ];

  /* -- Helper: days between two date strings ---------------- */
  function daysBetween(dateStrA, dateStrB) {
    var a = new Date(dateStrA);
    var b = new Date(dateStrB);
    a.setHours(0,0,0,0);
    b.setHours(0,0,0,0);
    return Math.round((b - a) / 86400000);
  }

  function todayStr() {
    return new Date().toISOString().slice(0, 10);
  }

  /* -- Calculate training absence in days ------------------- */
  function calcAbsenceDays(data) {
    var last = data.streaks.lastTrainingDate;
    if (!last) return 0;
    var diff = daysBetween(last, todayStr());
    return diff > 0 ? diff : 0;
  }

  /* -- Get nearest upcoming race within 30 days ------------ */
  function nearRaceWarning() {
    var today = todayStr();
    for (var i = 0; i < RACES.length; i++) {
      var r = RACES[i];
      var d = daysBetween(today, r.date);
      if (d >= 0 && d <= 30) return r;
    }
    return null;
  }

  /* -- Apply Tier 3 mana drain ------------------------------- */
  function applyManaDrain(data) {
    if (!data.streaks.tier3DrainApplied) {
      data.character.mana = Math.floor((data.character.mana || 0) * 0.5);
      data.streaks.tier3DrainApplied = true;
      saveData(data);
    }
  }

  /* -- Show absence overlay ---------------------------------- */
  function showAbsence(tier, missedDays, data) {
    /* Tier pips */
    for (var t = 1; t <= 3; t++) {
      var pip = document.getElementById('tier-pip-' + t);
      pip.classList.toggle('lit', t <= tier);
    }

    /* Eyebrow */
    var eyebrows = {1: 'The Road Goes Cold', 2: 'The Reaches Remember', 3: 'Forgotten'};
    document.getElementById('absence-eyebrow').textContent = eyebrows[tier] || 'The Road Goes Cold';

    /* Days callout */
    document.getElementById('absence-days-number').textContent = missedDays;
    document.getElementById('absence-days-label').textContent  =
      missedDays === 1 ? 'day since your last session' : 'days since your last session';

    /* Passage */
    var passageKey = 'tier' + tier;
    document.getElementById('absence-passage-text').textContent =
      ABSENCE_PASSAGES[passageKey] || ABSENCE_PASSAGES.tier1;

    /* Freeze notice for Tier 2+ */
    document.getElementById('absence-freeze-notice').style.display = (tier >= 2) ? 'inline-block' : 'none';

    /* Mana drain notice for Tier 3 */
    document.getElementById('absence-mana-notice').style.display = (tier >= 3) ? 'inline-block' : 'none';

    /* Race warning for Tier 2+ if race within 30 days */
    var raceWarn = document.getElementById('absence-race-warning');
    if (tier >= 2) {
      var near = nearRaceWarning();
      if (near) {
        var daysLeft = daysBetween(todayStr(), near.date);
        raceWarn.style.display = 'block';
        raceWarn.innerHTML =
          '<strong>' + near.name + '</strong> is ' + daysLeft +
          ' days away. The ' + near.event + ' does not move for anyone.';
      } else {
        raceWarn.style.display = 'none';
      }
    } else {
      raceWarn.style.display = 'none';
    }

    /* Button text for Tier 3 */
    if (tier >= 3) {
      document.getElementById('absence-ack-btn').textContent = 'Begin again.';
    } else {
      document.getElementById('absence-ack-btn').textContent = 'I hear it. Begin again.';
    }

    document.getElementById('absenceOverlay').classList.add('visible');
  }

  /* -- Dismiss absence overlay ------------------------------- */
  function dismissAbsence() {
    document.getElementById('absenceOverlay').classList.remove('visible');
    /* Mark that the absence message has been seen for today */
    var data = loadData();
    if (data) {
      data.streaks.lastAbsenceSeenDate = todayStr();
      /* Clear the Tier 3 drain flag once acknowledged so it doesn't re-drain */
      /* (flag stays set — just cleared from pending display) */
      saveData(data);
    }
  }

  /* -- Show streak milestone overlay ------------------------ */
  function showMilestone(streak, streakLabel) {
    var milestone = null;
    for (var i = STREAK_MILESTONES.length - 1; i >= 0; i--) {
      if (streak === STREAK_MILESTONES[i].days) {
        milestone = STREAK_MILESTONES[i];
        break;
      }
    }
    if (!milestone) return;

    document.getElementById('milestone-icon').textContent    = milestone.icon;
    document.getElementById('milestone-number').textContent  = streak;
    document.getElementById('milestone-label').textContent   = streakLabel + ' Streak';
    document.getElementById('milestone-title').textContent   = milestone.title;
    document.getElementById('milestone-passage').textContent = '"' + milestone.passage + '"';
    document.getElementById('milestoneOverlay').classList.add('visible');
  }

  function dismissMilestone() {
    document.getElementById('milestoneOverlay').classList.remove('visible');
  }

  /* -- Recovery flavour — shown in stat summary after absence - */
  function getRecoveryFlavour(tier) {
    if (!tier) return null;
    return ABSENCE_RECOVERY['tier' + tier] || null;
  }

  /* -- Core login check — called from init() ----------------- */
  function checkAbsenceOnLogin(data) {
    var today = todayStr();

    /* Don't show if already acknowledged today */
    if (data.streaks.lastAbsenceSeenDate === today) return;

    var missed = calcAbsenceDays(data);

    /* Tier 0: 0-1 days — no action */
    if (missed <= 1) return;

    /* Tier 1: 2–3 days */
    if (missed >= 2 && missed <= 3) {
      /* Reset training streak */
      data.streaks.training = 0;
      saveData(data);
      showAbsence(1, missed, data);
      return;
    }

    /* Tier 2: 4–6 days */
    if (missed >= 4 && missed <= 6) {
      data.streaks.training = 0;
      saveData(data);
      showAbsence(2, missed, data);
      return;
    }

    /* Tier 3: 7+ days */
    if (missed >= 7) {
      data.streaks.training = 0;
      applyManaDrain(data);
      showAbsence(3, missed, data);
      return;
    }
  }

  /* -- Resolve streak check ---------------------------------- */
  function checkResolveStreak(data) {
    var today = todayStr();
    var last  = data.streaks.lastResolveDate;
    if (!last) return;
    var missed = daysBetween(last, today);
    /* Resolve streak resets on first missed day */
    if (missed >= 2) {
      data.streaks.resolve = 0;
      saveData(data);
    }
  }

  /* -- Restoration streak check ------------------------------ */
  function checkRestorationStreak(data) {
    /* Restoration is weekly — check if last week's Sunday was missed */
    var lastWeek = data.streaks.lastRestorationWeek;
    if (!lastWeek) return;
    var today    = new Date(); today.setHours(0,0,0,0);
    var lastDate = new Date(lastWeek);
    var weekDiff = Math.floor((today - lastDate) / (7 * 86400000));
    if (weekDiff >= 2) {
      /* Missed at least one Sunday — reset */
      data.streaks.restoration = 0;
      saveData(data);
    }
  }

  /* -- Check for milestone after a commit ------------------- */
  function checkMilestonesAfterCommit(data) {
    var trainingStreak = data.streaks.training || 0;
    var resolveStreak  = data.streaks.resolve  || 0;

    /* Check training milestones */
    for (var i = 0; i < STREAK_MILESTONES.length; i++) {
      if (trainingStreak === STREAK_MILESTONES[i].days) {
        showMilestone(trainingStreak, 'Training');
        return; /* Show one at a time */
      }
    }
    /* Check resolve milestones */
    for (var j = 0; j < STREAK_MILESTONES.length; j++) {
      if (resolveStreak === STREAK_MILESTONES[j].days) {
        showMilestone(resolveStreak, 'Resolve');
        return;
      }
    }
  }

  /* -- Store which absence tier was active before recovery --- */
  var _pendingRecoveryTier = null;



  /* ============================================================
     PHASE 5 — COMBAT ENGINE
  ============================================================ */

  /* -- Monster roster --------------------------------------- */
  var MONSTERS = [
    /* -- Tier 1 -- */
    { id:'ash_hound',    tier:1, name:'The Ash Hound',   hp:30,  xp:50,  dmgMin:6,  dmgMax:10, portrait:'🐺',
      desc:'A gaunt grey dog with hollow eyes, fur matted with road dust. Moves in short bursts, retreats when struck hard.',
      special: null },
    { id:'barrow_rat',   tier:1, name:'Barrow Rat',      hp:20,  xp:35,  dmgMin:4,  dmgMax:7,  portrait:'🐀',
      desc:'A large rodent the size of a small dog, grey-furred and red-eyed. Attacks in quick darts. Easier prey than it looks.',
      special: null },
    { id:'drifter',      tier:1, name:'Reaches Drifter', hp:35,  xp:50,  dmgMin:7,  dmgMax:11, portrait:'🧟',
      desc:'A wandering vagrant turned feral. Fights with a broken bottle. No tactics, just desperation and dirt.',
      special: null },
    { id:'fog_crow',     tier:1, name:'Fog Crow',        hp:25,  xp:40,  dmgMin:5,  dmgMax:8,  portrait:'🐦',
      desc:'An oversized black bird with reflective eyes. Attacks twice on its second round, then retreats to observe.',
      special: { type:'double_strike', triggerRound:2 } },

    /* -- Tier 2 -- */
    { id:'marshwalker',  tier:2, name:'Marshwalker',     hp:50,  xp:80,  dmgMin:9,  dmgMax:14, portrait:'👣',
      desc:'A pale figure that moves through low ground without sound. Heals itself partway through the fight.',
      special: { type:'heal', triggerRound:3, amount:10 } },
    { id:'hollow_knight',tier:2, name:'The Hollow Knight',hp:55, xp:90,  dmgMin:10, dmgMax:15, portrait:'🛡',
      desc:'A dead soldier in rusted mail who does not feel pain. Slow but hits with mechanical precision.',
      special: { type:'damage_reduction', flat:3 } },
    { id:'ironwood',     tier:2, name:'Ironwood Stalker', hp:45, xp:75,  dmgMin:8,  dmgMax:13, portrait:'🌲',
      desc:'A territorial creature with bark-coloured hide that ambushes rather than chases. Predictable if you have read animals.',
      special: { type:'surge', triggerRound:4, multiplier:1.5 } },
    { id:'candle_wraith', tier:2, name:'Candle Wraith',  hp:40,  xp:85,  dmgMin:4,  dmgMax:18, portrait:'🕯',
      desc:'A flickering presence that alternates between near-absence and sudden violence. Time your Endure on the heavy rounds.',
      special: { type:'alternating', lightDmg:4, heavyDmg:18 } },

    /* -- Tier 3 -- (available at level 4+) */
    { id:'grey_reaver',  tier:3, name:'The Grey Reaver', hp:80,  xp:130, dmgMin:13, dmgMax:19, portrait:'⚔️',
      desc:'A scarred mercenary who has survived too many fights. Gets more dangerous the longer combat continues.',
      special: { type:'escalating_rage', startRound:5, bonusPerRound:4 } },
    { id:'thornback',    tier:3, name:'Thornback',       hp:70,  xp:120, dmgMin:12, dmgMax:17, portrait:'🦔',
      desc:'A creature with a ridged carapace that makes direct assault costly. Punishes Strike spam.',
      special: { type:'reflect', reflectDmg:3 } },
    { id:'warden_pass',  tier:3, name:'Warden of the Pass',hp:90,xp:140, dmgMin:14, dmgMax:20, portrait:'🗿',
      desc:'A disciplined guardian who fights with military patience. The shield round forces you to plan around one wasted turn.',
      special: { type:'shield_round', triggerRound:2 } },
    { id:'ashfield_rev', tier:3, name:'Ashfield Revenant',hp:75,xp:135, dmgMin:12, dmgMax:18, portrait:'💀',
      desc:'A resurrected soldier that ironically rewards the player who can land a massive single hit.',
      special: { type:'stun_on_big_hit', threshold:30 } },

    /* -- Tier 4 -- (available at level 6+) */
    { id:'iron_widow',   tier:4, name:'The Iron Widow',  hp:120, xp:200, dmgMin:17, dmgMax:24, portrait:'🕷',
      desc:'A huntress with wire-wrapped hands who fights without expression. The poison is the test.',
      special: { type:'poison', triggerRound:3, dmgPerRound:5, duration:3 } },
    { id:'veldrath',     tier:4, name:'Veldrath the Unyielding',hp:130,xp:220,dmgMin:18,dmgMax:25,portrait:'👹',
      desc:'An enormous scarred figure who becomes twice as dangerous when wounded.',
      special: { type:'enrage_below_hp', threshold:40, doublesAttacks:true } },
    { id:'executioner',  tier:4, name:"The Court's Executioner",hp:110,xp:210,dmgMin:20,dmgMax:27,portrait:'🪓',
      desc:'The opening blow is unavoidable. The rest of the fight is the character answering it.',
      special: { type:'guaranteed_open', openDmg:30 } },
    { id:'nightcaller',  tier:4, name:'Nightcaller',     hp:100, xp:215, dmgMin:15, dmgMax:22, portrait:'🌑',
      desc:'A shadowy opponent who learns your patterns. Forces variety — you cannot spam a single ability.',
      special: { type:'stun_repeat_action' } },

    /* -- Tier 5 -- (available at level 6, escalation only) */
    { id:'pale_commander',tier:5,name:'The Pale Commander',hp:170,xp:320,dmgMin:22,dmgMax:30,portrait:'👑',
      desc:'A cold tactician who never fights alone. The summoned Ash Hound forces you to split attention.',
      special: { type:'summon', triggerRound:4, summonId:'ash_hound' } },
    { id:'void_soldier',  tier:5,name:'Void-Touched Soldier',hp:160,xp:300,dmgMin:20,dmgMax:28,portrait:'🌀',
      desc:'The Mana drain is the mechanic. Forces return to basics under pressure.',
      special: { type:'mana_drain', drainPerRound:8 } },
    { id:'last_warden',   tier:5,name:'The Last Warden',  hp:180,xp:350,dmgMin:23,dmgMax:32,portrait:'🏰',
      desc:'A legendary defender of a fallen keep. The phase transition resets the fight halfway through.',
      special: { type:'two_phase', phaseHp:90 } },
    { id:'mireborn',      tier:5,name:'Mireborn Ancient', hp:200,xp:400,dmgMin:25,dmgMax:35,portrait:'🐉',
      desc:'A creature old enough to have seen the Reaches before they were broken. Only raw stats and active abilities survive.',
      special: { type:'ignore_passive_reduction' } }
  ];

  /* -- Encounter atmospheric scenes ------------------------ */
  var ENCOUNTER_SCENES = [
    'The road narrows here. Something moves in the grey ahead.',
    'A shape detaches itself from the fog. It has noticed you.',
    'The cold deepens. Whatever is ahead has been waiting.',
    'You have seen its kind before. That does not make it easier.',
    'The silence before this kind of thing always feels the same.',
    'Something has been following the road. Now it has stopped.',
    'The light does not reach as far as it should here.',
    'You came looking. You found.'
  ];

  /* -- Victory / defeat passages ---------------------------- */
  var VICTORY_PASSAGES = [
    'It is down. You are still standing. That is the difference.',
    'The road is clear again — for now.',
    'Whatever it was, it is not a threat anymore.',
    'You did not come out of that unscathed. But you came out.',
    'The Reaches took note. Not with praise. Just note.'
  ];

  var DEFEAT_PASSAGES = [
    'The ground is closer than you expected. The fight is over.',
    'Not everything out here loses to you. Today you learned that.',
    'It was stronger than you were ready for. Come back better.',
    'The road will still be here tomorrow. So will you, barely.',
    'Defeat is information. Use it.'
  ];

  /* -- Combat state ----------------------------------------- */
  var CS = {
    active:      false,
    monster:     null,
    monsterHp:   0,
    playerHp:    0,
    playerMaxHp: 0,
    mana:        0,
    maxMana:     0,
    round:       1,
    readBonus:   false,
    enduring:    false,
    poisonRounds:0,
    poisonDmg:   0,
    stunned:     false,
    playerStunned: false,
    lastAction:  null,
    enraged:     false,
    phase2:      false,
    openingDone: false,
    encountersToday: 0,
    injuredToday: false,
    ventureBlocked: false,
    /* Phase 7 — ability tracking */
    ownedAbilities:   [],     /* ability objects for owned abilities */
    secondWindUsed:   false,  /* once per encounter */
    steadfastUsed:    false,  /* once per encounter */
    specialImmunity:  false,  /* Ironclad: used flag */
    monsterDebuffRounds: 0,   /* Knowing Strike debuff remaining rounds */
    monsterDebuffPct: 0,      /* fraction by which monster damage is reduced */
    lastAbilityUsed:  null,   /* for Crusher consecutive block */
    wordOfSourceDate: null,   /* date string — once per day */
    rootedThisRound:  false,  /* Rooted -50% */
    deadStillThisRound: false /* Dead Still -75% */
  };

  /* -- D20 roll ---------------------------------------------- */
  function d20() { return Math.floor(Math.random() * 20) + 1; }
  function randBetween(min, max) { return Math.floor(Math.random() * (max - min + 1)) + min; }

  /* -- Select appropriate monster --------------------------- */
  function selectMonster(data) {
    var level = data.character.level || 1;
    /* Tier availability per level */
    var maxTier = level >= 6 ? 5 : level >= 4 ? 3 : level >= 2 ? 2 : 1;

    /* Escalation: each victory today pushes tier up by 1 */
    var escalation = CS.encountersToday;
    var targetTier = Math.min(5, Math.max(1, maxTier - (maxTier - 1) + escalation));
    /* Simpler: base = 1, escalation adds tiers, cap at maxTier */
    targetTier = Math.min(maxTier, 1 + escalation);

    var pool = MONSTERS.filter(function(m) { return m.tier === targetTier; });
    if (!pool.length) pool = MONSTERS.filter(function(m) { return m.tier === 1; });
    return pool[Math.floor(Math.random() * pool.length)];
  }

  /* -- Open Venture Out (encounter preview) --------------- */
  function openVentureOut() {
    var data = loadData();
    if (!data) return;

    /* Check if blocked from injury */
    if (data.combat && data.combat.ventureBlockedDate === new Date().toISOString().slice(0,10)) {
      addCombatLog('Venture Out is unavailable today. Return tomorrow.', 'system-note');
      return;
    }

    /* Ensure combat state exists on data */
    if (!data.combat) {
      data.combat = { ventureBlockedDate: null, encountersToday: 0, lastEncounterDate: null };
    }

    /* Reset daily counter if new day */
    var today = new Date().toISOString().slice(0,10);
    if (data.combat.lastEncounterDate !== today) {
      data.combat.encountersToday = 0;
      data.combat.lastEncounterDate = today;
    }

    CS.encountersToday = data.combat.encountersToday || 0;

    var monster = selectMonster(data);
    CS.monster = monster;

    /* Populate encounter preview */
    var scene = ENCOUNTER_SCENES[Math.floor(Math.random() * ENCOUNTER_SCENES.length)];
    document.getElementById('encounter-scene-text').textContent = scene;
    document.getElementById('encounter-portrait').textContent   = monster.portrait;
    document.getElementById('encounter-tier-label').textContent = 'Tier ' + monster.tier;
    document.getElementById('encounter-name').textContent       = monster.name;
    document.getElementById('encounter-desc').textContent       = monster.desc;
    document.getElementById('encounter-hp').textContent         = monster.hp;
    document.getElementById('encounter-dmg').textContent        = monster.dmgMin + '–' + monster.dmgMax;
    document.getElementById('encounter-xp').textContent         = monster.xp + ' XP';

    document.getElementById('encounterOverlay').classList.add('visible');
  }

  function withdrawEncounter() {
    document.getElementById('encounterOverlay').classList.remove('visible');
  }

  /* -- Start combat ------------------------------------------ */
  function startCombat() {
    var data = loadData();
    if (!data) return;

    document.getElementById('encounterOverlay').classList.remove('visible');

    /* Init combat state */
    var level   = data.character.level || 1;
    var coreStat = data.stats.core || 0;
    var maxHp   = (level * 10) + Math.floor(coreStat / 10 * 5) + 40;
    var curHp   = data.character.hp != null ? data.character.hp : maxHp;
    /* Use current HP — doesn't restore between combats until day reset */

    var resolveStat = data.stats.resolve || 0;
    var maxMana  = 30 + Math.floor(resolveStat / 10 * 5) + (level * 3);
    var curMana  = data.character.mana || 0;

    CS.active       = true;
    CS.monsterHp    = CS.monster.hp;
    CS.playerHp     = curHp;
    CS.playerMaxHp  = maxHp;
    CS.mana         = curMana;
    CS.maxMana      = maxMana;
    CS.round        = 1;
    CS.readBonus    = false;
    CS.enduring     = false;
    CS.poisonRounds = 0;
    CS.poisonDmg    = 0;
    CS.stunned      = false;
    CS.playerStunned = false;
    CS.lastAction   = null;
    CS.enraged      = false;
    CS.phase2       = false;
    CS.openingDone  = false;

    /* Executioner guaranteed opening blow */
    if (CS.monster.special && CS.monster.special.type === 'guaranteed_open') {
      CS.openingDone = false;
    }

    /* Phase 7: load owned abilities and reset per-encounter limits */
    var ownedIds = (data.abilities && data.abilities.owned) || [];
    CS.ownedAbilities    = ABILITIES.filter(function(a) { return ownedIds.indexOf(a.id) !== -1; });
    CS.secondWindUsed    = false;
    CS.steadfastUsed     = false;
    CS.specialImmunity   = ownedIds.indexOf('ironclad') !== -1;
    CS.monsterDebuffRounds = 0;
    CS.monsterDebuffPct  = 0;
    CS.lastAbilityUsed   = null;
    CS.rootedThisRound   = false;
    CS.deadStillThisRound = false;

    /* Check Word of the Source once-per-day limit */
    var today = new Date().toISOString().slice(0,10);
    CS.wordOfSourceDate  = (data.abilities && data.abilities.wordOfSourceDate === today) ? today : null;

    /* Populate combat UI */
    document.getElementById('combat-round-num').textContent      = 1;
    document.getElementById('combat-player-name').textContent    = data.warrior.name;
    document.getElementById('combat-monster-name').textContent   = CS.monster.name;
    document.getElementById('combat-monster-tier-label').textContent = 'Tier ' + CS.monster.tier;
    document.getElementById('combat-monster-portrait').textContent = CS.monster.portrait;

    updateCombatBars();
    renderCombatManaPips();

    var logEl = document.getElementById('combat-log');
    logEl.innerHTML = '';
    addCombatLog('You face ' + CS.monster.name + '. The road narrows.', 'system-note');

    renderAbilityButtons();
    enableCombatButtons();
    document.getElementById('combatOverlay').classList.add('visible');
  }

  /* -- Update HP bars ---------------------------------------- */
  function updateCombatBars() {
    var pPct = Math.max(0, Math.round(CS.playerHp / CS.playerMaxHp * 100));
    var mPct = Math.max(0, Math.round(CS.monsterHp / CS.monster.hp * 100));

    document.getElementById('combat-player-hp').textContent = Math.max(0, CS.playerHp);
    document.getElementById('combat-player-maxhp').textContent = CS.playerMaxHp;
    document.getElementById('combat-monster-hp').textContent = Math.max(0, CS.monsterHp);
    document.getElementById('combat-monster-maxhp').textContent = CS.monster.hp;

    var pBar = document.getElementById('combat-player-hp-bar');
    pBar.style.width = pPct + '%';
    pBar.classList.toggle('danger', pPct <= 25);

    document.getElementById('combat-monster-hp-bar').style.width = mPct + '%';
  }

  function renderCombatManaPips() {
    var container = document.getElementById('combat-mana-pips');
    container.innerHTML = '';
    var show = Math.min(CS.maxMana, 33); /* show up to 33 pips */
    for (var i = 0; i < show; i++) {
      var pip = document.createElement('div');
      pip.className = 'combat-mana-pip' + (i < CS.mana ? ' filled' : '');
      container.appendChild(pip);
    }
  }

  /* -- Combat log helper -------------------------------------- */
  function addCombatLog(text, cls) {
    var logEl = document.getElementById('combat-log');
    var line  = document.createElement('div');
    line.className = 'combat-log-line' + (cls ? ' ' + cls : '');
    line.textContent = text;
    logEl.appendChild(line);
    logEl.scrollTop = logEl.scrollHeight;
  }

  /* -- Enable / disable action buttons ----------------------- */
  function enableCombatButtons() {
    ['strike','endure','read'].forEach(function(a) {
      document.getElementById('btn-' + a).disabled = false;
    });
    document.getElementById('btn-strike').classList.toggle('primed', CS.readBonus);
    /* Phase 7: enable active ability buttons */
    document.querySelectorAll('.combat-ability-btn').forEach(function(btn) {
      var id   = btn.getAttribute('data-ability-id');
      var cost = parseInt(btn.getAttribute('data-mana-cost'), 10) || 0;
      var ab   = ABILITIES.find(function(a) { return a.id === id; });
      var unavailable = false;
      if (cost > CS.mana)                                         unavailable = true;
      if (id === 'second_wind'   && CS.secondWindUsed)            unavailable = true;
      if (id === 'steadfast'     && CS.steadfastUsed)             unavailable = true;
      if (id === 'crusher'       && CS.lastAbilityUsed === 'crusher') unavailable = true;
      if (id === 'word_of_source' && CS.wordOfSourceDate)         unavailable = true;
      btn.disabled = unavailable;
      btn.classList.toggle('primed', !unavailable && id === CS.lastAbilityUsed + '_ready');
    });
  }

  function disableCombatButtons() {
    ['strike','endure','read'].forEach(function(a) {
      document.getElementById('btn-' + a).disabled = true;
    });
    document.querySelectorAll('.combat-ability-btn').forEach(function(btn) {
      btn.disabled = true;
    });
  }

  /* -- Render owned active ability buttons into combat footer -- */
  function renderAbilityButtons() {
    var footer = document.getElementById('combat-footer');
    /* Remove any previously rendered ability buttons */
    footer.querySelectorAll('.combat-ability-btn').forEach(function(b) { b.remove(); });

    CS.ownedAbilities.forEach(function(ab) {
      if (ab.type !== 'active') return;
      var btn = document.createElement('button');
      btn.className = 'combat-action-btn combat-ability-btn';
      btn.setAttribute('data-ability-id', ab.id);
      btn.setAttribute('data-mana-cost', ab.cost);
      btn.innerHTML =
        ab.name +
        '<span class="btn-cost">' + ab.costLabel + ' · ' + ab.branch.charAt(0).toUpperCase() + ab.branch.slice(1) + '</span>';
      btn.onclick = function() { combatAbilityAction(ab.id); };
      footer.appendChild(btn);
    });
  }

  /* -- Calculate player damage (Strike) --------------------- */
  function calcPlayerDamage(data, multiplier) {
    multiplier = multiplier || 1;
    var force = data.stats.force || 0;
    var roll  = d20();
    var base  = 5 + Math.floor(force / 10 * 5);
    var mod   = roll >= 15 ? 4 : roll <= 5 ? -2 : 0;
    var dmg   = Math.max(1, base + mod);
    if (CS.readBonus) { dmg = Math.round(dmg * 1.3); }

    /* Phase 7 passives: Clubber +10% */
    if (hasAbility('clubber')) { dmg = Math.round(dmg * 1.10); }

    /* Phase 7 passives: Grinding Pace +5% per round beyond 3 */
    if (hasAbility('grinding_pace') && CS.round > 3) {
      var gpBonus = 1 + ((CS.round - 3) * 0.05);
      dmg = Math.round(dmg * gpBonus);
    }

    /* Apply ability multiplier (for active ability strikes) */
    dmg = Math.round(dmg * multiplier);

    /* Hollow Knight flat reduction */
    if (CS.monster.special && CS.monster.special.type === 'damage_reduction') {
      /* Ironclad immunity check */
      if (CS.specialImmunity) {
        addCombatLog('Ironclad: special attack ignored.', 'system-note');
        CS.specialImmunity = false;
      } else {
        dmg = Math.max(1, dmg - CS.monster.special.flat);
      }
    }

    /* Mireborn Ancient ignores passive damage reduction */
    var mireborn = CS.monster.id === 'mireborn';
    if (!mireborn) {
      /* Iron Grip passive 5% reduction already handled in incoming calc */
    }

    /* Thornback reflect */
    if (CS.monster.special && CS.monster.special.type === 'reflect') {
      CS.playerHp -= CS.monster.special.reflectDmg;
      addCombatLog('The carapace reflects ' + CS.monster.special.reflectDmg + ' damage back at you.', 'monster-action');
    }

    return { dmg: dmg, roll: roll };
  }

  /* -- Helper: does player own this ability? ------------------- */
  function hasAbility(id) {
    return CS.ownedAbilities.some(function(a) { return a.id === id; });
  }

  /* -- Calculate monster damage ------------------------------ */
  function calcMonsterDamage() {
    var m   = CS.monster;
    var dmg = randBetween(m.dmgMin, m.dmgMax);

    /* Endure base reduction */
    if (CS.enduring) {
      dmg = Math.max(1, Math.round(dmg * 0.55));
    }

    /* Phase 7: Rooted (-50%) */
    if (CS.rootedThisRound) {
      dmg = Math.max(1, Math.round(dmg * 0.50));
      CS.rootedThisRound = false;
    }

    /* Phase 7: Dead Still (-75%) */
    if (CS.deadStillThisRound) {
      dmg = Math.max(1, Math.round(dmg * 0.25));
      CS.deadStillThisRound = false;
    }

    /* Phase 7: Knowing Strike debuff */
    if (CS.monsterDebuffRounds > 0) {
      dmg = Math.max(1, Math.round(dmg * (1 - CS.monsterDebuffPct)));
      CS.monsterDebuffRounds--;
    }

    /* Surge (Ironwood Stalker round 4) */
    if (m.special && m.special.type === 'surge' && CS.round === m.special.triggerRound) {
      dmg = Math.round(dmg * m.special.multiplier);
      addCombatLog(m.name + ' surges — damage amplified this round!', 'monster-action');
    }

    /* Alternating (Candle Wraith) */
    if (m.special && m.special.type === 'alternating') {
      dmg = (CS.round % 2 === 0) ? m.special.heavyDmg : m.special.lightDmg;
      if (CS.enduring && CS.round % 2 === 0) dmg = Math.max(1, Math.round(dmg * 0.55));
    }

    /* Escalating rage (Grey Reaver) */
    if (m.special && m.special.type === 'escalating_rage' && CS.round >= m.special.startRound) {
      var bonus = (CS.round - m.special.startRound + 1) * m.special.bonusPerRound;
      dmg += bonus;
    }

    /* Enraged Veldrath (below threshold HP) */
    if (CS.enraged) { dmg = dmg * 2; }

    /* Shield round (Warden) — no damage to player when monster is shielding */
    if (m.special && m.special.type === 'shield_round' && CS.round === m.special.triggerRound) {
      addCombatLog(m.name + ' raises its shield — you cannot damage it this round.', 'monster-action');
      return -1; /* flag: monster blocks player this round but also does no damage */
    }

    return dmg;
  }

  /* -- Main combat action handler ---------------------------- */
  function combatAction(action) {
    if (!CS.active) return;
    var data = loadData();
    if (!data) return;

    disableCombatButtons();

    /* Nightcaller stun on repeated action */
    if (CS.monster.id === 'nightcaller' && CS.lastAction === action) {
      CS.playerStunned = true;
      addCombatLog(CS.monster.name + ' anticipated your pattern. You are stunned for this round.', 'monster-action');
    }

    CS.lastAction = action;
    CS.enduring   = false;
    CS.readBonus  = false;

    /* -- Player turn -- */
    if (!CS.playerStunned) {
      if (action === 'strike') {
        var result = calcPlayerDamage(data);
        /* Shield round blocks damage */
        if (CS.monster.special && CS.monster.special.type === 'shield_round' && CS.round === CS.monster.special.triggerRound) {
          addCombatLog('Your strike glances off the raised shield. No damage.', 'player-action');
        } else if (!CS.stunned) {
          CS.monsterHp -= result.dmg;
          var hitVerb = result.roll >= 15 ? 'lands hard' : result.roll <= 5 ? 'grazes' : 'connects';
          addCombatLog('You strike — the blow ' + hitVerb + ' for ' + result.dmg + ' damage. (Roll: ' + result.roll + ')', 'player-action');

          /* Animate monster */
          var portrait = document.getElementById('combat-monster-portrait');
          portrait.classList.remove('struck');
          void portrait.offsetWidth;
          portrait.classList.add('struck');

          /* Ashfield Revenant — stun self on big hit */
          if (CS.monster.special && CS.monster.special.type === 'stun_on_big_hit' && result.dmg >= CS.monster.special.threshold) {
            CS.stunned = true;
            addCombatLog(CS.monster.name + ' staggers — stunned for one round from the heavy blow.', 'system-note');
          }

          /* Last Warden phase 2 transition */
          if (CS.monster.id === 'last_warden' && !CS.phase2 && CS.monsterHp <= CS.monster.special.phaseHp) {
            CS.phase2   = true;
            CS.monsterHp = CS.monster.special.phaseHp; /* full heal to phase 2 HP */
            addCombatLog('The Last Warden rises again — Phase 2 begins. Full HP restored to ' + CS.monster.special.phaseHp + '.', 'system-note');
          }
        } else {
          addCombatLog('The monster is stunned — your strike connects freely for ' + result.dmg + ' damage.', 'player-action');
          CS.monsterHp -= result.dmg;
          CS.stunned = false;
        }

      } else if (action === 'endure') {
        CS.enduring = true;
        addCombatLog('You brace and endure — incoming damage reduced this round.', 'player-action');

      } else if (action === 'read') {
        CS.readBonus = true;
        addCombatLog('You read the enemy — accuracy bonus applied to your next Strike.', 'player-action');
      }
    } else {
      CS.playerStunned = false;
    }

    updateCombatBars();

    /* Check monster death */
    if (CS.monsterHp <= 0) {
      resolveVictory(data);
      return;
    }

    /* -- Monster turn -- */
    setTimeout(function() {
      executeMonsterTurn(data);
    }, 600);
  }

  /* -- Monster turn -------------------------------------------- */
  function executeMonsterTurn(data) {
    var m = CS.monster;

    /* Marshwalker heal */
    if (m.special && m.special.type === 'heal' && CS.round === m.special.triggerRound) {
      CS.monsterHp = Math.min(m.hp, CS.monsterHp + m.special.amount);
      addCombatLog(m.name + ' recovers — HP restored by ' + m.special.amount + '.', 'monster-action');
      updateCombatBars();
    }

    /* Fog Crow double strike round 2 */
    if (m.special && m.special.type === 'double_strike' && CS.round === m.special.triggerRound) {
      var dmg1 = randBetween(m.dmgMin, m.dmgMax);
      var dmg2 = randBetween(m.dmgMin, m.dmgMax);
      if (CS.enduring) { dmg1 = Math.max(1, Math.round(dmg1 * 0.55)); dmg2 = Math.max(1, Math.round(dmg2 * 0.55)); }
      CS.playerHp -= (dmg1 + dmg2);
      addCombatLog(m.name + ' strikes twice — ' + dmg1 + ' and ' + dmg2 + ' damage.', 'monster-action');
    } else {
      /* Standard monster attack */
      var monDmg = calcMonsterDamage();

      /* Executioner guaranteed open on round 1 */
      if (m.special && m.special.type === 'guaranteed_open' && !CS.openingDone) {
        monDmg = m.special.openDmg;
        CS.openingDone = true;
        addCombatLog(m.name + ' opens with a guaranteed ' + monDmg + '-damage strike — unavoidable.', 'monster-action');
      }

      if (monDmg === -1) {
        /* Shield round: monster defended — no damage */
      } else if (monDmg > 0) {
        /* Phase 7 passive incoming reducers (Mireborn ignores passive reduction) */
        var mireborn = CS.monster.id === 'mireborn';
        var rawDmg = monDmg;
        if (!mireborn) {
          /* Iron Grip: -5% */
          if (hasAbility('iron_grip'))  { monDmg = Math.max(1, Math.round(monDmg * 0.95)); }
          /* Ironbelly: flat -3 */
          if (hasAbility('ironbelly'))  { monDmg = Math.max(1, monDmg - 3); }
          /* The Long Road: HP cannot drop below 5 from single hit */
          if (hasAbility('the_long_road') && CS.playerHp - monDmg < 5) {
            monDmg = Math.max(0, CS.playerHp - 5);
            addCombatLog('The Long Road holds — damage capped to prevent dropping below 5 HP.', 'system-note');
          }
        }

        /* Steadfast: auto-resist when HP drops below 20% */
        var hpAfter = CS.playerHp - monDmg;
        if (!CS.steadfastUsed && hasAbility('steadfast') && hpAfter / CS.playerMaxHp < 0.20) {
          CS.steadfastUsed = true;
          monDmg = 0;
          addCombatLog('Steadfast: the attack is resisted — HP below 20%.', 'system-note');
        }

        CS.playerHp -= monDmg;
        var playerPortrait = document.getElementById('combat-player-portrait');
        playerPortrait.classList.remove('struck');
        void playerPortrait.offsetWidth;
        playerPortrait.classList.add('struck');
        var dmgNote = (monDmg < rawDmg && rawDmg > 0) ? ' (' + rawDmg + ' → ' + monDmg + ' after passives)' : '';
        addCombatLog(m.name + ' attacks for ' + monDmg + ' damage.' + dmgNote, 'monster-action');
      }
    }

    /* Poison tick */
    if (CS.poisonRounds > 0) {
      CS.playerHp -= CS.poisonDmg;
      CS.poisonRounds--;
      addCombatLog('Poison burns for ' + CS.poisonDmg + ' damage. (' + CS.poisonRounds + ' rounds remaining)', 'monster-action');
    }

    /* Iron Widow — apply poison on trigger round */
    if (m.special && m.special.type === 'poison' && CS.round === m.special.triggerRound && CS.poisonRounds === 0) {
      CS.poisonRounds = m.special.duration;
      CS.poisonDmg    = m.special.dmgPerRound;
      addCombatLog(m.name + ' poisons you — ' + CS.poisonDmg + ' damage per round for ' + CS.poisonRounds + ' rounds.', 'monster-action');
    }

    /* Void-Touched Soldier — drain mana per round */
    if (m.special && m.special.type === 'mana_drain') {
      var drain = Math.min(CS.mana, m.special.drainPerRound);
      CS.mana  = Math.max(0, CS.mana - drain);
      renderCombatManaPips();
      if (drain > 0) addCombatLog(m.name + ' drains ' + drain + ' Mana.', 'monster-action');
    }

    /* Veldrath enrage check */
    if (m.id === 'veldrath' && !CS.enraged && CS.monsterHp <= m.special.threshold) {
      CS.enraged = true;
      addCombatLog('Veldrath roars — enraged below ' + m.special.threshold + ' HP. Damage doubled!', 'monster-action');
    }

    updateCombatBars();
    renderCombatManaPips();

    /* Check player death */
    if (CS.playerHp <= 0) {
      resolveDefeat(data);
      return;
    }

    /* Next round */
    CS.round++;
    document.getElementById('combat-round-num').textContent = CS.round;
    enableCombatButtons();
  }

  /* -- Active ability handler (Phase 7) --------------------- */
  function combatAbilityAction(abilityId) {
    if (!CS.active) return;
    var data = loadData();
    if (!data) return;

    var ab = ABILITIES.find(function(a) { return a.id === abilityId; });
    if (!ab) return;

    /* Mana check */
    if (CS.mana < ab.cost) {
      addCombatLog('Not enough Mana for ' + ab.name + '.', 'system-note');
      return;
    }

    disableCombatButtons();
    CS.mana -= ab.cost;
    renderCombatManaPips();

    /* Nightcaller stun on repeated action */
    if (CS.monster.id === 'nightcaller' && CS.lastAction === abilityId) {
      CS.playerStunned = true;
      addCombatLog(CS.monster.name + ' anticipated your pattern. You are stunned for this round.', 'monster-action');
    }
    CS.lastAction     = abilityId;
    CS.readBonus      = false;
    CS.enduring       = false;
    CS.rootedThisRound = false;
    CS.deadStillThisRound = false;

    /* -- The Hanging Strike: 150% strike -- */
    if (abilityId === 'hanging_strike') {
      var r = calcPlayerDamage(data, 1.5);
      CS.monsterHp -= r.dmg;
      addCombatLog('The Hanging Strike connects — ' + r.dmg + ' damage (150%).', 'player-action');
      animateMonsterStruck();
    }

    /* -- Mighty Fist: 200% + stun monster -- */
    else if (abilityId === 'mighty_fist') {
      var r = calcPlayerDamage(data, 2.0);
      CS.monsterHp -= r.dmg;
      CS.stunned = true;
      addCombatLog('Mighty Fist — ' + r.dmg + ' damage. Monster stunned one round.', 'player-action');
      animateMonsterStruck();
    }

    /* -- Crusher: 250%, no consecutive -- */
    else if (abilityId === 'crusher') {
      var r = calcPlayerDamage(data, 2.5);
      CS.monsterHp -= r.dmg;
      addCombatLog('Crusher — ' + r.dmg + ' damage.', 'player-action');
      animateMonsterStruck();
    }

    /* -- Second Wind: +15 HP, once per encounter -- */
    else if (abilityId === 'second_wind') {
      CS.secondWindUsed = true;
      CS.playerHp = Math.min(CS.playerMaxHp, CS.playerHp + 15);
      updateCombatBars();
      addCombatLog('Second Wind — 15 HP restored.', 'player-action');
    }

    /* -- The Knowing Strike: 175% + debuff monster 2 rounds -- */
    else if (abilityId === 'knowing_strike') {
      var r = calcPlayerDamage(data, 1.75);
      CS.monsterHp -= r.dmg;
      CS.monsterDebuffRounds = 2;
      CS.monsterDebuffPct    = 0.20;
      addCombatLog('The Knowing Strike — ' + r.dmg + ' damage. Monster damage reduced 20% for 2 rounds.', 'player-action');
      animateMonsterStruck();
    }

    /* -- Word of the Source: 3× damage + full HP restore, once per day -- */
    else if (abilityId === 'word_of_source') {
      var today = new Date().toISOString().slice(0,10);
      CS.wordOfSourceDate = today;
      /* Save once-per-day marker */
      if (!data.abilities) data.abilities = { owned: [] };
      data.abilities.wordOfSourceDate = today;
      saveData(data);

      var r = calcPlayerDamage(data, 3.0);
      CS.monsterHp -= r.dmg;
      CS.playerHp  = CS.playerMaxHp;
      updateCombatBars();
      addCombatLog('Word of the Source — ' + r.dmg + ' damage. HP fully restored.', 'player-action');
      animateMonsterStruck();
    }

    /* -- Rooted: -50% incoming this round -- */
    else if (abilityId === 'rooted') {
      CS.rootedThisRound = true;
      addCombatLog('Rooted — incoming damage reduced 50% this round.', 'player-action');
    }

    /* -- Dead Still: -75% incoming this round -- */
    else if (abilityId === 'dead_still') {
      CS.deadStillThisRound = true;
      addCombatLog('Dead Still — incoming damage reduced 75% this round.', 'player-action');
    }

    updateCombatBars();

    /* Check monster death */
    if (CS.monsterHp <= 0) {
      resolveVictory(data);
      return;
    }

    /* Monster turn */
    setTimeout(function() {
      executeMonsterTurn(data);
    }, 600);
  }

  function animateMonsterStruck() {
    var portrait = document.getElementById('combat-monster-portrait');
    portrait.classList.remove('struck');
    void portrait.offsetWidth;
    portrait.classList.add('struck');
  }


  /* -- Victory ----------------------------------------------- */
  function resolveVictory(data) {
    CS.active = false;
    CS.monsterHp = 0;
    updateCombatBars();

    /* XP award */
    var xpGain = CS.monster.xp;
    var level  = data.character.level || 1;
    /* Bonus XP if monster tier > player level */
    if (CS.monster.tier > level) xpGain = Math.round(xpGain * 1.25);
    /* Reduced XP if monster tier significantly below player */
    if (CS.monster.tier < level - 1) xpGain = Math.round(xpGain * 0.5);

    data.character.xp   = (data.character.xp || 0) + xpGain;
    data.character.hp   = Math.max(1, CS.playerHp);
    data.character.mana = CS.mana; /* persist mana spent during combat */

    /* Save encounter count */
    if (!data.combat) data.combat = {};
    data.combat.encountersToday   = (CS.encountersToday || 0) + 1;
    data.combat.lastEncounterDate = new Date().toISOString().slice(0,10);
    CS.encountersToday = data.combat.encountersToday;

    /* Update XP bar on home screen */
    var xpThresholds = [0,200,500,900,1400,2000,2700,3500,4400,5400];
    var lvl = data.character.level || 1;
    var xpNeeded = xpThresholds[Math.min(lvl, xpThresholds.length - 1)];
    var xpCurrent = data.character.xp;

    /* Phase 8: track total victories for world stage 1 trigger */
    incrementTotalVictories(data);

    /* Phase 6: check for level-up BEFORE saving */
    var didLevelUp = checkLevelUp(data);
    var newLevel   = data.character.level;

    saveData(data);
    populateHomeScreen(data);

    /* Close combat */
    document.getElementById('combatOverlay').classList.remove('visible');

    /* Show result */
    var passage = VICTORY_PASSAGES[Math.floor(Math.random() * VICTORY_PASSAGES.length)];
    document.getElementById('result-icon').textContent    = '⚔️';
    document.getElementById('result-title').textContent   = 'Victory';
    document.getElementById('result-xp').style.display   = 'block';
    document.getElementById('result-xp').innerHTML       = '+' + xpGain + ' XP <span>earned</span>' +
      (didLevelUp ? ' &nbsp;·&nbsp; <span style="color:var(--ember)">LEVEL UP</span>' : '');
    document.getElementById('result-injury-notice').style.display = 'none';
    document.getElementById('result-passage').textContent = '"' + passage + '"';
    document.getElementById('combatResultOverlay').classList.add('visible');

    /* Phase 6: queue level-up screen to show after result is dismissed */
    if (didLevelUp) {
      var _origClose = window._levelUpQueued;
      window._levelUpQueued = { level: newLevel };
    }
  }

  /* -- Defeat ------------------------------------------------ */
  function resolveDefeat(data) {
    CS.active    = false;
    CS.playerHp  = 0;
    updateCombatBars();

    /* Block Venture Out for rest of day, reset HP for tomorrow */
    if (!data.combat) data.combat = {};
    var today = new Date().toISOString().slice(0,10);
    data.combat.ventureBlockedDate = today;
    data.character.hp   = data.character.maxHp || CS.playerMaxHp;
    data.character.mana = CS.mana; /* mana does not restore on defeat */
    saveData(data);
    populateHomeScreen(data);

    document.getElementById('combatOverlay').classList.remove('visible');

    var passage = DEFEAT_PASSAGES[Math.floor(Math.random() * DEFEAT_PASSAGES.length)];
    document.getElementById('result-icon').textContent     = '💀';
    document.getElementById('result-title').textContent    = 'Defeated';
    document.getElementById('result-xp').style.display    = 'none';
    document.getElementById('result-injury-notice').style.display = 'block';
    document.getElementById('result-passage').textContent = '"' + passage + '"';
    document.getElementById('combatResultOverlay').classList.add('visible');
  }

  /* -- Close result screen ----------------------------------- */
  function closeCombatResult() {
    document.getElementById('combatResultOverlay').classList.remove('visible');

    /* Phase 6: if a level-up was queued, show it now */
    if (window._levelUpQueued) {
      var queued = window._levelUpQueued;
      window._levelUpQueued = null;
      var data = loadData();
      if (data) showLevelUp(queued.level, data);
    }
  }

  /* -- Wire Venture Out button ------------------------------- */
  document.addEventListener('DOMContentLoaded', function() {
    var btns = document.querySelectorAll('.action-btn');
    /* btns[0] = Log Training (wired in Phase 3), btns[1] = Venture Out */
    if (btns[1]) btns[1].addEventListener('click', function() {
      var data = loadData();
      if (data && data.setupComplete) {
        /* Check if venture is blocked today */
        var today = new Date().toISOString().slice(0,10);
        if (data.combat && data.combat.ventureBlockedDate === today) {
          alert('You are injured. Venture Out returns tomorrow.');
          return;
        }
        openVentureOut();
      }
    });
  });

  /* -- Update home screen XP bar from data ------------------- */
  /* (populateHomeScreen already handles this in Phase 1–2 code) */
  /* We need to make sure XP bar is wired. Patch populateHomeScreen: */
  var _origPopulateHome = populateHomeScreen;
  populateHomeScreen = function(data) {
    _origPopulateHome(data);
    /* XP bar update */
    var xpThresholds = [200, 500, 900, 1400, 2000, 2700, 3500, 4400, 5400, 99999];
    var lvl      = (data.character.level || 1) - 1;
    var prevXp   = lvl > 0 ? [0,200,500,900,1400,2000,2700,3500,4400][lvl] : 0;
    var nextXp   = xpThresholds[Math.min(lvl, xpThresholds.length - 1)];
    var curXp    = data.character.xp || 0;
    var xpRange  = nextXp - prevXp;
    var xpIntoLvl = curXp - prevXp;
    var pct      = xpRange > 0 ? Math.min(100, Math.round(xpIntoLvl / xpRange * 100)) : 0;

    var xpFill  = document.querySelector('.xp-bar-fill');
    var xpLabel = document.querySelector('.xp-label');
    var xpVal   = document.querySelector('.xp-bar-wrap .meta-value');
    if (xpFill)  xpFill.style.width = pct + '%';
    if (xpLabel) xpLabel.textContent = 'Next Level: ' + (nextXp - curXp) + ' XP required';
    if (xpVal)   xpVal.textContent   = curXp + ' / ' + nextXp + ' XP';
  };



  /* ============================================================
     PHASE 6 — LEVEL UP & ABILITIES TREE
  ============================================================ */

  /* -- XP thresholds (index = level needed to reach) -------- */
  var XP_THRESHOLDS = [0, 200, 500, 900, 1400, 2000, 2700, 3500, 4400, 5400];

  /* -- Roman numerals ---------------------------------------- */
  var ROMAN = ['', 'I','II','III','IV','V','VI','VII','VIII','IX','X'];

  /* -- Level-up narrative moments --------------------------- */
  var LEVELUP_MOMENTS = {
    2:  { title: 'The Road Opens',
          passage: 'Two hundred steps behind you. The Reaches have noticed. Not with warmth — with the cold acknowledgement that something capable has entered the territory. You are no longer a stranger here.' },
    3:  { title: 'Harder Ground',
          passage: 'The body is different now. Not larger. Not louder. Quieter, in the way that things become quiet when they have learned to do a thing without thinking about it. Something has changed that cannot be undone.' },
    4:  { title: 'The Weight of It',
          passage: 'Four levels in and the work has stopped feeling like discipline. It feels like nature. The Reaches have no ceremony for this — they simply stop presenting the easy things and start presenting the hard ones.' },
    5:  { title: 'Halfway to the Gate',
          passage: 'You are past the point where most people stop. That is not praise — it is a fact about the road. The Iron Gate is closer now than the day you began. Close enough to see the shape of it.' },
    6:  { title: 'The Deep Country',
          passage: 'The hardest things in the Reaches live here. They have seen warriors reach this point before. Most of those warriors eventually turned back. The road ahead requires something different from what got you here.' },
    7:  { title: 'Earned',
          passage: 'There is no word in the Reaches for what you have become. They did not build one because they did not expect many people to get here. The work now is to stay here.' },
    8:  { title: 'The Far Side of the Work',
          passage: 'Eight levels. The Reaches are different from this side — quieter, stranger, more serious. You have been changed by the distance. You will not be unchanged again.' },
    9:  { title: 'Almost',
          passage: 'One level from the end of the numbered road. The October reckoning is close. The body knows what is coming. So does the road.' },
    10: { title: 'The Long Road Walked',
          passage: 'You have reached the end of the numbered levels. The Reaches do not offer celebration for this. They offer continuation — deeper country, harder things, the same cold road forward.' }
  };

  /* -- Full abilities definition ----------------------------- */
  var ABILITIES = [
    /* Branch 1 — Iron */
    { id:'iron_grip',       branch:'iron',       name:'Iron Grip',
      type:'passive', levelReq:2, statReq:{iron:20},
      cost:0,  costLabel:'Passive',
      effect:'Reduces all incoming damage by 5%.',
      combatEffect:'damage_reduction_pct', value:0.05 },
    { id:'hanging_strike',  branch:'iron',       name:'The Hanging Strike',
      type:'active',  levelReq:4, statReq:{iron:40},
      cost:8,  costLabel:'8 Mana',
      effect:'Deals 150% normal Strike damage.',
      combatEffect:'strike_multiplier', value:1.5 },
    { id:'ironclad',        branch:'iron',       name:'Ironclad',
      type:'passive', levelReq:7, statReq:{iron:60},
      cost:0,  costLabel:'Passive',
      effect:'Immune to one enemy special attack per encounter.',
      combatEffect:'special_immunity', value:1 },

    /* Branch 2 — Force */
    { id:'clubber',         branch:'force',      name:'Clubber',
      type:'passive', levelReq:3, statReq:{force:30},
      cost:0,  costLabel:'Passive',
      effect:'+10% bonus damage to every Strike.',
      combatEffect:'strike_bonus_pct', value:0.10 },
    { id:'mighty_fist',     branch:'force',      name:'Mighty Fist',
      type:'active',  levelReq:5, statReq:{force:50, lore:20},
      cost:14, costLabel:'14 Mana',
      effect:'200% Strike damage and stuns the monster for one round.',
      combatEffect:'strike_multiplier_stun', value:2.0 },
    { id:'crusher',         branch:'force',      name:'Crusher',
      type:'active',  levelReq:8, statReq:{force:70},
      cost:18, costLabel:'18 Mana',
      effect:'250% Strike damage. Cannot be used on consecutive rounds.',
      combatEffect:'strike_multiplier_noconsec', value:2.5 },

    /* Branch 3 — Road (Endurance) */
    { id:'second_wind',     branch:'endurance',  name:'Second Wind',
      type:'active',  levelReq:2, statReq:{endurance:25},
      cost:10, costLabel:'10 Mana',
      effect:'Restores 15 HP. Once per encounter.',
      combatEffect:'heal_once', value:15 },
    { id:'grinding_pace',   branch:'endurance',  name:'Grinding Pace',
      type:'passive', levelReq:5, statReq:{endurance:45},
      cost:0,  costLabel:'Passive',
      effect:'+5% damage bonus for every round beyond Round 3.',
      combatEffect:'damage_per_late_round', value:0.05 },
    { id:'the_long_road',   branch:'endurance',  name:'The Long Road',
      type:'passive', levelReq:6, statReq:{endurance:60},
      cost:0,  costLabel:'Passive',
      effect:'HP cannot drop below 5 from a single hit.',
      combatEffect:'hp_floor', value:5 },

    /* Branch 4 — Source (Resolve + Lore) */
    { id:'steadfast',       branch:'resolve',    name:'Steadfast',
      type:'passive', levelReq:2, statReq:{resolve:20},
      cost:0,  costLabel:'Passive',
      effect:'Auto-resist next attack when HP drops below 20%. Once per encounter.',
      combatEffect:'auto_resist_low_hp', value:0.20 },
    { id:'knowing_strike',  branch:'resolve',    name:'The Knowing Strike',
      type:'active',  levelReq:5, statReq:{lore:30, resolve:30},
      cost:15, costLabel:'15 Mana',
      effect:'175% Strike damage and reduces monster damage by 20% for 2 rounds.',
      combatEffect:'strike_debuff', value:1.75 },
    { id:'word_of_source',  branch:'resolve',    name:'Word of the Source',
      type:'active',  levelReq:7, statReq:{resolve:50, lore:40},
      cost:25, costLabel:'25 Mana',
      effect:'Massive Strike damage and fully restores HP. Once per day.',
      combatEffect:'strike_heal_once_day', value:3.0 },

    /* Branch 5 — Foundation (Core) */
    { id:'ironbelly',       branch:'core',       name:'Ironbelly',
      type:'passive', levelReq:2, statReq:{core:25},
      cost:0,  costLabel:'Passive',
      effect:'Flat -3 damage reduction per hit.',
      combatEffect:'flat_damage_reduction', value:3 },
    { id:'rooted',          branch:'core',       name:'Rooted',
      type:'active',  levelReq:4, statReq:{core:40},
      cost:10, costLabel:'10 Mana',
      effect:'-50% incoming damage for one round.',
      combatEffect:'endure_50pct', value:0.50 },
    { id:'dead_still',      branch:'core',       name:'Dead Still',
      type:'active',  levelReq:5, statReq:{core:50},
      cost:12, costLabel:'12 Mana',
      effect:'-75% incoming damage for one round.',
      combatEffect:'endure_75pct', value:0.75 },
  ];

  var BRANCH_LABELS = {
    iron:      'The Iron Branch',
    force:     'The Force Branch',
    endurance: 'The Road Branch',
    resolve:   'The Source Branch',
    core:      'The Foundation Branch'
  };

  var BRANCH_PREREQ_LABELS = {
    iron:      'Prerequisite: Iron stat',
    force:     'Prerequisite: Force stat',
    endurance: 'Prerequisite: Endurance stat',
    resolve:   'Prerequisite: Resolve + Lore stats',
    core:      'Prerequisite: Core stat'
  };

  /* -- State for current level-up session ------------------- */
  var LU = {
    newLevel:          1,
    selectedAbilityId: null
  };

  /* -- Check if an ability's stat prereqs are met ----------- */
  function abilityPrereqsMet(ability, stats) {
    var reqs = ability.statReq;
    for (var stat in reqs) {
      if ((stats[stat] || 0) < reqs[stat]) return false;
    }
    return true;
  }

  /* -- Build the abilities tree HTML ------------------------ */
  function buildAbilitiesTree(data) {
    var container = document.getElementById('abilities-tree-container');
    container.innerHTML = '';

    var ownedIds  = (data.abilities && data.abilities.owned)  || [];
    var level     = data.character.level || 1;
    var stats     = data.stats || {};

    var branches  = ['iron','force','endurance','resolve','core'];

    branches.forEach(function(branch) {
      var abilities = ABILITIES.filter(function(a) { return a.branch === branch; });

      var branchEl = document.createElement('div');
      branchEl.className = 'abilities-branch';

      /* Branch header */
      var header = document.createElement('div');
      header.className = 'branch-header';
      header.innerHTML =
        '<span class="branch-name">' + BRANCH_LABELS[branch] + '</span>' +
        '<span class="branch-prereq">' + BRANCH_PREREQ_LABELS[branch] + '</span>';
      branchEl.appendChild(header);

      abilities.forEach(function(ab) {
        var card = document.createElement('div');
        card.className = 'ability-card';

        var owned      = ownedIds.indexOf(ab.id) !== -1;
        var levelOk    = level >= ab.levelReq;
        var statsOk    = abilityPrereqsMet(ab, stats);
        var unlockable = !owned && levelOk && statsOk;

        if (owned) {
          card.classList.add('already-owned');
        } else if (unlockable) {
          card.classList.add('unlockable');
          card.setAttribute('data-ability-id', ab.id);
          card.addEventListener('click', function() { selectAbility(ab.id); });
        } else {
          card.classList.add('locked');
        }

        /* Type badge */
        var badge = '<span class="ability-type-badge ' + ab.type + '">' + ab.type + '</span>';

        /* Lock reason */
        var lockReason = '';
        if (!owned && !unlockable) {
          var reasons = [];
          if (!levelOk)  reasons.push('Level ' + ab.levelReq + ' required');
          if (!statsOk) {
            for (var s in ab.statReq) {
              if ((stats[s] || 0) < ab.statReq[s]) {
                reasons.push(s.charAt(0).toUpperCase() + s.slice(1) + ' ' + ab.statReq[s] + ' required (you have ' + Math.floor(stats[s] || 0) + ')');
              }
            }
          }
          lockReason = '<div class="ability-lock-reason">' + reasons.join(' · ') + '</div>';
        }

        /* Owned badge */
        var ownedBadge = owned ? '<span class="ability-owned-badge">Owned</span>' : '';

        card.innerHTML =
          badge +
          '<div class="ability-info">' +
            '<div class="ability-name">' + ab.name + '</div>' +
            '<div class="ability-effect">' + ab.effect + '</div>' +
            lockReason +
          '</div>' +
          (ab.cost > 0 ? '<span class="ability-cost">' + ab.costLabel + '</span>' : '') +
          ownedBadge;

        branchEl.appendChild(card);
      });

      container.appendChild(branchEl);
    });
  }

  /* -- Handle ability selection ------------------------------ */
  function selectAbility(abilityId) {
    /* Deselect all */
    document.querySelectorAll('.ability-card.selected-this-level').forEach(function(el) {
      el.classList.remove('selected-this-level');
    });

    /* Select clicked */
    var card = document.querySelector('[data-ability-id="' + abilityId + '"]');
    if (card) card.classList.add('selected-this-level');

    LU.selectedAbilityId = abilityId;

    /* Show confirm button */
    var confirmBtn = document.getElementById('levelup-confirm-btn');
    confirmBtn.classList.add('visible');

    /* Update subheading with ability name */
    var ab = ABILITIES.find(function(a) { return a.id === abilityId; });
    if (ab) {
      document.getElementById('abilities-subheading').textContent =
        '"' + ab.name + '" — ' + ab.effect;
    }
  }

  /* -- Confirm ability choice -------------------------------- */
  function confirmAbility() {
    if (!LU.selectedAbilityId) return;
    var data = loadData();
    if (!data) return;

    if (!data.abilities) data.abilities = { owned: [] };
    if (data.abilities.owned.indexOf(LU.selectedAbilityId) === -1) {
      data.abilities.owned.push(LU.selectedAbilityId);
    }

    saveData(data);
    closeLevelUp();
    populateHomeScreen(data);
  }

  /* -- Skip ability (can return later — but choice will be lost on next level) */
  function skipAbility() {
    closeLevelUp();
  }

  function closeLevelUp() {
    document.getElementById('levelUpOverlay').classList.remove('visible');
    LU.selectedAbilityId = null;
    document.getElementById('levelup-confirm-btn').classList.remove('visible');
    document.getElementById('abilities-subheading').textContent =
      'Select an ability you have earned the right to carry.';
  }

  /* -- Show level-up screen ---------------------------------- */
  function showLevelUp(newLevel, data) {
    LU.newLevel = newLevel;
    LU.selectedAbilityId = null;

    var moment = LEVELUP_MOMENTS[newLevel] || {
      title:   'Another Level',
      passage: 'The road continues. So do you.'
    };

    document.getElementById('levelup-number').textContent  = ROMAN[newLevel] || newLevel;
    document.getElementById('levelup-title').textContent   = moment.title;
    document.getElementById('levelup-passage').textContent = moment.passage;
    document.getElementById('levelup-confirm-btn').classList.remove('visible');

    buildAbilitiesTree(data);

    document.getElementById('levelUpOverlay').classList.add('visible');
  }

  /* -- Check for level-up after XP gain --------------------- */
  function checkLevelUp(data) {
    var level = data.character.level || 1;
    if (level >= 10) return false;  /* max level */

    var xp      = data.character.xp || 0;
    var needed  = XP_THRESHOLDS[level]; /* threshold to reach level+1 */
    if (!needed) return false;

    if (xp >= needed) {
      /* Level up */
      data.character.level = level + 1;

      /* Recalculate max HP and max Mana at new level */
      var coreStat    = data.stats.core    || 0;
      var resolveStat = data.stats.resolve || 0;
      data.character.maxHp   = (data.character.level * 10) + Math.floor(coreStat / 10 * 5) + 40;
      data.character.maxMana = 30 + Math.floor(resolveStat / 10 * 5) + (data.character.level * 3);

      /* Restore HP to new max on level up */
      data.character.hp = data.character.maxHp;

      saveData(data);
      return true;
    }
    return false;
  }

  /* -- Update home screen level display --------------------- */
  /* Patch populateHomeScreen to show correct level Roman numeral */
  var _origPopulateHome2 = populateHomeScreen;
  populateHomeScreen = function(data) {
    _origPopulateHome2(data);
    var lvl = data.character.level || 1;
    /* Update level display in character panel */
    var lvlEl = document.querySelector('.meta-value.ember');
    if (lvlEl) lvlEl.textContent = ROMAN[lvl] || lvl;

    /* Update HP max if it has changed */
    var coreStat = data.stats ? (data.stats.core || 0) : 0;
    var maxHp = (lvl * 10) + Math.floor(coreStat / 10 * 5) + 40;
    if (data.character.maxHp !== maxHp) {
      /* Sync maxHp silently */
    }
  };



  /* ============================================================
     PHASE 8 — WORLD IMAGE TRANSFORMATION
  ============================================================ */

  /*
    IMAGE FILE GUIDE (add these files to your GitHub repo root):
    -------------------------------------------------------------
    stage-0.jpg  — Day 1 / start. Empty road, grey sky, dead tree, cold.
    stage-1.jpg  — After Level 1 battle won. Faint fire in far distance.
    stage-2.jpg  — After Level 2 battle won. Silhouetted figure on road ahead.
    stage-3.jpg  — After May 23 (Trial of the Iron Gate). Stone gate behind you, already crossed.
    stage-4.jpg  — After June 20 (Running of the Ashwood). Road from dark forest into wider landscape.
    stage-5.jpg  — After Level 5 narrative battle. Lights of settlement in middle distance.
    stage-6.jpg  — After Sept 21 (March on Valdenmoor). Black Spire on the horizon, first time.
    stage-7.jpg  — After October (Reckoning at the Black Spire). World transformed. Road populated. Sky settled.

    AI PROMPT BASE (adjust [SCENE DESCRIPTION] for each stage):
    -------------------------------------------------------------
    "A dark cinematic road scene in a cold northern wilderness. 
    [SCENE DESCRIPTION]. Desaturated palette, charcoal and ash tones, 
    muted amber at the horizon. Photorealistic with painterly post-processing, 
    dark vignette edges, fine film grain. Northern European sky, no bright 
    lighting, no fantasy clichés, no heroic figures. Aspect ratio 16:9."
    -------------------------------------------------------------
  */

  /* -- Stage definitions ------------------------------------- */
  var WORLD_STAGES = [
    { id: 0, img: 'stage-0.jpg',
      desc: 'Empty road. Grey sky. Dead tree. Cold and waiting.' },
    { id: 1, img: 'stage-1.jpg',
      desc: 'A faint fire visible in the far distance.' },
    { id: 2, img: 'stage-2.jpg',
      desc: 'A silhouetted figure on the road ahead.' },
    { id: 3, img: 'stage-3.jpg',
      desc: 'A stone gate visible behind you. Already crossed.' },
    { id: 4, img: 'stage-4.jpg',
      desc: 'Road emerges from dark forest into wider landscape.' },
    { id: 5, img: 'stage-5.jpg',
      desc: 'Lights of a settlement visible in the middle distance.' },
    { id: 6, img: 'stage-6.jpg',
      desc: 'Black Spire visible on the horizon for the first time.' },
    { id: 7, img: 'stage-7.jpg',
      desc: 'World transformed. Road populated. Sky settled.' }
  ];

  /* -- Determine current world stage from save data ---------- */
  function calcWorldStage(data) {
    if (!data || !data.setupComplete) return 0;

    var level    = data.character ? (data.character.level || 1) : 1;
    var ordained = data.ordained  || {};
    var today    = new Date().toISOString().slice(0, 10);

    /* Stage 7: Reckoning at the Black Spire complete (October ordained battle) */
    if (ordained.blackSpire) return 7;

    /* Stage 6: March on Valdenmoor complete (Sept 21) */
    if (ordained.valdenmoor) return 6;

    /* Stage 5: Level 5 reached */
    if (level >= 5) return 5;

    /* Stage 4: Running of the Ashwood complete (June 20) */
    if (ordained.ashwood) return 4;

    /* Stage 3: Trial of the Iron Gate complete (May 23) */
    if (ordained.ironGate) return 3;

    /* Stage 2: Level 2 reached (second standard battle won) */
    if (level >= 2) return 2;

    /* Stage 1: At least one combat victory */
    var log = data.log || [];
    var hasCombatVictory = data.combat &&
      (data.combat.encountersToday > 0 || (data.combat.totalVictories || 0) > 0);
    if (hasCombatVictory) return 1;

    return 0;
  }

  /* -- Apply world stage to the hero image ------------------- */
  function applyWorldStage(data) {
    var stageIdx = calcWorldStage(data);
    var stage    = WORLD_STAGES[stageIdx];
    var heroImg  = document.querySelector('.hero-image');
    if (!heroImg) return;

    /* Try to load the image — if it fails, keep CSS fallback */
    var img = new Image();
    img.onload = function() {
      heroImg.style.setProperty('--world-image', 'url("' + stage.img + '")');
      heroImg.classList.add('has-image');
    };
    img.onerror = function() {
      /* Image not present — CSS-drawn fallback stays, no error shown */
      heroImg.classList.remove('has-image');
    };
    img.src = stage.img;

    /* Store current stage on data for absence modifier reference */
    if (!data.world) data.world = {};
    if (data.world.stage !== stageIdx) {
      data.world.stage = stageIdx;
      /* Don't save here — called frequently from populateHomeScreen */
    }
  }

  /* -- Apply absence darkening to hero image ----------------- */
  function applyAbsenceDarkening(data) {
    var heroImg = document.querySelector('.hero-image');
    if (!heroImg) return;

    heroImg.classList.remove('absence-tier-1', 'absence-tier-2', 'absence-tier-3');

    var missed  = calcAbsenceDays(data);
    if (missed >= 7)      heroImg.classList.add('absence-tier-3');
    else if (missed >= 4) heroImg.classList.add('absence-tier-2');
    else if (missed >= 2) heroImg.classList.add('absence-tier-1');
  }

  /* -- Track total victories for stage-1 trigger ------------ */
  /* Called from resolveVictory — increment totalVictories */
  function incrementTotalVictories(data) {
    if (!data.combat) data.combat = {};
    data.combat.totalVictories = (data.combat.totalVictories || 0) + 1;
  }

  /* -- Patch populateHomeScreen to apply world stage -------- */
  var _origPopulateHome3 = populateHomeScreen;
  populateHomeScreen = function(data) {
    _origPopulateHome3(data);
    applyWorldStage(data);
    applyAbsenceDarkening(data);
  };



  /* ============================================================
     PHASE 9 — ORDAINED BATTLE SYSTEM
  ============================================================ */

  /* -- Race definitions -------------------------------------- */
  var ORDAINED_RACES = [
    {
      id:       'ironGate',
      name:     'Trial of the Iron Gate',
      subtitle: 'Spartan 5K Sprint · May 23, 2025',
      date:     '2025-05-23',
      baseXp:   500,
      eyebrow:  'Ordained Battle — Race Three',

      passage:  'The gate was always real. You knew this on some level from the first cold morning you trained for it. What you did not know was what it would feel like to stand in front of it — the noise, the weight of the thing, the way your body remembered everything it had been asked to do in the months before. You crossed. That is the fact of it.',

      branches: [
        {
          id:    'hard',
          name:  'The Hard Crossing',
          desc:  'Survived. Harder than expected. The grip held but only just. The gate was crossed — not cleanly.',
          xpMult: 1.0,
          statBonus:  null,
          statBonus2: null,
          abilityId:  null,
          rewardText: 'Base XP only. No stat bonus.'
        },
        {
          id:    'earned',
          name:  'The Earned Fight',
          desc:  'Completed. Held what was trained. The Iron showed.',
          xpMult: 1.25,
          statBonus:  { stat: 'iron', amount: 10 },
          statBonus2: null,
          abilityId:  null,
          rewardText: '+10 Iron'
        },
        {
          id:    'threshold',
          name:  'Beyond the Threshold',
          desc:  'Exceeded expectations. Something in the gate recognised you.',
          xpMult: 1.50,
          statBonus:  { stat: 'iron',  amount: 10 },
          statBonus2: { stat: 'force', amount: 8  },
          abilityId:  'gatekeepers_knowledge',
          rewardText: '+10 Iron · +8 Force · Ability Unlocked'
        }
      ],

      resultPassages: {
        hard:      'The gate is behind you now. That is the only thing that matters. The crossing was hard. It was still a crossing.',
        earned:    'The Iron showed. The gate had no answer for what you had built in the dark. You earned the right to have crossed it.',
        threshold: 'You did not just cross. You arrived at the other side knowing something the gate did not expect you to know. The road ahead is different now.'
      }
    },

    {
      id:       'ashwood',
      name:     'Running of the Ashwood',
      subtitle: 'Trail Run · June 20, 2025',
      date:     '2025-06-20',
      baseXp:   600,
      eyebrow:  'Ordained Battle — Race Four',

      passage:  'The Ashwood does not care about your pace. It cares about whether you keep moving when the ground is bad and the light is wrong and the body is asking you to stop. The trees do not watch. Nothing watches. That is the test — doing the work in front of nothing.',

      branches: [
        {
          id:    'hard',
          name:  'The Hard Crossing',
          desc:  'Survived the Ashwood. The terrain won some rounds. You won the one that counted.',
          xpMult: 1.0,
          statBonus:  null,
          statBonus2: null,
          abilityId:  null,
          rewardText: 'Base XP only.'
        },
        {
          id:    'earned',
          name:  'The Earned Fight',
          desc:  'Completed. Endurance held through hostile terrain.',
          xpMult: 1.25,
          statBonus:  { stat: 'endurance', amount: 12 },
          statBonus2: null,
          abilityId:  null,
          rewardText: '+12 Endurance'
        },
        {
          id:    'threshold',
          name:  'Beyond the Threshold',
          desc:  'The Ashwood gave everything it had. It was not enough.',
          xpMult: 1.50,
          statBonus:  { stat: 'endurance', amount: 12 },
          statBonus2: { stat: 'core',      amount: 8  },
          abilityId:  'ashwood_pace',
          rewardText: '+12 Endurance · +8 Core · Ability Unlocked'
        }
      ],

      resultPassages: {
        hard:      'The wood is behind you. The crossing happened. Whatever it cost you — it cost less than not having crossed.',
        earned:    'The Endurance held. Every early morning that built it showed in the Ashwood. The road out of the trees is wider than the road in.',
        threshold: 'You ran the Ashwood the way it was meant to be run — without hesitation, without transaction, as if the trees were simply in the way of where you were going.'
      }
    },

    {
      id:       'valdenmoor',
      name:     'March on Valdenmoor',
      subtitle: 'Spartan 21K Super · September 21, 2025',
      date:     '2025-09-21',
      baseXp:   900,
      eyebrow:  'Ordained Battle — Race Six',

      passage:  'The Valdenmoor is not a race. It is a campaign. Twenty-one kilometres of contested ground, obstacles that test different things at different points, and a body that has to answer questions it has never been asked before in the same sequence. Some people will not finish. You knew this going in. You finished.',

      branches: [
        {
          id:    'hard',
          name:  'The Hard Crossing',
          desc:  'Survived the full distance. Some obstacles surrendered reluctantly. The body answered.',
          xpMult: 1.0,
          statBonus:  null,
          statBonus2: null,
          abilityId:  null,
          rewardText: 'Base XP only.'
        },
        {
          id:    'earned',
          name:  'The Earned Fight',
          desc:  'Completed. Held the line on the long haul. Endurance did not fail.',
          xpMult: 1.25,
          statBonus:  { stat: 'endurance', amount: 15 },
          statBonus2: null,
          abilityId:  null,
          rewardText: '+15 Endurance'
        },
        {
          id:    'threshold',
          name:  'Beyond the Threshold',
          desc:  'The Valdenmoor is behind you and it knows it was beaten.',
          xpMult: 1.50,
          statBonus:  { stat: 'endurance', amount: 15 },
          statBonus2: { stat: 'force',     amount: 10 },
          abilityId:  'valdenmoors_weight',
          rewardText: '+15 Endurance · +10 Force · Ability Unlocked'
        }
      ],

      resultPassages: {
        hard:      'Twenty-one kilometres. You are on the other side of it now. That fact is permanent.',
        earned:    'The campaign ran long and the body held. The training was not a rehearsal — it was the thing itself, done in pieces.',
        threshold: 'The Black Spire is now visible on the horizon. What you did today is what made it visible. October is close.'
      }
    },

    {
      id:       'blackSpire',
      name:     'Reckoning at the Black Spire',
      subtitle: 'Spartan Trifecta Weekend · October 2025',
      date:     '2025-10-01',
      baseXp:   1500,
      eyebrow:  'Ordained Battle — The Final Reckoning',

      passage:  'This is what all of it was for. Not the medals — those are objects. Not the finish times — those are numbers. This is for the fact that you became something different from what you were in February. The Spire does not care who you were. It cares who crossed its threshold. You did. The road is complete. The world is changed.',

      branches: [
        {
          id:    'hard',
          name:  'The Hard Crossing',
          desc:  'Survived the Trifecta. The full weekend, all three distances. It was earned through endurance alone.',
          xpMult: 1.0,
          statBonus:  null,
          statBonus2: null,
          abilityId:  null,
          rewardText: 'Base XP only. The road is complete.'
        },
        {
          id:    'earned',
          name:  'The Earned Fight',
          desc:  'Completed. Held every element of what was trained. The Spire was taken methodically.',
          xpMult: 1.25,
          statBonus:  { stat: '__highest__', amount: 20 },
          statBonus2: null,
          abilityId:  null,
          rewardText: '+20 to highest stat'
        },
        {
          id:    'threshold',
          name:  'Beyond the Threshold',
          desc:  'The Trifecta is complete. The Black Spire is behind you. The world is different.',
          xpMult: 1.50,
          statBonus:  { stat: '__highest__', amount: 20 },
          statBonus2: { stat: 'resolve',     amount: 12 },
          abilityId:  'word_of_spire',
          rewardText: '+20 highest stat · +12 Resolve · Word of the Spire'
        }
      ],

      resultPassages: {
        hard:      'The Trifecta is done. All three. The road that began in February is complete. You are not the same person who started it.',
        earned:    'The Spire fell. Everything you built — the early mornings, the logged sessions, the choices — it held. The story is complete.',
        threshold: 'Beyond the Threshold. The world has transformed. The Black Spire is behind you, and you carry something home from it that no one else can name.'
      }
    }
  ];

  /* -- Ordained-specific abilities --------------------------- */
  var ORDAINED_ABILITIES = [
    { id: 'gatekeepers_knowledge', name: "Gatekeeper's Knowledge",
      effect: '-15% enemy damage on Round 1 of every encounter.' },
    { id: 'ashwood_pace',          name: 'Ashwood Pace',
      effect: '-10% HP loss in sustained rounds (rounds 4+).' },
    { id: 'valdenmoors_weight',    name: "Valdenmoor's Weight",
      effect: '175% Strike damage, 18 Mana.' },
    { id: 'word_of_spire',         name: 'Word of the Spire',
      effect: 'Strongest ability. Deals 400% damage, 30 Mana. Once per day.' }
  ];

  /* -- State ------------------------------------------------- */
  var OB = {
    race:           null,   /* current ORDAINED_RACES entry */
    selectedBranch: null
  };

  /* -- Determine which race is available to the player ------- */
  function getAvailableRace(data) {
    var today    = new Date().toISOString().slice(0, 10);
    var ordained = data.ordained || {};

    for (var i = 0; i < ORDAINED_RACES.length; i++) {
      var race = ORDAINED_RACES[i];
      /* Already completed? */
      if (ordained[race.id]) continue;
      /* Date not reached yet? */
      if (today < race.date) continue;
      /* This race is available */
      return race;
    }
    return null; /* all complete, or none available yet */
  }

  /* -- Update "The World" button state on home screen -------- */
  function updateWorldButton(data) {
    var btns = document.querySelectorAll('.action-btn');
    var worldBtn = btns[2]; /* third action button */
    if (!worldBtn) return;

    var race = getAvailableRace(data);
    var subEl = worldBtn.querySelector('.btn-sub');

    if (race) {
      worldBtn.classList.add('race-available');
      worldBtn.classList.remove('race-locked');
      if (subEl) subEl.textContent = race.name;
    } else {
      var ordained = data.ordained || {};
      var allDone  = ORDAINED_RACES.every(function(r) { return ordained[r.id]; });
      worldBtn.classList.remove('race-available');
      worldBtn.classList.add('race-locked');
      if (subEl) {
        subEl.textContent = allDone
          ? 'All races complete'
          : 'Next race not yet';
      }
    }
  }

  /* -- Open ordained battle screen --------------------------- */
  function openOrdained() {
    var data = loadData();
    if (!data) return;

    var race = getAvailableRace(data);
    if (!race) {
      /* No race available — could show a message, but brief says button is always visible */
      return;
    }

    OB.race           = race;
    OB.selectedBranch = null;

    /* Populate header */
    document.getElementById('ordained-eyebrow').textContent  = race.eyebrow;
    document.getElementById('ordained-title').textContent    = race.name;
    document.getElementById('ordained-subtitle').textContent = race.subtitle;
    document.getElementById('ordained-passage').textContent  = race.passage;

    /* Render branch cards */
    var container = document.getElementById('ordained-branches');
    container.innerHTML = '';

    race.branches.forEach(function(branch) {
      var card = document.createElement('div');
      card.className = 'ordained-branch-card';
      card.setAttribute('data-branch-id', branch.id);

      /* Reward chips */
      var chips = '';
      chips += '<span class="ordained-reward-chip">+' + Math.round(race.baseXp * branch.xpMult) + ' XP</span>';
      if (branch.statBonus)  chips += '<span class="ordained-reward-chip highlight">' + formatStatBonus(branch.statBonus)  + '</span>';
      if (branch.statBonus2) chips += '<span class="ordained-reward-chip highlight">' + formatStatBonus(branch.statBonus2) + '</span>';
      if (branch.abilityId)  chips += '<span class="ordained-reward-chip highlight">Ability Unlocked</span>';

      card.innerHTML =
        '<div class="ordained-branch-name">' + branch.name + '</div>' +
        '<div class="ordained-branch-desc">' + branch.desc + '</div>' +
        '<div class="ordained-branch-rewards">' + chips + '</div>';

      card.addEventListener('click', function() { selectOrdainedBranch(branch.id); });
      container.appendChild(card);
    });

    /* Reset commit button */
    document.getElementById('ordained-commit-btn').classList.remove('visible');

    document.getElementById('ordainedOverlay').classList.add('visible');
  }

  function formatStatBonus(bonus) {
    if (!bonus) return '';
    if (bonus.stat === '__highest__') return '+' + bonus.amount + ' highest stat';
    var label = bonus.stat.charAt(0).toUpperCase() + bonus.stat.slice(1);
    return '+' + bonus.amount + ' ' + label;
  }

  /* -- Select branch ----------------------------------------- */
  function selectOrdainedBranch(branchId) {
    document.querySelectorAll('.ordained-branch-card').forEach(function(c) {
      c.classList.toggle('selected', c.getAttribute('data-branch-id') === branchId);
    });
    OB.selectedBranch = branchId;
    document.getElementById('ordained-commit-btn').classList.add('visible');
  }

  function closeOrdained() {
    document.getElementById('ordainedOverlay').classList.remove('visible');
    OB.race = null; OB.selectedBranch = null;
  }

  /* -- Confirm branch and apply rewards ---------------------- */
  function confirmOrdinedBranch() {
    if (!OB.race || !OB.selectedBranch) return;
    var data = loadData();
    if (!data) return;

    var race   = OB.race;
    var branch = race.branches.find(function(b) { return b.id === OB.selectedBranch; });
    if (!branch) return;

    /* -- Apply XP -- */
    var xpGain = Math.round(race.baseXp * branch.xpMult);
    data.character.xp = (data.character.xp || 0) + xpGain;

    /* -- Apply stat bonuses -- */
    function applyStat(bonus) {
      if (!bonus) return;
      if (bonus.stat === '__highest__') {
        /* Find the highest stat */
        var stats  = data.stats;
        var best   = 'endurance';
        var bestV  = 0;
        ['endurance','iron','force','core','resolve','lore'].forEach(function(s) {
          if ((stats[s] || 0) > bestV) { bestV = stats[s] || 0; best = s; }
        });
        data.stats[best] = Math.min(100, (data.stats[best] || 0) + bonus.amount);
      } else {
        data.stats[bonus.stat] = Math.min(100, (data.stats[bonus.stat] || 0) + bonus.amount);
      }
    }
    applyStat(branch.statBonus);
    applyStat(branch.statBonus2);

    /* -- Apply ability -- */
    var abilityUnlocked = null;
    if (branch.abilityId) {
      if (!data.abilities) data.abilities = { owned: [] };
      if (data.abilities.owned.indexOf(branch.abilityId) === -1) {
        data.abilities.owned.push(branch.abilityId);
      }
      abilityUnlocked = ORDAINED_ABILITIES.find(function(a) { return a.id === branch.abilityId; });
    }

    /* -- Mark race complete -- */
    if (!data.ordained) data.ordained = {};
    data.ordained[race.id] = OB.selectedBranch; /* store which branch was chosen */

    /* -- Check for level up -- */
    var didLevelUp = checkLevelUp(data);
    var newLevel   = data.character.level;

    saveData(data);
    populateHomeScreen(data);
    closeOrdained();

    /* -- Show result -- */
    showOrdainedResult(race, branch, xpGain, abilityUnlocked, branch.statBonus, branch.statBonus2, data);

    /* Queue level up if triggered */
    if (didLevelUp) {
      window._levelUpQueued = { level: newLevel };
    }
  }

  /* -- Show ordained result screen --------------------------- */
  function showOrdainedResult(race, branch, xpGain, ability, bonus1, bonus2, data) {
    document.getElementById('ordained-result-icon').textContent    = '⚔️';
    document.getElementById('ordained-result-title').textContent   = branch.name;
    document.getElementById('ordained-result-race').textContent    = race.name.toUpperCase() + ' · ' + race.subtitle;

    /* Rewards rows */
    var rewardsEl = document.getElementById('ordained-result-rewards');
    rewardsEl.innerHTML = '';

    function addRewardRow(label, value) {
      var row = document.createElement('div');
      row.className = 'ordained-result-reward-row';
      row.innerHTML =
        '<span class="ordained-result-reward-label">' + label + '</span>' +
        '<span class="ordained-result-reward-value">' + value + '</span>';
      rewardsEl.appendChild(row);
    }

    addRewardRow('XP Earned', '+' + xpGain);

    if (bonus1) {
      addRewardRow(
        bonus1.stat === '__highest__' ? 'Highest Stat' : bonus1.stat.charAt(0).toUpperCase() + bonus1.stat.slice(1),
        '+' + bonus1.amount
      );
    }
    if (bonus2) {
      addRewardRow(
        bonus2.stat === '__highest__' ? 'Resolve' : bonus2.stat.charAt(0).toUpperCase() + bonus2.stat.slice(1),
        '+' + bonus2.amount
      );
    }

    /* Ability block */
    var abilityEl = document.getElementById('ordained-result-ability');
    if (ability) {
      abilityEl.style.display = 'block';
      document.getElementById('ordained-result-ability-name').textContent   = ability.name;
      document.getElementById('ordained-result-ability-effect').textContent = ability.effect;
    } else {
      abilityEl.style.display = 'none';
    }

    /* Passage */
    var passage = race.resultPassages[branch.id] || '';
    document.getElementById('ordained-result-passage').textContent = '"' + passage + '"';

    document.getElementById('ordainedResultOverlay').classList.add('visible');
  }

  function closeOrdainedResult() {
    document.getElementById('ordainedResultOverlay').classList.remove('visible');
    /* Fire queued level-up if present */
    if (window._levelUpQueued) {
      var queued = window._levelUpQueued;
      window._levelUpQueued = null;
      var data = loadData();
      if (data) showLevelUp(queued.level, data);
    }
  }

  /* -- Wire "The World" button ------------------------------- */
  document.addEventListener('DOMContentLoaded', function() {
    var btns = document.querySelectorAll('.action-btn');
    if (btns[2]) btns[2].addEventListener('click', function() {
      var data = loadData();
      if (data && data.setupComplete) openOrdained();
    });
  });

  /* -- Patch populateHomeScreen to update World button ------- */
  var _origPopulateHome4 = populateHomeScreen;
  populateHomeScreen = function(data) {
    _origPopulateHome4(data);
    updateWorldButton(data);
  };

  /* -- Apply ordained abilities in combat -------------------- */
  /* Gatekeeper's Knowledge: -15% damage Round 1 */
  /* Applied inside calcMonsterDamage — check CS.round and owned abilities */
  /* Ashwood Pace: -10% HP loss rounds 4+ */
  /* Valdenmoor's Weight: active ability (handled as combatAbilityAction) */
  /* Word of the Spire: active ability (handled as combatAbilityAction) */



  /* ============================================================
     PHASE 10 — THE RECORD, EXPORT, & POLISH
  ============================================================ */

  /* -- Daily flavour text pool (home screen band) ----------- */
  var HOME_FLAVOUR = [
    "You are here. That is more than most. Begin.",
    "The road does not care what you did yesterday.",
    "What you build today exists tomorrow. What you skip today also exists tomorrow.",
    "The Reaches are cold in the morning. Train anyway.",
    "Every number on this screen was earned. None of them were given.",
    "The body keeps the account. You simply log it.",
    "Hard mornings build October.",
    "The streak is a record of choices. Keep adding to it.",
    "Consistency is the only thing the road respects.",
    "The Iron Gate is closer today than it was yesterday.",
    "Endurance is not a stat. It is a posture toward difficulty.",
    "Rest when rest is earned. Work when work is due.",
    "The Reaches watch. They do not cheer. They note.",
    "Progress is quiet. So is this app. So is the work.",
    "The Black Spire is visible from here if the weather is right."
  ];

  function getDailyFlavour() {
    /* Deterministic by day-of-year so it changes daily but not on refresh */
    var now  = new Date();
    var doy  = Math.floor((now - new Date(now.getFullYear(), 0, 0)) / 86400000);
    return '"' + HOME_FLAVOUR[doy % HOME_FLAVOUR.length] + '"';
  }

  /* -- Session type readable labels ------------------------- */
  var SESSION_TYPE_LABELS = {
    strength:    'Strength',
    endurance:   'Endurance',
    power:       'Power',
    restoration: 'Restoration',
    mixed:       'Mixed'
  };

  /* -- Build a one-line summary from log entry deltas -------- */
  function buildEntrySummary(entry) {
    var parts = [];
    var d     = entry.deltas || {};
    var order = ['endurance','iron','force','core','resolve','lore'];
    order.forEach(function(s) {
      if ((d[s] || 0) > 0) {
        parts.push(s.charAt(0).toUpperCase() + s.slice(1) + ' +' + d[s].toFixed(1));
      }
    });
    if (!parts.length) return 'No stats recorded';
    return parts.join(' · ');
  }

  /* -- Format date for display ------------------------------- */
  function formatEntryDate(dateStr) {
    if (!dateStr) return '—';
    var d   = new Date(dateStr + 'T00:00:00');
    var opts = { month: 'short', day: 'numeric', year: 'numeric' };
    return d.toLocaleDateString('en-CA', opts);
  }

  /* -- Open The Record --------------------------------------- */
  function openRecord() {
    var data = loadData();
    if (!data) return;

    var log = (data.log || []).slice().reverse(); /* reverse-chronological */

    /* Summary stats */
    var totalSessions = log.length;
    var uniqueDays    = new Set((data.log || []).map(function(e) { return e.date; })).size;
    var totalXp       = data.character.xp || 0;
    var bestStreak    = data.streaks.bestTraining || data.streaks.training || 0;

    document.getElementById('rec-total-sessions').textContent = totalSessions;
    document.getElementById('rec-total-days').textContent     = uniqueDays;
    document.getElementById('rec-best-streak').textContent    = bestStreak;
    document.getElementById('rec-total-xp').textContent       = totalXp;
    document.getElementById('record-count').textContent       =
      totalSessions + (totalSessions === 1 ? ' session logged' : ' sessions logged');

    /* Build entry list */
    var body = document.getElementById('record-body');
    body.innerHTML = '';

    if (!log.length) {
      body.innerHTML = '<div class="record-empty">No sessions logged yet. Begin.</div>';
    } else {
      log.forEach(function(entry, idx) {
        var entryEl = document.createElement('div');
        entryEl.className = 'record-entry';

        var header = document.createElement('div');
        header.className = 'record-entry-header';

        var typeLabel = SESSION_TYPE_LABELS[entry.sessionType] || entry.sessionType || '—';
        var summary   = buildEntrySummary(entry);

        header.innerHTML =
          '<span class="record-entry-date">'    + formatEntryDate(entry.date) + '</span>' +
          '<span class="record-entry-type">'    + typeLabel + '</span>' +
          '<span class="record-entry-summary">' + summary   + '</span>' +
          '<span class="record-entry-chevron">▾</span>';

        /* Expanded detail panel */
        var detail = document.createElement('div');
        detail.className = 'record-entry-detail';

        var d = entry.deltas || {};
        var cells = '';
        var statOrder = ['endurance','iron','force','core','resolve','lore'];
        statOrder.forEach(function(s) {
          var v = d[s] || 0;
          cells +=
            '<div class="record-detail-cell">' +
              '<span class="record-detail-label">' + s + '</span>' +
              '<span class="record-detail-value' + (v > 0 ? ' positive' : '') + '">' +
                (v > 0 ? '+' + v.toFixed(1) : '—') +
              '</span>' +
            '</div>';
        });
        if (entry.manaGain) {
          cells +=
            '<div class="record-detail-cell">' +
              '<span class="record-detail-label">Mana</span>' +
              '<span class="record-detail-value positive">+' + entry.manaGain + '</span>' +
            '</div>';
        }
        detail.innerHTML = '<div class="record-detail-grid">' + cells + '</div>';

        /* Toggle */
        header.addEventListener('click', function() {
          var open = header.classList.contains('open');
          header.classList.toggle('open', !open);
          detail.classList.toggle('open', !open);
        });

        entryEl.appendChild(header);
        entryEl.appendChild(detail);
        body.appendChild(entryEl);
      });
    }

    document.getElementById('recordOverlay').classList.add('visible');
    document.body.style.overflow = 'hidden';
  }

  function closeRecord() {
    document.getElementById('recordOverlay').classList.remove('visible');
    document.body.style.overflow = '';
  }

  /* -- Export Data as JSON backup ---------------------------- */
  function exportData() {
    var data = loadData();
    if (!data) { alert('No data to export.'); return; }

    var json     = JSON.stringify(data, null, 2);
    var blob     = new Blob([json], { type: 'application/json' });
    var url      = URL.createObjectURL(blob);
    var dateStr  = new Date().toISOString().slice(0, 10);
    var filename = 'ashen-reaches-backup-' + dateStr + '.json';

    var a    = document.createElement('a');
    a.href   = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  }

  /* -- Wire The Record button (btns[3]) ---------------------- */
  document.addEventListener('DOMContentLoaded', function() {
    var btns = document.querySelectorAll('.action-btn');
    if (btns[3]) btns[3].addEventListener('click', function() {
      var data = loadData();
      if (data && data.setupComplete) openRecord();
    });
  });

  /* -- Polish: daily flavour text on home screen ------------- */
  var _origPopulateHome5 = populateHomeScreen;
  populateHomeScreen = function(data) {
    _origPopulateHome5(data);
    var flavourEl = document.getElementById('flavourText');
    if (flavourEl) flavourEl.textContent = getDailyFlavour();
  };

  /* -- Polish: track best streak ----------------------------- */
  /* Called after streak increments in commitLog */
  function updateBestStreaks(data) {
    var training = data.streaks.training || 0;
    var resolve  = data.streaks.resolve  || 0;
    if (!data.streaks.bestTraining || training > data.streaks.bestTraining) {
      data.streaks.bestTraining = training;
    }
    if (!data.streaks.bestResolve || resolve > data.streaks.bestResolve) {
      data.streaks.bestResolve = resolve;
    }
  }

  /* -- Polish: apply ordained passive abilities in combat -----
     Gatekeeper's Knowledge: -15% enemy damage Round 1
     Ashwood Pace:            -10% HP loss in sustained rounds (4+)
     Valdenmoor's Weight:     175% strike, 18 Mana (active — added to combat btns)
     Word of the Spire:       400% strike, once per day (active — added to combat btns)
  ----------------------------------------------------------- */

  /* Extend ABILITIES array with ordained active abilities for combat */
  ABILITIES.push(
    { id:'valdenmoors_weight', branch:'ordained', name:"Valdenmoor's Weight",
      type:'active',  levelReq:1, statReq:{},
      cost:18, costLabel:'18 Mana',
      effect:'175% Strike damage.',
      combatEffect:'strike_multiplier', value:1.75 },
    { id:'word_of_spire', branch:'ordained', name:'Word of the Spire',
      type:'active',  levelReq:1, statReq:{},
      cost:30, costLabel:'30 Mana',
      effect:'400% Strike damage. Once per day.',
      combatEffect:'strike_multiplier_once_day', value:4.0 }
  );

  /* Extend combatAbilityAction to handle ordained actives */
  var _origCombatAbility = combatAbilityAction;
  combatAbilityAction = function(abilityId) {
    /* Valdenmoor's Weight */
    if (abilityId === 'valdenmoors_weight') {
      if (!CS.active) return;
      var data = loadData();
      if (!data) return;
      if (CS.mana < 18) { addCombatLog("Not enough Mana for Valdenmoor's Weight.", 'system-note'); return; }
      disableCombatButtons();
      CS.mana -= 18;
      renderCombatManaPips();
      CS.lastAction = abilityId;
      var r = calcPlayerDamage(data, 1.75);
      CS.monsterHp -= r.dmg;
      addCombatLog("Valdenmoor's Weight — " + r.dmg + ' damage (175%).', 'player-action');
      animateMonsterStruck();
      updateCombatBars();
      if (CS.monsterHp <= 0) { resolveVictory(data); return; }
      setTimeout(function() { executeMonsterTurn(data); }, 600);
      return;
    }

    /* Word of the Spire */
    if (abilityId === 'word_of_spire') {
      if (!CS.active) return;
      var data = loadData();
      if (!data) return;
      var today = new Date().toISOString().slice(0,10);
      if (CS.wordOfSourceDate === today) { addCombatLog('Word of the Spire already used today.', 'system-note'); return; }
      if (CS.mana < 30) { addCombatLog('Not enough Mana for Word of the Spire.', 'system-note'); return; }
      disableCombatButtons();
      CS.mana -= 30;
      CS.wordOfSourceDate = today;
      if (!data.abilities) data.abilities = { owned: [] };
      data.abilities.wordOfSourceDate = today;
      saveData(data);
      renderCombatManaPips();
      CS.lastAction = abilityId;
      var r = calcPlayerDamage(data, 4.0);
      CS.monsterHp -= r.dmg;
      addCombatLog('Word of the Spire — ' + r.dmg + ' damage.', 'player-action');
      animateMonsterStruck();
      updateCombatBars();
      if (CS.monsterHp <= 0) { resolveVictory(data); return; }
      setTimeout(function() { executeMonsterTurn(data); }, 600);
      return;
    }

    /* Delegate all others */
    _origCombatAbility(abilityId);
  };

  /* -- Polish: Gatekeeper's Knowledge passively in monster dmg */
  /* Patch calcMonsterDamage inline — add at start of function  */
  var _origCalcMonsterDmg = calcMonsterDamage;
  calcMonsterDamage = function() {
    var dmg = _origCalcMonsterDmg();
    /* Gatekeeper's Knowledge: -15% enemy damage on Round 1 */
    if (CS.round === 1 && hasAbility('gatekeepers_knowledge')) {
      dmg = Math.max(1, Math.round(dmg * 0.85));
      addCombatLog("Gatekeeper's Knowledge: Round 1 damage reduced 15%.", 'system-note');
    }
    /* Ashwood Pace: -10% HP loss in sustained rounds (round 4+) */
    if (CS.round >= 4 && hasAbility('ashwood_pace')) {
      dmg = Math.max(1, Math.round(dmg * 0.90));
    }
    return dmg;
  };

  /* -- Polish: wire updateBestStreaks into commitLog -----------
     We patch the saveData call in commitLog by wrapping it.
     The neatest hook is to extend saveData itself. ------------ */
  var _origSaveData = saveData;
  saveData = function(data) {
    if (data && data.streaks) updateBestStreaks(data);
    _origSaveData(data);
  };

  /* -- Polish: race countdown updates to next upcoming race --- */
  /* The base populateHomeScreen only counts down to May 23.
     Patch it to always show the next upcoming ordained race.    */
  var _origPopulateHome6 = populateHomeScreen;
  populateHomeScreen = function(data) {
    _origPopulateHome6(data);

    var ordained = (data && data.ordained) || {};
    var today    = new Date(); today.setHours(0,0,0,0);

    var nextRace = null;
    for (var i = 0; i < ORDAINED_RACES.length; i++) {
      var r     = ORDAINED_RACES[i];
      var rDate = new Date(r.date + 'T00:00:00');
      if (!ordained[r.id]) { nextRace = { race: r, date: rDate }; break; }
    }

    var el = document.getElementById('daysUntil');
    if (!el) return;

    if (!nextRace) {
      el.innerHTML = 'Complete <span>— Trifecta Done</span>';
      el.style.color = 'var(--ember)';
      return;
    }

    var diff = Math.ceil((nextRace.date - today) / 86400000);
    var name = nextRace.race.name;

    if (diff > 0) {
      el.innerHTML  = diff + ' <span>Days — ' + name + '</span>';
      el.style.color = '';
    } else if (diff === 0) {
      el.innerHTML  = 'Today <span>— ' + name + '</span>';
      el.style.color = 'var(--ember)';
    } else {
      el.innerHTML  = 'Available <span>— ' + name + '</span>';
      el.style.color = 'var(--ironstone)';
    }
  };


  /* ============================================================
     INIT — runs last so all patches and functions are defined
  ============================================================ */
  (function init() {
    var data = loadData();
    if (data && data.setupComplete) {
      document.getElementById('setupOverlay').style.display = 'none';

      /* Phase 4: run streak health checks before displaying home screen */
      checkResolveStreak(data);
      checkRestorationStreak(data);

      /* Re-load after possible saves inside checks */
      data = loadData();

      populateHomeScreen(data);

      /* Phase 4: check for absence tier message */
      checkAbsenceOnLogin(data);
    }
    /* else: setup overlay is already visible by default */
  })();



</script>
</body>
</html>
