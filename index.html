<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>The Ashen Reaches</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=IM+Fell+English:ital@0;1&family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet" />

  <style>
    /* ── Reset & Base ─────────────────────────────────────────── */
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --ash:           #1A1714;
      --ember:         #C45C1A;
      --ironstone:     #8A8478;
      --parchment:     #E8DCC8;
      --bone:          #F0EDE8;
      --ash-mid:       #2A2420;
      --ironstone-dim: #3A3630;
      --leather-dark:  #1E1710;
      --leather-mid:   #2C2018;
      --leather-edge:  #3A2A1C;
      --error:         #a84040;
    }

    html, body {
      height: 100%;
      background: var(--ash);
      color: var(--bone);
      font-family: 'Inter', sans-serif;
      font-size: 15.5px;
      overflow: hidden;
    }

    /* Grain overlay */
    body::before {
      content: '';
      position: fixed; inset: 0;
      background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.85' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)' opacity='1'/%3E%3C/svg%3E");
      opacity: 0.04;
      pointer-events: none;
      z-index: 9999;
    }


    /* ════════════════════════════════════════════════════════════
       SETUP OVERLAY
    ════════════════════════════════════════════════════════════ */
    #setupOverlay {
      position: fixed; inset: 0;
      background: var(--ash);
      z-index: 500;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: opacity 0.6s ease;
    }

    #setupOverlay.hidden {
      opacity: 0;
      pointer-events: none;
    }

    .setup-shell {
      width: 100%;
      max-width: 620px;
      padding: 0 24px;
    }

    /* Progress dots */
    .setup-progress {
      display: flex;
      gap: 8px;
      justify-content: center;
      margin-bottom: 48px;
    }

    .progress-dot {
      width: 6px; height: 6px;
      border-radius: 50%;
      background: var(--ironstone-dim);
      border: 1px solid var(--ironstone-dim);
      transition: background 0.3s, border-color 0.3s;
    }

    .progress-dot.active {
      background: var(--ember);
      border-color: var(--ember);
      box-shadow: 0 0 8px rgba(196,92,26,0.6);
    }

    .progress-dot.done {
      background: var(--ironstone);
      border-color: var(--ironstone);
    }

    /* Individual screen cards */
    .setup-screen {
      display: none;
      animation: fadeIn 0.4s ease;
    }

    .setup-screen.active { display: block; }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to   { opacity: 1; transform: translateY(0); }
    }

    .setup-eyebrow {
      font-size: 0.6rem;
      letter-spacing: 0.45em;
      text-transform: uppercase;
      color: var(--ironstone);
      margin-bottom: 12px;
    }

    .setup-title {
      font-family: 'IM Fell English', serif;
      font-size: 2rem;
      color: var(--parchment);
      line-height: 1.15;
      margin-bottom: 12px;
    }

    .setup-prose {
      font-family: 'IM Fell English', serif;
      font-style: italic;
      font-size: 0.9rem;
      color: var(--ironstone);
      line-height: 1.7;
      margin-bottom: 32px;
    }

    .setup-divider {
      height: 1px;
      background: linear-gradient(to right, transparent, var(--ironstone-dim), transparent);
      margin-bottom: 32px;
    }

    /* Input fields */
    .setup-field { margin-bottom: 24px; }

    .setup-label {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      margin-bottom: 8px;
    }

    .setup-label-text {
      font-size: 0.62rem;
      letter-spacing: 0.35em;
      text-transform: uppercase;
      color: var(--ironstone);
    }

    .setup-char-count {
      font-size: 0.6rem;
      color: var(--ironstone-dim);
      letter-spacing: 0.1em;
    }

    .setup-char-count.warn { color: var(--ember); }

    .setup-input {
      width: 100%;
      background: var(--ash-mid);
      border: 1px solid var(--ironstone-dim);
      border-radius: 2px;
      padding: 12px 14px;
      color: var(--bone);
      font-family: 'IM Fell English', serif;
      font-size: 1rem;
      outline: none;
      transition: border-color 0.2s, box-shadow 0.2s;
    }

    .setup-input::placeholder { color: #4a4540; font-style: italic; }
    .setup-input:focus { border-color: var(--ironstone); box-shadow: 0 0 0 2px rgba(138,132,120,0.15); }
    .setup-input.error { border-color: var(--error); }

    .setup-error {
      font-size: 0.62rem;
      color: var(--error);
      margin-top: 5px;
      letter-spacing: 0.1em;
      display: none;
    }

    .setup-error.visible { display: block; }

    /* Choice buttons */
    .setup-choices { display: grid; gap: 10px; }
    .setup-choices.two-col { grid-template-columns: 1fr 1fr; }

    .choice-btn {
      padding: 16px 20px;
      background: var(--ash-mid);
      border: 1px solid var(--ironstone-dim);
      border-radius: 2px;
      color: var(--bone);
      font-family: 'Inter', sans-serif;
      font-size: 0.75rem;
      letter-spacing: 0.2em;
      text-transform: uppercase;
      cursor: pointer;
      text-align: left;
      transition: border-color 0.2s, background 0.2s;
      position: relative;
    }

    .choice-btn::before {
      content: '';
      position: absolute; top: 0; left: 0; bottom: 0; width: 2px;
      background: var(--ironstone-dim);
      transition: background 0.2s;
    }

    .choice-btn:hover { border-color: var(--ironstone); background: #252018; }

    .choice-btn.selected { border-color: var(--ember); background: rgba(196,92,26,0.08); }
    .choice-btn.selected::before { background: var(--ember); }

    .choice-btn .choice-title { display: block; font-weight: 600; margin-bottom: 4px; }

    .choice-btn .choice-sub {
      font-size: 0.6rem;
      color: var(--ironstone);
      letter-spacing: 0.1em;
      text-transform: none;
      font-weight: 400;
      line-height: 1.5;
    }

    /* Baseline number inputs */
    .baseline-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px; }

    .baseline-field { display: flex; flex-direction: column; gap: 6px; }

    .baseline-label {
      font-size: 0.6rem; letter-spacing: 0.3em;
      text-transform: uppercase; color: var(--ironstone);
    }

    .baseline-sublabel {
      font-size: 0.58rem; color: var(--ironstone-dim);
      font-family: 'IM Fell English', serif; font-style: italic;
    }

    .setup-number {
      width: 100%;
      background: var(--ash-mid);
      border: 1px solid var(--ironstone-dim);
      border-radius: 2px;
      padding: 10px 12px;
      color: var(--bone);
      font-family: 'Inter', sans-serif;
      font-size: 1rem; font-weight: 500;
      outline: none;
      transition: border-color 0.2s;
      -moz-appearance: textfield;
    }

    .setup-number::-webkit-outer-spin-button,
    .setup-number::-webkit-inner-spin-button { -webkit-appearance: none; }
    .setup-number:focus { border-color: var(--ironstone); }

    .baseline-unit { font-size: 0.6rem; color: var(--ironstone); letter-spacing: 0.15em; }

    .setup-skip {
      font-size: 0.62rem; letter-spacing: 0.2em; text-transform: uppercase;
      color: var(--ironstone-dim);
      background: none; border: none; cursor: pointer; padding: 0; margin-top: 12px;
      text-decoration: underline; text-underline-offset: 3px;
      transition: color 0.2s;
    }

    .setup-skip:hover { color: var(--ironstone); }

    /* Nav row */
    .setup-nav {
      display: flex; justify-content: space-between; align-items: center;
      margin-top: 36px;
    }

    .nav-back {
      font-size: 0.62rem; letter-spacing: 0.25em; text-transform: uppercase;
      color: var(--ironstone);
      background: none; border: none; cursor: pointer; padding: 0;
      transition: color 0.2s;
    }

    .nav-back:hover { color: var(--bone); }
    .nav-back:disabled { opacity: 0; pointer-events: none; }

    .nav-forward {
      padding: 12px 28px;
      background: linear-gradient(135deg, var(--leather-edge), var(--leather-dark));
      border: 1px solid var(--ironstone-dim);
      border-radius: 2px;
      color: var(--bone);
      font-family: 'Inter', sans-serif;
      font-size: 0.72rem; letter-spacing: 0.25em; text-transform: uppercase; font-weight: 600;
      cursor: pointer;
      position: relative; overflow: hidden;
      transition: border-color 0.2s, background 0.2s;
    }

    .nav-forward::before {
      content: '';
      position: absolute; top: 0; left: 0; bottom: 0; width: 2px;
      background: var(--ironstone);
      transition: background 0.2s;
    }

    .nav-forward:hover { border-color: rgba(196,92,26,0.6); background: linear-gradient(135deg, #382818, #1e1208); }
    .nav-forward:hover::before { background: var(--ember); }
    .nav-forward.final { border-color: rgba(196,92,26,0.4); color: var(--ember); }


    /* ════════════════════════════════════════════════════════════
       HOME SCREEN
    ════════════════════════════════════════════════════════════ */
    .app {
      display: grid;
      grid-template-rows: auto auto 1fr auto;
      height: 100vh;
      max-width: 1440px;
      margin: 0 auto;
    }

    /* Hero */
    .hero { position: relative; width: 100%; height: 38vh; overflow: hidden; }

    .hero-image {
      width: 100%; height: 100%;
      background:
        linear-gradient(to bottom, var(--ash) 0%, transparent 25%, transparent 60%, var(--ash) 100%),
        linear-gradient(to right,  var(--ash) 0%, transparent 12%, transparent 88%, var(--ash) 100%),
        linear-gradient(165deg, #0e0d0c 0%, #1a1614 20%, #2a2218 35%, #1e1a14 50%, #140f0a 65%, #0a0908 85%, #060504 100%);
      background-size: cover, cover, cover;
      background-position: center;
    }

    .hero-scene { position: absolute; inset: 0; overflow: hidden; }

    .hero-scene::before {
      content: '';
      position: absolute; top: 0; left: 0; right: 0; height: 55%;
      background: linear-gradient(180deg, #0c0b0a 0%, #1a1815 40%, #22201b 100%);
    }

    .hero-scene::after {
      content: '';
      position: absolute; bottom: 0; left: 0; right: 0; height: 48%;
      background: linear-gradient(180deg, #1a1714 0%, #141210 100%);
    }

    .dead-tree {
      position: absolute; bottom: 38%; left: 18%;
      width: 3px; height: 120px; background: #0d0c0a;
      transform-origin: bottom center;
    }

    .dead-tree::before, .dead-tree::after { content: ''; position: absolute; background: #0d0c0a; }

    .dead-tree::before {
      top: 28px; left: -18px; width: 2px; height: 55px;
      transform: rotate(-35deg); transform-origin: bottom right;
    }

    .dead-tree::after {
      top: 50px; right: -24px; width: 2px; height: 40px;
      transform: rotate(40deg); transform-origin: bottom left;
    }

    .ember-glow {
      position: absolute; bottom: 42%; right: 26%;
      width: 80px; height: 30px;
      background: radial-gradient(ellipse at center, rgba(196,92,26,0.18) 0%, transparent 70%);
      animation: flicker 4s ease-in-out infinite;
    }

    @keyframes flicker {
      0%, 100% { opacity: 0.6; transform: scaleX(1); }
      50%       { opacity: 1;   transform: scaleX(1.2); }
    }

    .road {
      position: absolute; bottom: 38%; left: 50%; transform: translateX(-50%);
      width: 4px; height: 80px;
      background: linear-gradient(to top, transparent, rgba(50,45,38,0.5));
    }

    .hero-vignette {
      position: absolute; inset: 0;
      background:
        linear-gradient(to bottom, var(--ash) 0%, transparent 22%, transparent 55%, var(--ash) 100%),
        linear-gradient(to right,  var(--ash) 0%, transparent 14%, transparent 86%, var(--ash) 100%);
    }

    .hero-title {
      position: absolute; top: 50%; left: 50%;
      transform: translate(-50%, -50%);
      text-align: center; pointer-events: none; z-index: 2;
    }

    .hero-title h1 {
      font-family: 'IM Fell English', serif;
      font-size: clamp(2rem, 4vw, 3.4rem);
      color: var(--parchment);
      letter-spacing: 0.22em; text-transform: uppercase;
      text-shadow: 0 0 60px rgba(0,0,0,0.9), 0 2px 4px rgba(0,0,0,0.8);
      line-height: 1;
    }

    .hero-title .subtitle {
      font-family: 'Inter', sans-serif;
      font-size: 0.65rem; letter-spacing: 0.35em; text-transform: uppercase;
      color: var(--ironstone); margin-top: 8px;
    }

    /* Flavour band */
    .flavour-band {
      position: relative; padding: 14px 40px; text-align: center;
      background:
        linear-gradient(135deg, #2a2418 25%, transparent 25%) -6px 0,
        linear-gradient(225deg, #2a2418 25%, transparent 25%) -6px 0,
        linear-gradient(315deg, #2a2418 25%, transparent 25%),
        linear-gradient(45deg,  #2a2418 25%, transparent 25%);
      background-size: 12px 12px;
      background-color: #231e17;
      border-top: 1px solid rgba(74,82,64,0.3);
      border-bottom: 1px solid rgba(74,82,64,0.3);
    }

    .flavour-band::before, .flavour-band::after {
      content: ''; position: absolute; top: 0; bottom: 0; width: 80px; pointer-events: none;
    }

    .flavour-band::before { left: 0;  background: linear-gradient(to right, var(--ash), transparent); }
    .flavour-band::after  { right: 0; background: linear-gradient(to left, var(--ash), transparent); }

    .flavour-text {
      font-family: 'IM Fell English', serif;
      font-style: italic; font-size: 1.05rem;
      color: var(--parchment); opacity: 0.85;
    }

    /* Panel row */
    .panel-row {
      display: grid; grid-template-columns: 260px 1fr 220px;
      gap: 2px; padding: 2px 0;
      background: rgba(0,0,0,0.4); min-height: 0;
    }

    .panel { padding: 20px 22px; position: relative; overflow: hidden; }

    .panel-label {
      font-size: 0.62rem; letter-spacing: 0.45em; text-transform: uppercase;
      color: var(--ironstone); margin-bottom: 14px; padding-bottom: 8px;
      border-bottom: 1px solid var(--ironstone-dim);
    }

    .stone {
      background:
        radial-gradient(ellipse at top left, #2a2720 0%, transparent 60%),
        radial-gradient(ellipse at bottom right, #1a1714 0%, transparent 50%),
        #1e1b18;
    }

    .stone::before {
      content: ''; position: absolute; inset: 0;
      background-image:
        repeating-linear-gradient(85deg, transparent 0px, transparent 18px, rgba(255,255,255,0.008) 18px, rgba(255,255,255,0.008) 19px),
        repeating-linear-gradient(5deg,  transparent 0px, transparent 32px, rgba(0,0,0,0.08) 32px, rgba(0,0,0,0.08) 33px);
      pointer-events: none;
    }

    .leather {
      background:
        radial-gradient(ellipse at top, #2e2014 0%, transparent 50%),
        radial-gradient(ellipse at bottom left, #1a1008 0%, transparent 60%),
        var(--leather-mid);
    }

    .leather::before {
      content: ''; position: absolute; inset: 0;
      background-image: repeating-linear-gradient(45deg, transparent, transparent 3px, rgba(0,0,0,0.06) 3px, rgba(0,0,0,0.06) 4px);
      pointer-events: none;
    }

    .leather::after {
      content: ''; position: absolute; top: 0; left: 0; bottom: 0; width: 3px;
      background: linear-gradient(180deg, transparent 0%, rgba(196,92,26,0.12) 30%, rgba(196,92,26,0.08) 70%, transparent 100%);
    }

    /* Left panel */
    .panel-character { display: flex; flex-direction: column; }

    .char-name {
      font-family: 'IM Fell English', serif; font-size: 1.35rem;
      color: var(--parchment); line-height: 1.1; margin-bottom: 4px;
    }

    .char-origin { font-size: 0.7rem; color: var(--ironstone); font-style: italic; margin-bottom: 20px; line-height: 1.5; }

    .char-meta { display: flex; flex-direction: column; gap: 14px; }

    .meta-row { display: flex; justify-content: space-between; align-items: center; }

    .meta-label { font-size: 0.64rem; letter-spacing: 0.3em; text-transform: uppercase; color: var(--ironstone); }

    .meta-value { font-size: 0.95rem; font-weight: 600; color: var(--bone); }
    .meta-value.ember { color: var(--ember); }

    .xp-bar-wrap { display: flex; flex-direction: column; gap: 5px; }

    .xp-bar-track { height: 4px; background: var(--ironstone-dim); border-radius: 2px; overflow: hidden; }

    .xp-bar-fill {
      height: 100%; width: 0%;
      background: linear-gradient(90deg, var(--ember), #d4721f);
      border-radius: 2px; box-shadow: 0 0 6px rgba(196,92,26,0.5);
    }

    .xp-label { font-size: 0.6rem; color: var(--ironstone); letter-spacing: 0.2em; }

    .mana-row { margin-top: 4px; }

    .mana-pips { display: flex; gap: 3px; flex-wrap: wrap; margin-top: 5px; }

    .mana-pip {
      width: 8px; height: 8px; border-radius: 50%;
      background: var(--ironstone-dim); border: 1px solid rgba(74,82,64,0.5);
    }

    .mana-pip.filled {
      background: radial-gradient(circle, #6a8a9a, #4a6878);
      border-color: #5a7888; box-shadow: 0 0 4px rgba(90,120,140,0.4);
    }

    .next-race { margin-top: auto; padding-top: 14px; border-top: 1px solid var(--ironstone-dim); }

    .race-title { font-family: 'IM Fell English', serif; font-size: 0.8rem; color: var(--parchment); margin-bottom: 3px; }

    .race-meta { font-size: 0.6rem; color: var(--ironstone); letter-spacing: 0.15em; }

    .race-days { font-size: 1.4rem; font-weight: 600; color: var(--bone); line-height: 1; margin-top: 4px; }

    .race-days span { font-size: 0.6rem; font-weight: 400; color: var(--ironstone); letter-spacing: 0.2em; text-transform: uppercase; margin-left: 4px; }

    /* Centre panel */
    .panel-stats { border-left: 1px solid rgba(74,82,64,0.15); border-right: 1px solid rgba(74,82,64,0.15); }

    .stats-grid { display: flex; flex-direction: column; gap: 12px; }

    .stat-row { display: grid; grid-template-columns: 110px 1fr 38px; align-items: center; gap: 10px; }

    .stat-name { font-size: 0.66rem; letter-spacing: 0.3em; text-transform: uppercase; color: var(--ironstone); }

    .stat-world-name {
      display: block; font-family: 'IM Fell English', serif;
      font-size: 0.74rem; color: var(--parchment); opacity: 0.55;
      margin-top: 2px; letter-spacing: 0.05em;
    }

    .stat-bar-track { height: 6px; background: var(--ironstone-dim); border-radius: 3px; overflow: hidden; position: relative; }

    .stat-bar-fill { height: 100%; border-radius: 3px; background: linear-gradient(90deg, #3a4a32, #5a6a50); position: relative; transition: width 0.8s ease; }

    .stat-bar-fill::after { content: ''; position: absolute; top: 0; right: 0; width: 2px; height: 100%; background: rgba(255,255,255,0.3); }

    .stat-bar-fill.endurance { background: linear-gradient(90deg, #3a5a3a, #5a8a5a); }
    .stat-bar-fill.iron      { background: linear-gradient(90deg, #4a4a5a, #6a6a8a); }
    .stat-bar-fill.force     { background: linear-gradient(90deg, #5a3a2a, #8a5a3a); }
    .stat-bar-fill.core      { background: linear-gradient(90deg, #4a4a3a, #6a6a5a); }
    .stat-bar-fill.resolve   { background: linear-gradient(90deg, #3a2a4a, #6a4a8a); box-shadow: 0 0 8px rgba(106,74,138,0.4); }
    .stat-bar-fill.lore      { background: linear-gradient(90deg, #2a3a4a, #4a6a8a); }

    .stat-value { font-size: 0.85rem; font-weight: 500; color: var(--bone); text-align: right; }

    .readiness-wrap { margin-top: 16px; padding-top: 14px; border-top: 1px solid var(--ironstone-dim); }

    .readiness-inner { display: flex; justify-content: space-between; align-items: center; }

    .readiness-label { font-size: 0.6rem; letter-spacing: 0.35em; text-transform: uppercase; color: var(--ironstone); }

    .readiness-score { font-size: 1.6rem; font-weight: 600; color: var(--ember); text-shadow: 0 0 20px rgba(196,92,26,0.35); line-height: 1; }

    .readiness-sub { font-size: 0.6rem; color: var(--ironstone); text-align: right; margin-top: 2px; }

    .readiness-bar-track { margin-top: 8px; height: 3px; background: var(--ironstone-dim); border-radius: 2px; overflow: hidden; }

    .readiness-bar-fill { height: 100%; width: 0%; background: linear-gradient(90deg, var(--ember), #d4721f); box-shadow: 0 0 8px rgba(196,92,26,0.5); border-radius: 2px; }

    /* Right panel */
    .panel-actions { display: flex; flex-direction: column; gap: 10px; justify-content: center; }

    .action-btn {
      display: block; width: 100%; padding: 14px 16px;
      background: linear-gradient(135deg, var(--leather-edge) 0%, var(--leather-dark) 100%);
      border: 1px solid rgba(74,82,64,0.35); border-radius: 2px;
      color: var(--bone); font-family: 'Inter', sans-serif;
      font-size: 0.75rem; letter-spacing: 0.25em; text-transform: uppercase;
      cursor: pointer; text-align: left; position: relative; overflow: hidden;
      transition: border-color 0.2s, background 0.2s;
    }

    .action-btn::before {
      content: ''; position: absolute; top: 0; left: 0; bottom: 0; width: 2px;
      background: var(--ironstone); transition: background 0.2s, width 0.2s;
    }

    .action-btn:hover { border-color: rgba(196,92,26,0.5); background: linear-gradient(135deg, #382818 0%, #1e1208 100%); }
    .action-btn:hover::before { background: var(--ember); width: 3px; }

    .action-btn .btn-title { display: block; font-weight: 600; margin-bottom: 3px; }
    .action-btn .btn-sub { font-size: 0.58rem; color: var(--ironstone); letter-spacing: 0.15em; }
    .action-btn.primary .btn-title { color: var(--ember); }
    .panel-actions .panel-label { border-bottom-color: rgba(196,92,26,0.2); }

    /* Phase badge */
    .phase-badge {
      display: inline-flex; align-items: center; gap: 6px;
      background: rgba(196,92,26,0.1); border: 1px solid rgba(196,92,26,0.25);
      border-radius: 2px; padding: 3px 8px;
      font-size: 0.58rem; letter-spacing: 0.2em; text-transform: uppercase;
      color: var(--ember); margin-bottom: 14px;
    }

    .phase-dot {
      width: 5px; height: 5px; border-radius: 50%;
      background: var(--ember); box-shadow: 0 0 6px rgba(196,92,26,0.8);
      animation: pulse 2s ease-in-out infinite;
    }

    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.4; } }

    .corner-mark { position: absolute; width: 10px; height: 10px; }
    .corner-mark.tl { top: 8px; left: 8px;   border-top: 1px solid var(--ironstone); border-left: 1px solid var(--ironstone); }
    .corner-mark.br { bottom: 8px; right: 8px; border-bottom: 1px solid var(--ironstone); border-right: 1px solid var(--ironstone); }

    /* Streak band */
    .streak-band {
      display: grid; grid-template-columns: 1fr 1fr 1fr;
      background: #131110; border-top: 1px solid var(--ironstone-dim);
    }

    .streak-item { display: flex; justify-content: space-between; align-items: center; padding: 10px 24px; }

    .streak-item + .streak-item { border-left: 1px solid var(--ironstone-dim); }

    .streak-label { font-size: 0.62rem; letter-spacing: 0.4em; text-transform: uppercase; color: var(--ironstone); }

    .streak-number { font-size: 1.1rem; font-weight: 600; color: var(--bone); line-height: 1; }
    .streak-number span { font-size: 0.6rem; font-weight: 400; color: var(--ironstone); margin-left: 2px; }

    /* ════════════════════════════════════════════════════════════
       LOGGING SCREEN OVERLAY
    ════════════════════════════════════════════════════════════ */
    #logOverlay {
      position: fixed; inset: 0;
      background: var(--ash);
      z-index: 400;
      display: none;
      flex-direction: column;
      overflow: hidden;
    }

    #logOverlay.visible { display: flex; }

    .log-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 14px 28px;
      background: #131110;
      border-bottom: 1px solid var(--ironstone-dim);
      flex-shrink: 0;
    }

    .log-header-left { display: flex; flex-direction: column; gap: 3px; }

    .log-header-title {
      font-family: 'IM Fell English', serif;
      font-size: 1.25rem;
      color: var(--parchment);
      line-height: 1;
    }

    .log-header-date {
      font-size: 0.6rem;
      letter-spacing: 0.3em;
      text-transform: uppercase;
      color: var(--ironstone);
    }

    .log-session-type {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .log-session-label {
      font-size: 0.6rem;
      letter-spacing: 0.3em;
      text-transform: uppercase;
      color: var(--ironstone);
    }

    .log-session-select {
      background: var(--ash-mid);
      border: 1px solid var(--ironstone-dim);
      border-radius: 2px;
      color: var(--bone);
      font-family: 'Inter', sans-serif;
      font-size: 0.72rem;
      letter-spacing: 0.15em;
      padding: 6px 10px;
      outline: none;
      cursor: pointer;
    }

    .log-session-select:focus { border-color: var(--ironstone); }

    .log-close-btn {
      background: none;
      border: 1px solid var(--ironstone-dim);
      border-radius: 2px;
      color: var(--ironstone);
      font-family: 'Inter', sans-serif;
      font-size: 0.6rem;
      letter-spacing: 0.3em;
      text-transform: uppercase;
      padding: 7px 14px;
      cursor: pointer;
      transition: border-color 0.2s, color 0.2s;
    }

    .log-close-btn:hover { border-color: var(--ironstone); color: var(--bone); }

    .log-body {
      flex: 1;
      overflow-y: auto;
      padding: 20px 28px 0;
      scrollbar-width: thin;
      scrollbar-color: var(--ironstone-dim) transparent;
    }

    .log-body::-webkit-scrollbar { width: 4px; }
    .log-body::-webkit-scrollbar-track { background: transparent; }
    .log-body::-webkit-scrollbar-thumb { background: var(--ironstone-dim); border-radius: 2px; }

    .log-section {
      border: 1px solid var(--ironstone-dim);
      border-radius: 2px;
      margin-bottom: 8px;
      overflow: hidden;
    }

    .log-section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 16px;
      cursor: pointer;
      background: #1e1b18;
      transition: background 0.15s;
      user-select: none;
    }

    .log-section-header:hover { background: #252118; }
    .log-section-header.open { background: #252118; border-bottom: 1px solid var(--ironstone-dim); }

    .log-section-title-group { display: flex; align-items: center; gap: 12px; }

    .log-section-name {
      font-size: 0.68rem;
      letter-spacing: 0.3em;
      text-transform: uppercase;
      color: var(--bone);
      font-weight: 600;
    }

    .log-section-world {
      font-family: 'IM Fell English', serif;
      font-style: italic;
      font-size: 0.78rem;
      color: var(--ironstone);
    }

    .log-section-stat { display: flex; align-items: center; gap: 8px; }

    .log-stat-chip {
      font-size: 0.6rem;
      letter-spacing: 0.15em;
      color: var(--ironstone);
      padding: 2px 7px;
      border: 1px solid var(--ironstone-dim);
      border-radius: 10px;
    }

    .log-chevron {
      font-size: 0.6rem;
      color: var(--ironstone);
      transition: transform 0.2s;
    }

    .log-section-header.open .log-chevron { transform: rotate(180deg); }

    .log-section-body {
      display: none;
      padding: 16px;
      background: #1a1714;
    }

    .log-section-body.open { display: block; }

    .log-activity { margin-bottom: 18px; }
    .log-activity:last-child { margin-bottom: 0; }

    .log-activity-title {
      font-size: 0.6rem;
      letter-spacing: 0.3em;
      text-transform: uppercase;
      color: var(--ironstone);
      margin-bottom: 10px;
      padding-bottom: 6px;
      border-bottom: 1px solid var(--ironstone-dim);
    }

    .log-field-row {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 8px;
      flex-wrap: wrap;
    }

    .log-field-group {
      display: flex;
      flex-direction: column;
      gap: 4px;
      flex: 1;
      min-width: 80px;
    }

    .log-field-label {
      font-size: 0.58rem;
      letter-spacing: 0.2em;
      text-transform: uppercase;
      color: var(--ironstone);
    }

    .log-input {
      width: 100%;
      background: var(--ash-mid);
      border: 1px solid var(--ironstone-dim);
      border-radius: 2px;
      padding: 8px 10px;
      color: var(--bone);
      font-family: 'Inter', sans-serif;
      font-size: 0.9rem;
      font-weight: 500;
      outline: none;
      transition: border-color 0.2s;
      -moz-appearance: textfield;
    }

    .log-input::-webkit-outer-spin-button,
    .log-input::-webkit-inner-spin-button { -webkit-appearance: none; }
    .log-input:focus { border-color: var(--ironstone); }

    .log-input-unit {
      font-size: 0.6rem;
      color: var(--ironstone);
      letter-spacing: 0.15em;
      white-space: nowrap;
      align-self: flex-end;
      padding-bottom: 9px;
    }

    .log-select {
      background: var(--ash-mid);
      border: 1px solid var(--ironstone-dim);
      border-radius: 2px;
      color: var(--bone);
      font-family: 'Inter', sans-serif;
      font-size: 0.82rem;
      padding: 8px 10px;
      outline: none;
      flex: 1;
    }

    .log-select:focus { border-color: var(--ironstone); }

    .log-target {
      font-size: 0.6rem;
      color: var(--ironstone);
      letter-spacing: 0.15em;
      margin-top: 3px;
    }

    .log-target.hit { color: var(--ember); }

    .set-rows { display: flex; flex-direction: column; gap: 6px; margin-bottom: 8px; }

    .set-row { display: flex; align-items: center; gap: 8px; }

    .set-label {
      font-size: 0.6rem;
      letter-spacing: 0.2em;
      color: var(--ironstone);
      width: 44px;
      flex-shrink: 0;
    }

    .set-input {
      width: 80px;
      background: var(--ash-mid);
      border: 1px solid var(--ironstone-dim);
      border-radius: 2px;
      padding: 7px 10px;
      color: var(--bone);
      font-family: 'Inter', sans-serif;
      font-size: 0.9rem;
      font-weight: 500;
      outline: none;
      transition: border-color 0.2s;
      -moz-appearance: textfield;
    }

    .set-input::-webkit-outer-spin-button,
    .set-input::-webkit-inner-spin-button { -webkit-appearance: none; }
    .set-input:focus { border-color: var(--ironstone); }

    .set-unit { font-size: 0.6rem; color: var(--ironstone); letter-spacing: 0.1em; }

    .set-remove {
      background: none; border: none;
      color: var(--ironstone-dim); font-size: 0.75rem;
      cursor: pointer; padding: 4px; line-height: 1;
      transition: color 0.2s;
    }

    .set-remove:hover { color: var(--error); }

    .add-set-btn {
      background: none;
      border: 1px dashed var(--ironstone-dim);
      border-radius: 2px;
      color: var(--ironstone);
      font-family: 'Inter', sans-serif;
      font-size: 0.6rem;
      letter-spacing: 0.25em;
      text-transform: uppercase;
      padding: 6px 12px;
      cursor: pointer;
      transition: border-color 0.2s, color 0.2s;
      width: 100%;
      text-align: center;
    }

    .add-set-btn:hover { border-color: var(--ironstone); color: var(--bone); }

    .log-checkbox-row {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 8px;
    }

    .log-checkbox {
      width: 16px; height: 16px;
      background: var(--ash-mid);
      border: 1px solid var(--ironstone-dim);
      border-radius: 2px;
      appearance: none;
      -webkit-appearance: none;
      cursor: pointer;
      flex-shrink: 0;
      position: relative;
      transition: background 0.15s, border-color 0.15s;
    }

    .log-checkbox:checked {
      background: var(--ember);
      border-color: var(--ember);
    }

    .log-checkbox:checked::after {
      content: '✓';
      position: absolute; top: -1px; left: 2px;
      font-size: 0.7rem; color: #fff; font-weight: 700;
    }

    .log-checkbox-label {
      font-size: 0.72rem;
      color: var(--bone);
      cursor: pointer;
      letter-spacing: 0.05em;
    }

    .spartan-confirm {
      display: flex;
      align-items: flex-start;
      gap: 10px;
      padding: 10px 12px;
      background: rgba(196,92,26,0.05);
      border: 1px solid rgba(196,92,26,0.2);
      border-radius: 2px;
      margin-top: 8px;
    }

    .spartan-confirm .log-checkbox-label {
      font-size: 0.65rem;
      color: var(--ironstone);
      line-height: 1.5;
    }

    .log-footer {
      padding: 16px 28px;
      background: #131110;
      border-top: 1px solid var(--ironstone-dim);
      display: flex;
      justify-content: flex-end;
      flex-shrink: 0;
    }

    .commit-btn {
      padding: 13px 36px;
      background: linear-gradient(135deg, var(--leather-edge), var(--leather-dark));
      border: 1px solid rgba(196,92,26,0.4);
      border-radius: 2px;
      color: var(--ember);
      font-family: 'Inter', sans-serif;
      font-size: 0.75rem;
      letter-spacing: 0.35em;
      text-transform: uppercase;
      font-weight: 700;
      cursor: pointer;
      position: relative;
      overflow: hidden;
      transition: background 0.2s, border-color 0.2s, box-shadow 0.2s;
    }

    .commit-btn::before {
      content: '';
      position: absolute; top: 0; left: 0; bottom: 0; width: 2px;
      background: var(--ember);
    }

    .commit-btn:hover {
      background: linear-gradient(135deg, #382818, #1e1208);
      border-color: rgba(196,92,26,0.7);
      box-shadow: 0 0 20px rgba(196,92,26,0.2);
    }

    /* ════════════════════════════════════════════════════════════
       STAT SUMMARY SCREEN
    ════════════════════════════════════════════════════════════ */
    #summaryOverlay {
      position: fixed; inset: 0;
      background: var(--ash);
      z-index: 450;
      display: none;
      align-items: center;
      justify-content: center;
    }

    #summaryOverlay.visible { display: flex; }

    .summary-shell {
      width: 100%;
      max-width: 560px;
      padding: 0 24px;
    }

    .summary-heading {
      font-family: 'IM Fell English', serif;
      font-size: 1.8rem;
      color: var(--parchment);
      margin-bottom: 6px;
      text-align: center;
    }

    .summary-date {
      text-align: center;
      font-size: 0.6rem;
      letter-spacing: 0.35em;
      text-transform: uppercase;
      color: var(--ironstone);
      margin-bottom: 32px;
    }

    .summary-divider {
      height: 1px;
      background: linear-gradient(to right, transparent, var(--ironstone-dim), transparent);
      margin-bottom: 28px;
    }

    .summary-stats { display: flex; flex-direction: column; gap: 10px; margin-bottom: 28px; }

    .summary-stat-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 14px;
      background: #1e1b18;
      border: 1px solid var(--ironstone-dim);
      border-radius: 2px;
    }

    .summary-stat-name {
      font-size: 0.62rem;
      letter-spacing: 0.3em;
      text-transform: uppercase;
      color: var(--ironstone);
    }

    .summary-stat-change { display: flex; align-items: center; gap: 14px; }

    .summary-old { font-size: 0.85rem; color: var(--ironstone); }
    .summary-arrow { font-size: 0.7rem; color: var(--ironstone-dim); }
    .summary-new { font-size: 1rem; font-weight: 600; color: var(--bone); }

    .summary-delta {
      font-size: 0.8rem;
      font-weight: 600;
      color: var(--ember);
      min-width: 40px;
      text-align: right;
    }

    .summary-flavour {
      font-family: 'IM Fell English', serif;
      font-style: italic;
      font-size: 0.95rem;
      color: var(--ironstone);
      text-align: center;
      line-height: 1.7;
      margin-bottom: 32px;
      padding: 0 16px;
    }

    .summary-return-btn {
      display: block;
      width: 100%;
      padding: 14px;
      background: linear-gradient(135deg, var(--leather-edge), var(--leather-dark));
      border: 1px solid var(--ironstone-dim);
      border-radius: 2px;
      color: var(--bone);
      font-family: 'Inter', sans-serif;
      font-size: 0.7rem;
      letter-spacing: 0.3em;
      text-transform: uppercase;
      font-weight: 600;
      cursor: pointer;
      text-align: center;
      transition: border-color 0.2s, background 0.2s;
    }

    .summary-return-btn:hover {
      border-color: rgba(196,92,26,0.5);
      background: linear-gradient(135deg, #382818, #1e1208);
    }


  </style>
</head>
<body>


<!-- ══════════════════════════════════════════════════════════════
     SETUP OVERLAY — shown on first visit only
══════════════════════════════════════════════════════════════ -->
<div id="setupOverlay">
  <div class="setup-shell">

    <div class="setup-progress">
      <div class="progress-dot active" id="dot-0"></div>
      <div class="progress-dot"        id="dot-1"></div>
      <div class="progress-dot"        id="dot-2"></div>
      <div class="progress-dot"        id="dot-3"></div>
      <div class="progress-dot"        id="dot-4"></div>
    </div>

    <!-- Screen 1: Name -->
    <div class="setup-screen active" id="screen-0">
      <p class="setup-eyebrow">The Ashen Reaches &nbsp;·&nbsp; First Steps</p>
      <h2 class="setup-title">Who are you called?</h2>
      <p class="setup-prose">Before the road begins, before the first step into the cold grey wilderness — you need a name. Not the one given to you. The one you carry into the dark.</p>
      <div class="setup-divider"></div>

      <div class="setup-field">
        <div class="setup-label">
          <span class="setup-label-text">Warrior's Name</span>
        </div>
        <input type="text" class="setup-input" id="input-name"
               placeholder="Enter your warrior's name…"
               maxlength="40" autocomplete="off" />
        <p class="setup-error" id="err-name">A name is required to proceed.</p>
      </div>

      <div class="setup-nav">
        <button class="nav-back" disabled>← Back</button>
        <button class="nav-forward" id="btn-next-0" onclick="goNext(0)">Onward →</button>
      </div>
    </div>

    <!-- Screen 2: Origin -->
    <div class="setup-screen" id="screen-1">
      <p class="setup-eyebrow">The Ashen Reaches &nbsp;·&nbsp; First Steps</p>
      <h2 class="setup-title">Where do you come from?</h2>
      <p class="setup-prose">The Reaches do not ask about your past — but you carry it regardless. One sentence. Who were you before this story began?</p>
      <div class="setup-divider"></div>

      <div class="setup-field">
        <div class="setup-label">
          <span class="setup-label-text">Your Origin</span>
          <span class="setup-char-count" id="count-origin">0 / 100</span>
        </div>
        <input type="text" class="setup-input" id="input-origin"
               placeholder="e.g. A father who let the years get soft around him…"
               maxlength="100" autocomplete="off" />
        <p class="setup-error" id="err-origin">An origin is required — even one sentence will do.</p>
      </div>

      <div class="setup-nav">
        <button class="nav-back" onclick="goBack(1)">← Back</button>
        <button class="nav-forward" onclick="goNext(1)">Onward →</button>
      </div>
    </div>

    <!-- Screen 3: Vow -->
    <div class="setup-screen" id="screen-2">
      <p class="setup-eyebrow">The Ashen Reaches &nbsp;·&nbsp; First Steps</p>
      <h2 class="setup-title">What drives you forward?</h2>
      <p class="setup-prose">Every warrior in the Reaches carries a vow — the thing that keeps them moving when the road is cold and the reasons feel distant. State yours plainly. One sentence.</p>
      <div class="setup-divider"></div>

      <div class="setup-field">
        <div class="setup-label">
          <span class="setup-label-text">Your Vow</span>
          <span class="setup-char-count" id="count-vow">0 / 100</span>
        </div>
        <input type="text" class="setup-input" id="input-vow"
               placeholder="e.g. To prove to my children that the body can be rebuilt…"
               maxlength="100" autocomplete="off" />
        <p class="setup-error" id="err-vow">A vow is required — what are you fighting for?</p>
      </div>

      <div class="setup-nav">
        <button class="nav-back" onclick="goBack(2)">← Back</button>
        <button class="nav-forward" onclick="goNext(2)">Onward →</button>
      </div>
    </div>

    <!-- Screen 4: Units -->
    <div class="setup-screen" id="screen-3">
      <p class="setup-eyebrow">The Ashen Reaches &nbsp;·&nbsp; First Steps</p>
      <h2 class="setup-title">How do you measure the road?</h2>
      <p class="setup-prose">These choices cannot be changed after setup without resetting all your logged data. Choose carefully.</p>
      <div class="setup-divider"></div>

      <div class="setup-field">
        <div class="setup-label">
          <span class="setup-label-text">Distance</span>
        </div>
        <div class="setup-choices two-col">
          <button class="choice-btn selected" data-group="distance" data-value="km" onclick="selectChoice(this)">
            <span class="choice-title">Kilometres</span>
            <span class="choice-sub">km — used in most Spartan events internationally</span>
          </button>
          <button class="choice-btn" data-group="distance" data-value="miles" onclick="selectChoice(this)">
            <span class="choice-title">Miles</span>
            <span class="choice-sub">mi — familiar if you trained in the US</span>
          </button>
        </div>
      </div>

      <div class="setup-field">
        <div class="setup-label">
          <span class="setup-label-text">Weight</span>
        </div>
        <div class="setup-choices two-col">
          <button class="choice-btn selected" data-group="weight" data-value="kg" onclick="selectChoice(this)">
            <span class="choice-title">Kilograms</span>
            <span class="choice-sub">kg — standard metric</span>
          </button>
          <button class="choice-btn" data-group="weight" data-value="lbs" onclick="selectChoice(this)">
            <span class="choice-title">Pounds</span>
            <span class="choice-sub">lbs — familiar if you trained in the US</span>
          </button>
        </div>
      </div>

      <div class="setup-nav">
        <button class="nav-back" onclick="goBack(3)">← Back</button>
        <button class="nav-forward" onclick="goNext(3)">Onward →</button>
      </div>
    </div>

    <!-- Screen 5: Baseline -->
    <div class="setup-screen" id="screen-4">
      <p class="setup-eyebrow">The Ashen Reaches &nbsp;·&nbsp; First Steps</p>
      <h2 class="setup-title">Where do you stand today?</h2>
      <p class="setup-prose">Your honest Day 1 numbers. They anchor the baseline your stats grow from. Leave any field blank if you don't know — the system will begin from zero.</p>
      <div class="setup-divider"></div>

      <div class="baseline-grid">

        <div class="baseline-field">
          <span class="baseline-label">Best Hang Time</span>
          <span class="baseline-sublabel">Iron · The Iron Hand</span>
          <input type="number" class="setup-number" id="baseline-hang" min="0" max="999" placeholder="0" />
          <span class="baseline-unit">seconds</span>
        </div>

        <div class="baseline-field">
          <span class="baseline-label">Best Push-up Set</span>
          <span class="baseline-sublabel">Force · The Bearing</span>
          <input type="number" class="setup-number" id="baseline-pushups" min="0" max="999" placeholder="0" />
          <span class="baseline-unit">reps</span>
        </div>

        <div class="baseline-field">
          <span class="baseline-label">Best Run Distance</span>
          <span class="baseline-sublabel">Endurance · The Long Road</span>
          <input type="number" class="setup-number" id="baseline-run" min="0" max="9999" step="0.1" placeholder="0" />
          <span class="baseline-unit" id="baseline-run-unit">km</span>
        </div>

      </div>

      <div style="margin-top: 24px;">
        <button class="setup-skip" onclick="skipBaseline()">Skip — I'll start from zero</button>
      </div>

      <div class="setup-nav">
        <button class="nav-back" onclick="goBack(4)">← Back</button>
        <button class="nav-forward final" onclick="completeSetup()">Enter the Reaches →</button>
      </div>
    </div>

  </div>
</div>



<!-- ══════════════════════════════════════════════════════════════
     LOGGING SCREEN OVERLAY
══════════════════════════════════════════════════════════════ -->
<div id="logOverlay">

  <!-- Header -->
  <div class="log-header">
    <div class="log-header-left">
      <div class="log-header-title">Today's Reckoning</div>
      <div class="log-header-date" id="log-date-display">—</div>
    </div>
    <div class="log-session-type">
      <span class="log-session-label">Session Type</span>
      <select class="log-session-select" id="sessionType">
        <option value="strength">Strength</option>
        <option value="endurance">Endurance</option>
        <option value="power">Power</option>
        <option value="restoration">Restoration</option>
        <option value="mixed">Mixed</option>
      </select>
    </div>
    <button class="log-close-btn" onclick="closeLog()">✕ Close</button>
  </div>

  <!-- Scrollable sections -->
  <div class="log-body">

    <!-- ── ENDURANCE ──────────────────────────────────────── -->
    <div class="log-section">
      <div class="log-section-header" onclick="toggleSection(this)">
        <div class="log-section-title-group">
          <span class="log-section-name">Endurance</span>
          <span class="log-section-world">The Long Road</span>
        </div>
        <div class="log-section-stat">
          <span class="log-stat-chip" id="chip-endurance">0</span>
          <span class="log-chevron">▼</span>
        </div>
      </div>
      <div class="log-section-body">

        <div class="log-activity">
          <div class="log-activity-title">Running</div>
          <div class="log-field-row">
            <div class="log-field-group">
              <label class="log-field-label">Distance</label>
              <input type="number" class="log-input" id="run-distance" min="0" step="0.1" placeholder="0">
            </div>
            <span class="log-input-unit" id="run-dist-unit">km</span>
            <div class="log-field-group">
              <label class="log-field-label">Time (min)</label>
              <input type="number" class="log-input" id="run-min" min="0" max="999" placeholder="0">
            </div>
            <div class="log-field-group">
              <label class="log-field-label">Time (sec)</label>
              <input type="number" class="log-input" id="run-sec" min="0" max="59" placeholder="0">
            </div>
          </div>
          <div class="log-field-row">
            <div class="log-field-group">
              <label class="log-field-label">Run Type</label>
              <select class="log-select" id="run-type">
                <option value="">— Select —</option>
                <option value="easy">Easy</option>
                <option value="tempo">Tempo</option>
                <option value="race_sim">Race Simulation</option>
              </select>
            </div>
          </div>
        </div>

        <div class="log-activity">
          <div class="log-activity-title">Stationary Bike</div>
          <div class="log-field-row">
            <div class="log-field-group">
              <label class="log-field-label">Duration</label>
              <input type="number" class="log-input" id="bike-duration" min="0" placeholder="0">
            </div>
            <span class="log-input-unit">min</span>
            <div class="log-field-group">
              <label class="log-field-label">Resistance Level</label>
              <input type="number" class="log-input" id="bike-resistance" min="0" max="30" placeholder="0">
            </div>
          </div>
        </div>

        <div class="log-activity">
          <div class="log-activity-title">Burpees</div>
          <div class="log-field-row">
            <div class="log-field-group">
              <label class="log-field-label">Total Burpees</label>
              <input type="number" class="log-input" id="burpees-total" min="0" placeholder="0">
            </div>
          </div>
          <div class="spartan-confirm">
            <input type="checkbox" class="log-checkbox" id="burpees-spartan">
            <label class="log-checkbox-label" for="burpees-spartan">
              Spartan standard confirmed — chest to floor, full jump on each rep. <em>(Unchecked = 50% stat value.)</em>
            </label>
          </div>
        </div>

      </div>
    </div>

    <!-- ── IRON ───────────────────────────────────────────── -->
    <div class="log-section">
      <div class="log-section-header" onclick="toggleSection(this)">
        <div class="log-section-title-group">
          <span class="log-section-name">Iron</span>
          <span class="log-section-world">The Iron Hand</span>
        </div>
        <div class="log-section-stat">
          <span class="log-stat-chip" id="chip-iron">0</span>
          <span class="log-chevron">▼</span>
        </div>
      </div>
      <div class="log-section-body">

        <div class="log-activity">
          <div class="log-activity-title">Hang Time</div>
          <div class="log-field-row">
            <div class="log-field-group">
              <label class="log-field-label">Best Hang (session)</label>
              <input type="number" class="log-input" id="hang-best" min="0" placeholder="0">
            </div>
            <span class="log-input-unit">sec</span>
            <div class="log-field-group">
              <label class="log-field-label">Attempts</label>
              <input type="number" class="log-input" id="hang-attempts" min="0" placeholder="0">
            </div>
          </div>
          <div class="log-target" id="target-hang">Target: — sec</div>
        </div>

        <div class="log-activity">
          <div class="log-activity-title">Pull-ups</div>
          <div class="set-rows" id="pullup-sets"></div>
          <button class="add-set-btn" onclick="addSet('pullup-sets','pullup','reps')">+ Add Set</button>
        </div>

        <div class="log-activity">
          <div class="log-activity-title">Farmer Carries</div>
          <div class="log-field-row">
            <div class="log-field-group">
              <label class="log-field-label">Duration</label>
              <input type="number" class="log-input" id="carry-duration" min="0" placeholder="0">
            </div>
            <span class="log-input-unit">min</span>
            <div class="log-field-group">
              <label class="log-field-label">Weight per hand</label>
              <input type="number" class="log-input" id="carry-weight" min="0" step="0.5" placeholder="0">
            </div>
            <span class="log-input-unit" id="carry-weight-unit">kg</span>
          </div>
        </div>

      </div>
    </div>

    <!-- ── FORCE ──────────────────────────────────────────── -->
    <div class="log-section">
      <div class="log-section-header" onclick="toggleSection(this)">
        <div class="log-section-title-group">
          <span class="log-section-name">Force</span>
          <span class="log-section-world">The Bearing</span>
        </div>
        <div class="log-section-stat">
          <span class="log-stat-chip" id="chip-force">0</span>
          <span class="log-chevron">▼</span>
        </div>
      </div>
      <div class="log-section-body">

        <div class="log-activity">
          <div class="log-activity-title">Push-ups</div>
          <div class="set-rows" id="pushup-sets"></div>
          <button class="add-set-btn" onclick="addSet('pushup-sets','pushup','reps')">+ Add Set</button>
          <div class="log-target" id="target-pushups">Target: — reps</div>
        </div>

        <div class="log-activity">
          <div class="log-activity-title">Goblet Squats <span style="color:var(--ironstone);font-size:0.6rem;letter-spacing:0.1em;"> — 25 lb fixed</span></div>
          <div class="set-rows" id="goblet-sets"></div>
          <button class="add-set-btn" onclick="addSet('goblet-sets','goblet','reps')">+ Add Set</button>
        </div>

        <div class="log-activity">
          <div class="log-activity-title">Bodyweight Squats</div>
          <div class="set-rows" id="squat-sets"></div>
          <button class="add-set-btn" onclick="addSet('squat-sets','squat','reps')">+ Add Set</button>
        </div>

        <div class="log-activity">
          <div class="log-activity-title">Step-ups</div>
          <div class="log-field-row">
            <div class="log-field-group">
              <label class="log-field-label">Total Reps (both legs)</label>
              <input type="number" class="log-input" id="stepup-reps" min="0" placeholder="0">
            </div>
            <div class="log-field-group">
              <label class="log-field-label">Step Height</label>
              <select class="log-select" id="stepup-height">
                <option value="">— Select —</option>
                <option value="low">Low</option>
                <option value="medium">Medium</option>
                <option value="high">High</option>
              </select>
            </div>
          </div>
        </div>

        <div class="log-activity">
          <div class="log-activity-title">Resistance Band Work</div>
          <div class="log-checkbox-row">
            <input type="checkbox" class="log-checkbox" id="band-completed">
            <label class="log-checkbox-label" for="band-completed">Completed resistance band work this session</label>
          </div>
        </div>

      </div>
    </div>

    <!-- ── CORE ───────────────────────────────────────────── -->
    <div class="log-section">
      <div class="log-section-header" onclick="toggleSection(this)">
        <div class="log-section-title-group">
          <span class="log-section-name">Core</span>
          <span class="log-section-world">The Foundation</span>
        </div>
        <div class="log-section-stat">
          <span class="log-stat-chip" id="chip-core">0</span>
          <span class="log-chevron">▼</span>
        </div>
      </div>
      <div class="log-section-body">

        <div class="log-activity">
          <div class="log-activity-title">Plank</div>
          <div class="log-field-row">
            <div class="log-field-group">
              <label class="log-field-label">Best Hold (session)</label>
              <input type="number" class="log-input" id="plank-best" min="0" placeholder="0">
            </div>
            <span class="log-input-unit">sec</span>
            <div class="log-field-group">
              <label class="log-field-label">Attempts</label>
              <input type="number" class="log-input" id="plank-attempts" min="0" placeholder="0">
            </div>
          </div>
          <div class="log-target" id="target-plank">Target: — sec</div>
        </div>

        <div class="log-activity">
          <div class="log-activity-title">Hollow Body Hold</div>
          <div class="log-field-row">
            <div class="log-field-group">
              <label class="log-field-label">Best Hold</label>
              <input type="number" class="log-input" id="hollow-best" min="0" placeholder="0">
            </div>
            <span class="log-input-unit">sec</span>
          </div>
        </div>

        <div class="log-activity">
          <div class="log-activity-title">Dead Bugs</div>
          <div class="log-field-row">
            <div class="log-field-group">
              <label class="log-field-label">Total Reps</label>
              <input type="number" class="log-input" id="deadbug-reps" min="0" placeholder="0">
            </div>
            <span class="log-input-unit">reps</span>
          </div>
        </div>

        <div class="log-activity">
          <div class="log-activity-title">Bear Crawls</div>
          <div class="log-field-row">
            <div class="log-field-group">
              <label class="log-field-label">Duration</label>
              <input type="number" class="log-input" id="bearcrawl-sec" min="0" placeholder="0">
            </div>
            <span class="log-input-unit">sec</span>
            <div class="log-field-group">
              <label class="log-field-label">— OR — Distance</label>
              <input type="number" class="log-input" id="bearcrawl-m" min="0" placeholder="0">
            </div>
            <span class="log-input-unit">m</span>
          </div>
        </div>

        <div class="log-activity">
          <div class="log-activity-title">Additional Core Work</div>
          <div class="log-checkbox-row">
            <input type="checkbox" class="log-checkbox" id="core-additional">
            <label class="log-checkbox-label" for="core-additional">Completed additional core work not listed above</label>
          </div>
        </div>

      </div>
    </div>

    <!-- ── POWER ──────────────────────────────────────────── -->
    <div class="log-section">
      <div class="log-section-header" onclick="toggleSection(this)">
        <div class="log-section-title-group">
          <span class="log-section-name">Power</span>
          <span class="log-section-world">Endurance + Force</span>
        </div>
        <div class="log-section-stat">
          <span class="log-stat-chip" id="chip-power">Phase <span id="power-phase-label">1</span></span>
          <span class="log-chevron">▼</span>
        </div>
      </div>
      <div class="log-section-body">

        <div class="log-activity">
          <div class="log-activity-title">Plyometrics / Foot Contacts</div>
          <div class="log-field-row">
            <div class="log-field-group">
              <label class="log-field-label">Total Foot Contacts</label>
              <input type="number" class="log-input" id="power-contacts" min="0" placeholder="0">
            </div>
            <span class="log-input-unit">contacts</span>
          </div>
        </div>

        <div class="log-activity" id="power-sprint-section" style="display:none;">
          <div class="log-activity-title">Sprint Intervals <span style="color:var(--ironstone);font-size:0.6rem;"> — Phase 3 only</span></div>
          <div class="log-field-row">
            <div class="log-field-group">
              <label class="log-field-label">Intervals</label>
              <input type="number" class="log-input" id="sprint-intervals" min="0" placeholder="0">
            </div>
            <div class="log-field-group">
              <label class="log-field-label">Work (sec)</label>
              <input type="number" class="log-input" id="sprint-work" min="0" placeholder="0">
            </div>
            <div class="log-field-group">
              <label class="log-field-label">Rest (sec)</label>
              <input type="number" class="log-input" id="sprint-rest" min="0" placeholder="0">
            </div>
          </div>
        </div>

      </div>
    </div>

    <!-- ── RESOLVE ────────────────────────────────────────── -->
    <div class="log-section">
      <div class="log-section-header" onclick="toggleSection(this)">
        <div class="log-section-title-group">
          <span class="log-section-name">Resolve</span>
          <span class="log-section-world">The Source</span>
        </div>
        <div class="log-section-stat">
          <span class="log-stat-chip" id="chip-resolve">0</span>
          <span class="log-chevron">▼</span>
        </div>
      </div>
      <div class="log-section-body">

        <div class="log-activity">
          <div class="log-activity-title">Prayer</div>
          <div class="log-checkbox-row">
            <input type="checkbox" class="log-checkbox" id="prayer-done">
            <label class="log-checkbox-label" for="prayer-done">Prayer completed today</label>
          </div>
          <div class="log-field-row" style="margin-top:6px;">
            <div class="log-field-group" style="max-width:120px;">
              <label class="log-field-label">Duration (optional)</label>
              <input type="number" class="log-input" id="prayer-duration" min="0" placeholder="0">
            </div>
            <span class="log-input-unit">min</span>
          </div>
        </div>

        <div class="log-activity">
          <div class="log-activity-title">Journaling</div>
          <div class="log-checkbox-row">
            <input type="checkbox" class="log-checkbox" id="journal-done">
            <label class="log-checkbox-label" for="journal-done">Journaling completed today</label>
          </div>
        </div>

        <div class="log-activity">
          <div class="log-activity-title">Reading</div>
          <div class="log-checkbox-row">
            <input type="checkbox" class="log-checkbox" id="reading-done">
            <label class="log-checkbox-label" for="reading-done">Reading completed today</label>
          </div>
          <div class="log-field-row" style="margin-top:6px;">
            <div class="log-field-group" style="max-width:120px;">
              <label class="log-field-label">Pages read (optional)</label>
              <input type="number" class="log-input" id="reading-pages" min="0" placeholder="0">
            </div>
            <span class="log-input-unit">pages</span>
          </div>
        </div>

      </div>
    </div>

    <!-- spacer so last section isn't flush against footer -->
    <div style="height: 12px;"></div>

  </div><!-- /log-body -->

  <!-- Commit footer -->
  <div class="log-footer">
    <button class="commit-btn" onclick="commitLog()">Commit</button>
  </div>

</div><!-- /logOverlay -->


<!-- ══════════════════════════════════════════════════════════════
     STAT SUMMARY SCREEN
══════════════════════════════════════════════════════════════ -->
<div id="summaryOverlay">
  <div class="summary-shell">
    <div class="summary-heading">Today's reckoning.</div>
    <div class="summary-date" id="summary-date-display">—</div>
    <div class="summary-divider"></div>
    <div class="summary-stats" id="summary-stats-list"></div>
    <div class="summary-flavour" id="summary-flavour-text">—</div>
    <button class="summary-return-btn" onclick="closeSummary()">Return</button>
  </div>
</div>


<!-- ══════════════════════════════════════════════════════════════
     HOME SCREEN
══════════════════════════════════════════════════════════════ -->
<div class="app" id="homeScreen">

  <div class="hero">
    <div class="hero-scene">
      <div class="dead-tree"></div>
      <div class="ember-glow"></div>
      <div class="road"></div>
    </div>
    <div class="hero-image"></div>
    <div class="hero-vignette"></div>
    <div class="hero-title">
      <h1>The Ashen Reaches</h1>
      <p class="subtitle">Road to the Spartan Trifecta &nbsp;·&nbsp; 2025</p>
    </div>
  </div>

  <div class="flavour-band">
    <p class="flavour-text" id="flavourText">"You are here. That is more than most. Begin."</p>
  </div>

  <div class="panel-row">

    <div class="panel stone panel-character">
      <div class="corner-mark tl"></div>
      <div class="corner-mark br"></div>
      <div class="panel-label">Warrior</div>

      <div class="phase-badge">
        <span class="phase-dot"></span>
        Foundation Phase
      </div>

      <div class="char-name" id="display-name">—</div>
      <p class="char-origin" id="display-origin">—</p>

      <div class="char-meta">
        <div class="meta-row">
          <span class="meta-label">Character Level</span>
          <span class="meta-value ember">I</span>
        </div>

        <div class="xp-bar-wrap">
          <div class="meta-row">
            <span class="meta-label">Experience</span>
            <span class="meta-value" style="font-size:0.75rem">0 / 200 XP</span>
          </div>
          <div class="xp-bar-track">
            <div class="xp-bar-fill" style="width:0%"></div>
          </div>
          <span class="xp-label">Next Level: 200 XP required</span>
        </div>

        <div class="mana-row">
          <div class="meta-row">
            <span class="meta-label">Mana</span>
            <span class="meta-value" style="font-size:0.75rem" id="mana-display">0 / 33</span>
          </div>
          <div class="mana-pips" id="manaPips"></div>
        </div>

        <div class="next-race">
          <div class="panel-label" style="margin:0 0 8px; padding:0; border:none;">Next Reckoning</div>
          <div class="race-title">Trial of the Iron Gate</div>
          <div class="race-meta">Spartan 5K Sprint · May 23, 2025</div>
          <div class="race-days" id="daysUntil">—</div>
        </div>
      </div>
    </div>

    <div class="panel stone panel-stats">
      <div class="panel-label">Character Stats</div>
      <div class="stats-grid">

        <div class="stat-row">
          <div class="stat-name">Endurance<span class="stat-world-name">The Long Road</span></div>
          <div class="stat-bar-track"><div class="stat-bar-fill endurance" id="bar-endurance" style="width:0%"></div></div>
          <div class="stat-value" id="val-endurance">0</div>
        </div>

        <div class="stat-row">
          <div class="stat-name">Iron<span class="stat-world-name">The Iron Hand</span></div>
          <div class="stat-bar-track"><div class="stat-bar-fill iron" id="bar-iron" style="width:0%"></div></div>
          <div class="stat-value" id="val-iron">0</div>
        </div>

        <div class="stat-row">
          <div class="stat-name">Force<span class="stat-world-name">The Bearing</span></div>
          <div class="stat-bar-track"><div class="stat-bar-fill force" id="bar-force" style="width:0%"></div></div>
          <div class="stat-value" id="val-force">0</div>
        </div>

        <div class="stat-row">
          <div class="stat-name">Core<span class="stat-world-name">The Foundation</span></div>
          <div class="stat-bar-track"><div class="stat-bar-fill core" id="bar-core" style="width:0%"></div></div>
          <div class="stat-value" id="val-core">0</div>
        </div>

        <div class="stat-row">
          <div class="stat-name">Resolve<span class="stat-world-name">The Source</span></div>
          <div class="stat-bar-track"><div class="stat-bar-fill resolve" id="bar-resolve" style="width:0%"></div></div>
          <div class="stat-value" id="val-resolve">0</div>
        </div>

        <div class="stat-row">
          <div class="stat-name">Lore<span class="stat-world-name">The Knowing</span></div>
          <div class="stat-bar-track"><div class="stat-bar-fill lore" id="bar-lore" style="width:0%"></div></div>
          <div class="stat-value" id="val-lore">0</div>
        </div>

      </div>

      <div class="readiness-wrap">
        <div class="readiness-inner">
          <div>
            <div class="readiness-label">Readiness Score</div>
            <div style="font-size:0.6rem;color:var(--ironstone);margin-top:2px;">Weighted for Trial of the Iron Gate</div>
          </div>
          <div>
            <div class="readiness-score" id="readiness-score">0</div>
            <div class="readiness-sub">/ 100</div>
          </div>
        </div>
        <div class="readiness-bar-track">
          <div class="readiness-bar-fill" id="readiness-bar" style="width:0%"></div>
        </div>
      </div>
    </div>

    <div class="panel leather panel-actions">
      <div class="panel-label">The Road</div>

      <button class="action-btn primary">
        <span class="btn-title">Log Training</span>
        <span class="btn-sub">Record today's session</span>
      </button>

      <button class="action-btn">
        <span class="btn-title">Venture Out</span>
        <span class="btn-sub">Face what waits in the dark</span>
      </button>

      <button class="action-btn">
        <span class="btn-title">The World</span>
        <span class="btn-sub">Survey the Ashen Reaches</span>
      </button>

      <button class="action-btn" style="margin-top:8px;">
        <span class="btn-title">The Record</span>
        <span class="btn-sub">Your history in full</span>
      </button>
    </div>

  </div>

  <div class="streak-band">
    <div class="streak-item">
      <span class="streak-label">Training Streak</span>
      <span class="streak-number" id="streak-training">0 <span>Days</span></span>
    </div>
    <div class="streak-item">
      <span class="streak-label">Resolve Streak</span>
      <span class="streak-number" id="streak-resolve">0 <span>Days</span></span>
    </div>
    <div class="streak-item">
      <span class="streak-label">Restoration Streak</span>
      <span class="streak-number" id="streak-restoration">0 <span>Weeks</span></span>
    </div>
  </div>

</div>


<script>
  /* ════════════════════════════════════════════════════════════
     STORAGE
  ════════════════════════════════════════════════════════════ */
  const STORAGE_KEY = 'ashenReaches_v1';

  function loadData() {
    try {
      const raw = localStorage.getItem(STORAGE_KEY);
      return raw ? JSON.parse(raw) : null;
    } catch(e) { return null; }
  }

  function saveData(data) {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
  }

  /* ════════════════════════════════════════════════════════════
     SETUP STATE
  ════════════════════════════════════════════════════════════ */
  const setupData = { name:'', origin:'', vow:'', distance:'km', weight:'kg', baseline:{hang:0,pushups:0,run:0} };
  let currentScreen = 0;

  /* Character counters */
  document.getElementById('input-origin').addEventListener('input', function() {
    const c = document.getElementById('count-origin');
    c.textContent = this.value.length + ' / 100';
    c.classList.toggle('warn', this.value.length > 85);
  });

  document.getElementById('input-vow').addEventListener('input', function() {
    const c = document.getElementById('count-vow');
    c.textContent = this.value.length + ' / 100';
    c.classList.toggle('warn', this.value.length > 85);
  });

  /* Enter key advances screens */
  document.querySelectorAll('.setup-input, .setup-number').forEach(function(el) {
    el.addEventListener('keydown', function(e) {
      if (e.key === 'Enter') {
        const btn = document.querySelector('#screen-' + currentScreen + ' .nav-forward');
        if (btn) btn.click();
      }
    });
  });

  /* Progress dots */
  function updateDots(active) {
    for (let i = 0; i < 5; i++) {
      const d = document.getElementById('dot-' + i);
      d.classList.remove('active','done');
      if (i < active)       d.classList.add('done');
      else if (i === active) d.classList.add('active');
    }
  }

  /* Forward */
  function goNext(idx) {
    if (idx === 0) {
      const v = document.getElementById('input-name').value.trim();
      if (!v) { showErr('err-name','input-name'); return; }
      setupData.name = v;
      hideErr('err-name','input-name');
    }
    if (idx === 1) {
      const v = document.getElementById('input-origin').value.trim();
      if (!v) { showErr('err-origin','input-origin'); return; }
      setupData.origin = v;
      hideErr('err-origin','input-origin');
    }
    if (idx === 2) {
      const v = document.getElementById('input-vow').value.trim();
      if (!v) { showErr('err-vow','input-vow'); return; }
      setupData.vow = v;
      hideErr('err-vow','input-vow');
    }

    document.getElementById('screen-' + idx).classList.remove('active');
    currentScreen = idx + 1;
    document.getElementById('screen-' + currentScreen).classList.add('active');
    updateDots(currentScreen);

    if (currentScreen === 4) {
      document.getElementById('baseline-run-unit').textContent = setupData.distance;
    }
  }

  /* Back */
  function goBack(idx) {
    document.getElementById('screen-' + idx).classList.remove('active');
    currentScreen = idx - 1;
    document.getElementById('screen-' + currentScreen).classList.add('active');
    updateDots(currentScreen);
  }

  /* Unit choice */
  function selectChoice(btn) {
    const group = btn.getAttribute('data-group');
    document.querySelectorAll('[data-group="' + group + '"]').forEach(function(b) { b.classList.remove('selected'); });
    btn.classList.add('selected');
    setupData[group] = btn.getAttribute('data-value');
  }

  /* Skip baseline */
  function skipBaseline() {
    setupData.baseline = { hang:0, pushups:0, run:0 };
    completeSetup();
  }

  /* Complete setup */
  function completeSetup() {
    setupData.baseline = {
      hang:    parseFloat(document.getElementById('baseline-hang').value)    || 0,
      pushups: parseFloat(document.getElementById('baseline-pushups').value) || 0,
      run:     parseFloat(document.getElementById('baseline-run').value)     || 0
    };

    const gameData = {
      setupComplete: true,
      createdAt: new Date().toISOString(),
      warrior: {
        name:     setupData.name,
        origin:   setupData.origin,
        vow:      setupData.vow,
        distance: setupData.distance,
        weight:   setupData.weight
      },
      baseline: setupData.baseline,
      stats: { endurance:0, iron:0, force:0, core:0, resolve:0, lore:0 },
      character: { level:1, xp:0, hp:50, maxHp:50, mana:0, maxMana:33 },
      streaks: {
        training:0, resolve:0, restoration:0,
        lastTrainingDate:null, lastResolveDate:null, lastRestorationWeek:null
      },
      log: []
    };

    saveData(gameData);

    const overlay = document.getElementById('setupOverlay');
    overlay.classList.add('hidden');
    setTimeout(function() {
      overlay.style.display = 'none';
      populateHomeScreen(gameData);
    }, 600);
  }

  /* ════════════════════════════════════════════════════════════
     HOME SCREEN POPULATION
  ════════════════════════════════════════════════════════════ */
  function populateHomeScreen(data) {
    /* Name and origin */
    document.getElementById('display-name').textContent   = data.warrior.name;
    document.getElementById('display-origin').textContent = data.warrior.origin;

    /* Stats */
    var stats = data.stats;
    ['endurance','iron','force','core','resolve','lore'].forEach(function(s) {
      var val = stats[s] || 0;
      document.getElementById('val-' + s).textContent         = val;
      document.getElementById('bar-' + s).style.width         = val + '%';
    });

    /* Readiness — Sprint race weights */
    var r = Math.round(
      stats.endurance * 0.25 +
      stats.iron      * 0.15 +
      stats.force     * 0.20 +
      stats.core      * 0.15 +
      stats.resolve   * 0.15 +
      stats.lore      * 0.10
    );
    document.getElementById('readiness-score').textContent   = r;
    document.getElementById('readiness-bar').style.width     = r + '%';

    /* Mana pips */
    var pipContainer = document.getElementById('manaPips');
    pipContainer.innerHTML = '';
    var maxMana  = data.character.maxMana;
    var currMana = data.character.mana;
    document.getElementById('mana-display').textContent = currMana + ' / ' + maxMana;
    for (var i = 0; i < maxMana; i++) {
      var pip = document.createElement('div');
      pip.className = 'mana-pip' + (i < currMana ? ' filled' : '');
      pipContainer.appendChild(pip);
    }

    /* Streaks */
    document.getElementById('streak-training').innerHTML    = data.streaks.training    + ' <span>Days</span>';
    document.getElementById('streak-resolve').innerHTML     = data.streaks.resolve     + ' <span>Days</span>';
    document.getElementById('streak-restoration').innerHTML = data.streaks.restoration + ' <span>Weeks</span>';

    /* Race countdown */
    var raceDate = new Date('2025-05-23');
    var today    = new Date(); today.setHours(0,0,0,0);
    var diff     = Math.ceil((raceDate - today) / 86400000);
    var el       = document.getElementById('daysUntil');
    if (diff > 0)       el.innerHTML = diff + ' <span>Days</span>';
    else if (diff === 0){ el.innerHTML = 'Today <span>— The Gate Opens</span>'; el.style.color = 'var(--ember)'; }
    else                { el.innerHTML = 'Complete <span>— Battle Available</span>'; el.style.color = 'var(--ironstone)'; }
  }

  /* ════════════════════════════════════════════════════════════
     HELPERS
  ════════════════════════════════════════════════════════════ */
  function showErr(errId, inputId) {
    document.getElementById(errId).classList.add('visible');
    document.getElementById(inputId).classList.add('error');
    document.getElementById(inputId).focus();
  }

  function hideErr(errId, inputId) {
    document.getElementById(errId).classList.remove('visible');
    document.getElementById(inputId).classList.remove('error');
  }

  /* ════════════════════════════════════════════════════════════
     INIT
  ════════════════════════════════════════════════════════════ */
  (function init() {
    var data = loadData();
    if (data && data.setupComplete) {
      document.getElementById('setupOverlay').style.display = 'none';
      populateHomeScreen(data);
    }
    /* else: setup overlay is already visible by default */
  })();

  /* ════════════════════════════════════════════════════════════
     PHASE 3 — LOGGING SCREEN
  ════════════════════════════════════════════════════════════ */

  /* ── Flavour text banks ─────────────────────────────────── */
  var FLAVOUR = {
    strength:    ["The weight does not care about your reasons. You moved it anyway.",
                  "Strength is not built in the moment you lift. It is built in the moment you chose to.",
                  "The body remembers what the mind forgets. You gave it something to remember.",
                  "Nothing about today was certain. You made it certain anyway.",
                  "You are not stronger today than yesterday. You are less weak.",
                  "The bar does not move itself. Neither does anything worth having.",
                  "Hard work in the dark builds the same muscle as hard work in the light.",
                  "The Reaches demand more than intention. Today you delivered."],
    endurance:   ["The road remembers every foot that crossed it. So does yours.",
                  "Distance is just time made visible. You spent it well.",
                  "Lungs that burned today will not burn the same way next time.",
                  "You did not stop. That is all the Reaches asked of you.",
                  "Running teaches the body one thing above all: that it can.",
                  "What you built today cannot be taken from you. Only neglected.",
                  "Endurance is not the absence of pain. It is the decision to continue through it.",
                  "The distance behind you is the only argument that matters."],
    power:       ["Something changed in the way you land. The ground noticed.",
                  "Explosiveness is controlled violence. You are learning the control.",
                  "The first jump is faith. Every jump after that is evidence.",
                  "Power is not just force. It is force arriving precisely.",
                  "The hills of the Reaches do not yield. Neither, today, did you.",
                  "Speed is built in fragments. Each fragment matters.",
                  "You are teaching your body to fall correctly. That is harder than it sounds.",
                  "The sprint ends. The capacity to sprint again is what you are building."],
    restoration: ["A warrior who cannot rest cannot fight. You rested.",
                  "Maintenance is not weakness. The blade that is never sharpened does not cut.",
                  "What you preserved today, you will need in October.",
                  "The Reaches are patient. They will still be here after you have healed.",
                  "Stillness is not absence. It is preparation wearing different clothes.",
                  "You gave the body what it asked for. It will remember.",
                  "Recovery is training. Slow down enough to believe that.",
                  "The quiet day builds the same character as the hard one. It just does it differently."],
    mixed:       ["Not every day gives everything. This one gave what it gave.",
                  "Variety is honest. You trained what needed training.",
                  "The Reaches do not require perfection. Only presence.",
                  "Different demands. Same answer: you showed up.",
                  "A mixed day is still a day that happened. It counts.",
                  "Not your best session. Not your last, either.",
                  "The work was uneven. It was still work.",
                  "You came. You did something. That is not nothing."]
  };

  function randomFlavour(sessionType) {
    var bank = FLAVOUR[sessionType] || FLAVOUR.mixed;
    return '"' + bank[Math.floor(Math.random() * bank.length)] + '"';
  }

  /* ── Determine Power phase by date ─────────────────────── */
  function getPowerPhase() {
    var now = new Date();
    var apr1  = new Date('2025-04-01');
    var apr21 = new Date('2025-04-21');
    if (now >= apr21) return 3;
    if (now >= apr1)  return 2;
    return 1;
  }

  /* ── Section toggle ─────────────────────────────────────── */
  function toggleSection(header) {
    var body = header.nextElementSibling;
    var isOpen = header.classList.contains('open');
    header.classList.toggle('open', !isOpen);
    body.classList.toggle('open', !isOpen);
  }

  /* ── Repeating set rows ─────────────────────────────────── */
  function addSet(containerId, prefix, unit) {
    var container = document.getElementById(containerId);
    var count = container.querySelectorAll('.set-row').length;
    if (count >= 10) return;
    var idx = count + 1;
    var row = document.createElement('div');
    row.className = 'set-row';
    row.innerHTML =
      '<span class="set-label">Set ' + idx + '</span>' +
      '<input type="number" class="set-input" data-set="' + prefix + '" min="0" placeholder="0" style="-moz-appearance:textfield;">' +
      '<span class="set-unit">' + unit + '</span>' +
      '<button class="set-remove" onclick="removeSet(this)" title="Remove">✕</button>';
    container.appendChild(row);
    renumberSets(container);
  }

  function removeSet(btn) {
    var row = btn.closest('.set-row');
    var container = row.parentElement;
    row.remove();
    renumberSets(container);
  }

  function renumberSets(container) {
    container.querySelectorAll('.set-row').forEach(function(r, i) {
      r.querySelector('.set-label').textContent = 'Set ' + (i + 1);
    });
  }

  function getSetValues(containerId) {
    var vals = [];
    document.getElementById(containerId).querySelectorAll('.set-input').forEach(function(inp) {
      var v = parseFloat(inp.value) || 0;
      if (v > 0) vals.push(v);
    });
    return vals;
  }

  /* ── Open the log screen ────────────────────────────────── */
  function openLog() {
    var data = loadData();
    if (!data) return;

    /* Set date */
    var now = new Date();
    var opts = { weekday:'long', year:'numeric', month:'long', day:'numeric' };
    document.getElementById('log-date-display').textContent = now.toLocaleDateString('en-CA', opts).toUpperCase();
    document.getElementById('summary-date-display').textContent = now.toLocaleDateString('en-CA', opts).toUpperCase();

    /* Units */
    var distUnit   = data.warrior.distance || 'km';
    var weightUnit = data.warrior.weight   || 'kg';
    document.getElementById('run-dist-unit').textContent    = distUnit;
    document.getElementById('carry-weight-unit').textContent = weightUnit;

    /* Stat chips — current values */
    ['endurance','iron','force','core','resolve'].forEach(function(s) {
      var el = document.getElementById('chip-' + s);
      if (el) el.textContent = data.stats[s] || 0;
    });

    /* Targets from baseline */
    var hangTarget   = (data.baseline.hang    || 0) + 3;
    var pushTarget   = (data.baseline.pushups || 0) + 2;
    var plankTarget  = (data.targets && data.targets.plank)  || 30;

    document.getElementById('target-hang').textContent    = 'Target: ' + hangTarget + ' sec';
    document.getElementById('target-pushups').textContent = 'Target: ' + pushTarget + ' reps';
    document.getElementById('target-plank').textContent   = 'Target: ' + plankTarget + ' sec';

    /* Power phase */
    var phase = getPowerPhase();
    document.getElementById('power-phase-label').textContent = phase;
    document.getElementById('power-sprint-section').style.display = (phase === 3) ? 'block' : 'none';

    /* Clear all inputs */
    document.querySelectorAll('#logOverlay input[type=number], #logOverlay input[type=text]').forEach(function(i) { i.value = ''; });
    document.querySelectorAll('#logOverlay input[type=checkbox]').forEach(function(c) { c.checked = false; });
    document.querySelectorAll('#logOverlay select').forEach(function(s) { s.selectedIndex = 0; });

    /* Clear dynamic set rows */
    ['pullup-sets','pushup-sets','goblet-sets','squat-sets'].forEach(function(id) {
      document.getElementById(id).innerHTML = '';
    });

    /* Collapse all sections */
    document.querySelectorAll('.log-section-header.open').forEach(function(h) {
      h.classList.remove('open');
      h.nextElementSibling.classList.remove('open');
    });

    document.getElementById('logOverlay').classList.add('visible');
    document.body.style.overflow = 'hidden';
  }

  function closeLog() {
    document.getElementById('logOverlay').classList.remove('visible');
    document.body.style.overflow = '';
  }

  /* ── STAT CALCULATION ───────────────────────────────────── */
  function calcStatDeltas(data) {
    var baseline = data.baseline || {};
    var current  = data.stats   || {};

    var deltas = { endurance:0, iron:0, force:0, core:0, resolve:0, lore:0 };

    /* ── ENDURANCE ── */
    var runDist = parseFloat(document.getElementById('run-distance').value) || 0;
    var bikeDur = parseFloat(document.getElementById('bike-duration').value) || 0;
    var bikeRes = parseFloat(document.getElementById('bike-resistance').value) || 0;
    var burpees = parseFloat(document.getElementById('burpees-total').value) || 0;
    var spartanOk = document.getElementById('burpees-spartan').checked;

    var endPts = 0;
    if (runDist > 0) {
      /* Points: each km = 2 pts, capped at 20 per session */
      var distUnit = data.warrior.distance || 'km';
      var km = distUnit === 'miles' ? runDist * 1.609 : runDist;
      endPts += Math.min(km * 2, 20);
    }
    if (bikeDur > 0) endPts += Math.min(bikeDur * 0.1 * (bikeRes > 0 ? bikeRes / 10 + 1 : 1), 5);
    if (burpees > 0) endPts += Math.min(burpees * (spartanOk ? 0.1 : 0.05), 5);
    deltas.endurance = parseFloat(Math.min(endPts, 25).toFixed(1));

    /* ── IRON ── */
    var hangBest = parseFloat(document.getElementById('hang-best').value) || 0;
    var pullups  = getSetValues('pullup-sets');
    var totalPullups = pullups.reduce(function(a,b){return a+b;}, 0);

    var ironPts = 0;
    if (hangBest > 0) ironPts += Math.min(hangBest * 0.15, 8);
    if (totalPullups > 0) ironPts += Math.min(totalPullups * 0.25, 8);
    deltas.iron = parseFloat(Math.min(ironPts, 20).toFixed(1));

    /* ── FORCE ── */
    var pushups  = getSetValues('pushup-sets');
    var goblets  = getSetValues('goblet-sets');
    var squats   = getSetValues('squat-sets');
    var stepReps = parseFloat(document.getElementById('stepup-reps').value) || 0;
    var bandDone = document.getElementById('band-completed').checked;

    var totalPushups = pushups.reduce(function(a,b){return a+b;}, 0);
    var totalGoblets = goblets.reduce(function(a,b){return a+b;}, 0);
    var totalSquats  = squats.reduce(function(a,b){return a+b;}, 0);

    var forcePts = 0;
    if (totalPushups > 0) forcePts += Math.min(totalPushups * 0.12, 8);
    if (totalGoblets > 0) forcePts += Math.min(totalGoblets * 0.08, 5);
    if (totalSquats  > 0) forcePts += Math.min(totalSquats  * 0.05, 4);
    if (stepReps > 0)     forcePts += Math.min(stepReps * 0.04, 3);
    if (bandDone)         forcePts += 1;
    deltas.force = parseFloat(Math.min(forcePts, 20).toFixed(1));

    /* ── CORE ── */
    var plankBest   = parseFloat(document.getElementById('plank-best').value)    || 0;
    var hollowBest  = parseFloat(document.getElementById('hollow-best').value)   || 0;
    var deadbugReps = parseFloat(document.getElementById('deadbug-reps').value)  || 0;
    var bcSec       = parseFloat(document.getElementById('bearcrawl-sec').value) || 0;
    var bcM         = parseFloat(document.getElementById('bearcrawl-m').value)   || 0;
    var coreExtra   = document.getElementById('core-additional').checked;

    var corePts = 0;
    if (plankBest  > 0) corePts += Math.min(plankBest  * 0.1,  8);
    if (hollowBest > 0) corePts += Math.min(hollowBest * 0.08, 4);
    if (deadbugReps> 0) corePts += Math.min(deadbugReps* 0.05, 3);
    if (bcSec > 0 || bcM > 0) corePts += Math.min((bcSec + bcM * 0.5) * 0.05, 4);
    if (coreExtra)      corePts += 1;
    deltas.core = parseFloat(Math.min(corePts, 20).toFixed(1));

    /* ── RESOLVE ── */
    var prayerDone  = document.getElementById('prayer-done').checked;
    var prayerMin   = parseFloat(document.getElementById('prayer-duration').value) || 0;
    var journalDone = document.getElementById('journal-done').checked;
    var readingDone = document.getElementById('reading-done').checked;
    var readPages   = parseFloat(document.getElementById('reading-pages').value) || 0;

    var resolvePts = 0;
    if (prayerDone)  { resolvePts += (prayerMin >= 10) ? 1.5 : 1; }
    if (journalDone) { resolvePts += 1; }
    deltas.resolve = parseFloat(Math.min(resolvePts, 3).toFixed(1));

    /* ── LORE ── */
    var lorePts = 0;
    if (readingDone) { lorePts += (readPages >= 20) ? 1.5 : 1; }
    deltas.lore = parseFloat(Math.min(lorePts, 2).toFixed(1));

    /* ── POWER (split equally to Endurance + Force) ── */
    var contacts = parseFloat(document.getElementById('power-contacts').value) || 0;
    if (contacts > 0) {
      var powerBonus = Math.min(contacts * 0.05, 4);
      deltas.endurance = parseFloat((deltas.endurance + powerBonus / 2).toFixed(1));
      deltas.force     = parseFloat((deltas.force     + powerBonus / 2).toFixed(1));
    }

    return deltas;
  }

  /* ── COMMIT ─────────────────────────────────────────────── */
  function commitLog() {
    var data = loadData();
    if (!data) return;

    var sessionType = document.getElementById('sessionType').value;
    var deltas = calcStatDeltas(data);
    var prevStats = {};

    /* Apply deltas, cap at 100 */
    ['endurance','iron','force','core','resolve','lore'].forEach(function(s) {
      prevStats[s] = data.stats[s] || 0;
      data.stats[s] = parseFloat(Math.min(100, prevStats[s] + (deltas[s] || 0)).toFixed(1));
    });

    /* Mana: prayer +10, journal +5 */
    var prayerDone  = document.getElementById('prayer-done').checked;
    var journalDone = document.getElementById('journal-done').checked;
    var manaGain = (prayerDone ? 10 : 0) + (journalDone ? 5 : 0);
    data.character.mana = Math.min(data.character.maxMana, (data.character.mana || 0) + manaGain);

    /* Streaks */
    var todayStr = new Date().toISOString().slice(0,10);
    var hasPhysical = (deltas.endurance + deltas.iron + deltas.force + deltas.core) > 0;
    if (hasPhysical) {
      var last = data.streaks.lastTrainingDate;
      var yesterday = new Date(); yesterday.setDate(yesterday.getDate() - 1);
      var yStr = yesterday.toISOString().slice(0,10);
      if (last === yStr || last === todayStr) {
        if (last !== todayStr) data.streaks.training = (data.streaks.training || 0) + 1;
      } else {
        data.streaks.training = 1;
      }
      data.streaks.lastTrainingDate = todayStr;
    }

    var hasResolve = prayerDone && journalDone;
    if (hasResolve) {
      var lastR = data.streaks.lastResolveDate;
      var yesterdayR = new Date(); yesterdayR.setDate(yesterdayR.getDate() - 1);
      var yStrR = yesterdayR.toISOString().slice(0,10);
      if (lastR === yStrR || lastR === todayStr) {
        if (lastR !== todayStr) data.streaks.resolve = (data.streaks.resolve || 0) + 1;
      } else {
        data.streaks.resolve = 1;
      }
      data.streaks.lastResolveDate = todayStr;
    }

    /* Log entry */
    var logEntry = {
      date: todayStr,
      sessionType: sessionType,
      deltas: deltas,
      manaGain: manaGain
    };
    data.log.push(logEntry);

    saveData(data);

    /* Show summary */
    closeLog();
    showSummary(prevStats, data.stats, deltas, sessionType);
    populateHomeScreen(data);
  }

  /* ── SUMMARY SCREEN ─────────────────────────────────────── */
  function showSummary(prevStats, newStats, deltas, sessionType) {
    var list = document.getElementById('summary-stats-list');
    list.innerHTML = '';

    var statLabels = {
      endurance: 'Endurance', iron: 'Iron', force: 'Force',
      core: 'Core', resolve: 'Resolve', lore: 'Lore'
    };

    var anyChange = false;
    ['endurance','iron','force','core','resolve','lore'].forEach(function(s) {
      var d = deltas[s] || 0;
      if (d <= 0) return;
      anyChange = true;
      var row = document.createElement('div');
      row.className = 'summary-stat-row';
      row.innerHTML =
        '<span class="summary-stat-name">' + statLabels[s] + '</span>' +
        '<div class="summary-stat-change">' +
          '<span class="summary-old">' + prevStats[s].toFixed(1) + '</span>' +
          '<span class="summary-arrow">→</span>' +
          '<span class="summary-new">' + newStats[s].toFixed(1) + '</span>' +
          '<span class="summary-delta">+' + d.toFixed(1) + '</span>' +
        '</div>';
      list.appendChild(row);
    });

    if (!anyChange) {
      var none = document.createElement('div');
      none.style.cssText = 'text-align:center;color:var(--ironstone);font-size:0.8rem;padding:20px 0;';
      none.textContent = 'No stat fields were filled in.';
      list.appendChild(none);
    }

    document.getElementById('summary-flavour-text').textContent = randomFlavour(sessionType);
    document.getElementById('summaryOverlay').classList.add('visible');
  }

  function closeSummary() {
    document.getElementById('summaryOverlay').classList.remove('visible');
  }

  /* ── Wire "Log Training" button on home screen ──────────── */
  document.addEventListener('DOMContentLoaded', function() {
    /* The first action button is Log Training */
    var btns = document.querySelectorAll('.action-btn');
    if (btns[0]) btns[0].addEventListener('click', function() {
      var data = loadData();
      if (data && data.setupComplete) openLog();
    });
  });


</script>
</body>
</html>
